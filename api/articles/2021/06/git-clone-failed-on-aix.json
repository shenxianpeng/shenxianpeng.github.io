{"title":"解决在 AIX 上 Git Clone 失败的两个问题","slug":"2021/06/git-clone-failed-on-aix","date":"2021-06-20T14:53:26.000Z","updated":"2024-04-28T15:16:53.686Z","comments":true,"path":"api/articles/2021/06/git-clone-failed-on-aix.json","excerpt":null,"covers":null,"content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>本篇记录两个在做 Jenkins 与 AIX 做持续集成得时候遇到的 Git clone 代码失败的问题，并已解决，分享出来或许能有所帮助。</p>\n<ol>\n<li>Dependent module &#x2F;usr&#x2F;lib&#x2F;libldap.a(libldap-2.4.so.2) could not be loaded.</li>\n<li>通过 SSH 进行 git clone 出现 Authentication failed</li>\n</ol>\n<h2 id=\"问题1：Dependent-module-usr-lib-libldap-a-libldap-2-4-so-2-could-not-be-loaded\"><a href=\"#问题1：Dependent-module-usr-lib-libldap-a-libldap-2-4-so-2-could-not-be-loaded\" class=\"headerlink\" title=\"问题1：Dependent module &#x2F;usr&#x2F;lib&#x2F;libldap.a(libldap-2.4.so.2) could not be loaded\"></a>问题1：Dependent module &#x2F;usr&#x2F;lib&#x2F;libldap.a(libldap-2.4.so.2) could not be loaded</h2><p>Jenkins 通过 <strong>HTTPS</strong> 来 checkout 代码的时候，出现了如下错误：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[2021-06-20T14:50:25.166Z] ERROR: Error cloning remote repo <span class=\"string\">&#x27;origin&#x27;</span></span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] hudson.plugins.git.GitException: Command <span class=\"string\">&quot;git fetch --tags --force --progress --depth=1 -- https://git.company.com/scm/vas/db.git +refs/heads/*:refs/remotes/origin/*&quot;</span> returned status code 128:</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] stdout:</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] stderr: <span class=\"built_in\">exec</span>(): 0509-036 Cannot load program /opt/freeware/libexec64/git-core/git-remote-https because of the following errors:</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \t0509-150   Dependent module /usr/lib/libldap.a(libldap-2.4.so.2) could not be loaded.</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \t0509-153   File /usr/lib/libldap.a is not an archive or</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \t\t   the file could not be <span class=\"built_in\">read</span> properly.</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \t0509-026 System error: Cannot run a file that does not have a valid format.</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z]</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \tat org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandIn(CliGitAPIImpl.java:2450)</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \tat org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandWithCredentials(CliGitAPIImpl.java:2051)</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \tat org.jenkinsci.plugins.gitclient.CliGitAPIImpl.access<span class=\"variable\">$500</span>(CliGitAPIImpl.java:84)</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \tat org.jenkinsci.plugins.gitclient.CliGitAPIImpl<span class=\"variable\">$1</span>.execute(CliGitAPIImpl.java:573)</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \tat org.jenkinsci.plugins.gitclient.CliGitAPIImpl<span class=\"variable\">$2</span>.execute(CliGitAPIImpl.java:802)</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \tat org.jenkinsci.plugins.gitclient.RemoteGitImpl$CommandInvocationHandler<span class=\"variable\">$GitCommandMasterToSlaveCallable</span>.call(RemoteGitImpl.java:161)</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \tat org.jenkinsci.plugins.gitclient.RemoteGitImpl$CommandInvocationHandler<span class=\"variable\">$GitCommandMasterToSlaveCallable</span>.call(RemoteGitImpl.java:154)</span><br><span class=\"line\">..........................</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \tSuppressed: hudson.remoting.Channel<span class=\"variable\">$CallSiteStackTrace</span>: Remote call to aix-devasbld-01</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \t\tat hudson.remoting.Channel.attachCallSiteStackTrace(Channel.java:1800)</span><br><span class=\"line\">..........................</span><br><span class=\"line\">[2021-06-20T14:50:25.168Z] \t\tat java.lang.Thread.run(Thread.java:748)</span><br><span class=\"line\">[2021-06-20T15:21:20.525Z] Cloning repository https://git.company.com/scm/vas/db.git</span><br></pre></td></tr></table></figure>\n\n<p>但是直接在虚拟机上通过命令 <code>git clone https://git.company.com/scm/vas/db.git</code> ，可以成功下载，没有出现任何问题。</p>\n<ul>\n<li>如果将 <code>LIBPATH</code> 设置为 <code>LIBPATH=/usr/lib</code> 就能重现上面的错误，这说明通过 Jenkins 下载代码的时候它是去 <code>/usr/lib/</code> 下面找 <code>libldap.a</code></li>\n<li>如果将变量 <code>LIBPATH</code> 设置为空 <code>export LIBPATH=</code> 或 <code>unset LIBPATH</code>，执行 <code>git clone https://...</code> 就正常了。</li>\n</ul>\n<blockquote>\n<p>尝试在 Jenkins 启动 agent 的时候修改 <code>LIBPATH</code> 变量设置为空，但都不能解决这个问题，不明白为什么不行！？</p>\n</blockquote>\n<p>那就看看 <code>/usr/lib/libldap.a</code> 是什么问题了。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ldd 的时候发现这个静态库有问题</span></span><br><span class=\"line\">$ ldd /usr/lib/libldap.a</span><br><span class=\"line\">/usr/lib/libldap.a needs:</span><br><span class=\"line\">         /opt/IBM/ldap/V6.4/lib/libibmldapdbg.a</span><br><span class=\"line\">         /usr/lib/threads/libc.a(shr.o)</span><br><span class=\"line\">Cannot find libpthreads.a(shr_xpg5.o)</span><br><span class=\"line\">         /opt/IBM/ldap/V6.4/lib/libidsldapiconv.a</span><br><span class=\"line\">Cannot find libpthreads.a(shr_xpg5.o)</span><br><span class=\"line\">Cannot find libc_r.a(shr.o)</span><br><span class=\"line\">         /unix</span><br><span class=\"line\">         /usr/lib/libcrypt.a(shr.o)</span><br><span class=\"line\">Cannot find libpthreads.a(shr_xpg5.o)</span><br><span class=\"line\">Cannot find libc_r.a(shr.o)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以看到它链接到是 IBM LDAP</span></span><br><span class=\"line\">$ <span class=\"built_in\">ls</span> -l /usr/lib/libldap.a</span><br><span class=\"line\">lrwxrwxrwx    1 root     system           35 Jun 10 2020  /usr/lib/libldap.a -&gt; /opt/IBM/ldap/V6.4/lib/libidsldap.a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 再看看同样的 libldap.a 在 /opt/freeware/lib/ 是没问题的</span></span><br><span class=\"line\">$ ldd /opt/freeware/lib/libldap.a</span><br><span class=\"line\">ldd: /opt/freeware/lib/libldap.a: File is an archive.</span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">ls</span> -l /opt/freeware/lib/libldap.a</span><br><span class=\"line\">lrwxrwxrwx    1 root     system           13 May 27 2020  /opt/freeware/lib/libldap.a -&gt; libldap-2.4.a</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"问题1：解决办法\"><a href=\"#问题1：解决办法\" class=\"headerlink\" title=\"问题1：解决办法\"></a>问题1：解决办法</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 尝试替换</span></span><br><span class=\"line\"><span class=\"comment\"># 先将 libldap.a 重名为 libldap.a.old（不删除以防需要恢复）</span></span><br><span class=\"line\">$ sudo <span class=\"built_in\">mv</span> /usr/lib/libldap.a /usr/lib/libldap.a.old</span><br><span class=\"line\"><span class=\"comment\"># 重新链接</span></span><br><span class=\"line\">$ sudo <span class=\"built_in\">ln</span> -s /opt/freeware/lib/libldap.a /usr/lib/libldap.a</span><br><span class=\"line\">$ <span class=\"built_in\">ls</span> -l /usr/lib/libldap.a</span><br><span class=\"line\">lrwxrwxrwx    1 root     system           27 Oct 31 23:27 /usr/lib/libldap.a -&gt; /opt/freeware/lib/libldap.a</span><br></pre></td></tr></table></figure>\n\n<p>重新链接完成后，重新连接 AIX agent，再次执行 Jenkins job 来 clone 代码，成功了！</p>\n<h2 id=\"问题2：通过-SSH-进行-git-clone-出现-Authentication-failed\"><a href=\"#问题2：通过-SSH-进行-git-clone-出现-Authentication-failed\" class=\"headerlink\" title=\"问题2：通过 SSH 进行 git clone 出现 Authentication failed\"></a>问题2：通过 SSH 进行 git clone 出现 Authentication failed</h2><p>由于 AIX 7.1-TL4-SP1 即将 End of Service Pack Support，因此需要升级。但是升级到 AIX 7.1-TL5-SP6 后无法通过 SSH 下载代码。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ git <span class=\"built_in\">clone</span> ssh://git@git.company.com:7999/vas/db.git</span><br><span class=\"line\">Cloning into <span class=\"string\">&#x27;db&#x27;</span>...</span><br><span class=\"line\">Authentication failed.</span><br><span class=\"line\">fatal: Could not <span class=\"built_in\">read</span> from remote repository.</span><br><span class=\"line\"></span><br><span class=\"line\">Please make sure you have the correct access rights</span><br><span class=\"line\">and the repository exists.</span><br></pre></td></tr></table></figure>\n\n<p>像这样的错误，在使用 Git SSH 方式来 clone 代码经常会遇到，通常都是没有设置 public key。只要执行 <code>ssh-keygen -t rsa -C your@email.com</code> 生成 <code>id_rsa</code> keys，然后将 <code>id_rsa.pub</code> 的值添加到 GitHub&#x2F;Bitbucket&#x2F;GitLab 的 public key 中一般就能解决。</p>\n<p>但这次不一样，尽管已经设置了 public key，但错误依旧存在。奇快的是之前 AIX 7.1-TL4-SP1 是好用的，升级到 AIX 7.1-TL5-SP6 就不好用了呢？</p>\n<p>使用命令 <code>ssh -vvv &lt;git-url&gt;</code> 来看看他们在请求 git 服务器时候 debug 信息。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># AIX 7.1-TL4-SP1</span></span><br><span class=\"line\">bash-4.3$ oslevel -s</span><br><span class=\"line\">7100-04-01-1543</span><br><span class=\"line\">bash-4.3$ ssh -vvv git.company.com</span><br><span class=\"line\">OpenSSH_6.0p1, OpenSSL 1.0.1e 11 Feb 2013</span><br><span class=\"line\">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class=\"line\">debug1: Failed dlopen: /usr/krb5/lib/libkrb5.a(libkrb5.a.so):   0509-022 Cannot load module /usr/krb5/lib/libkrb5.a(libkrb5.a.so).</span><br><span class=\"line\">        0509-026 System error: A file or directory <span class=\"keyword\">in</span> the path name does not exist.</span><br><span class=\"line\"></span><br><span class=\"line\">debug1: Error loading Kerberos, disabling Kerberos auth.</span><br><span class=\"line\">.......</span><br><span class=\"line\">.......</span><br><span class=\"line\">ssh_exchange_identification: <span class=\"built_in\">read</span>: Connection reset by peer</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># New machine AIX 7.1-TL5-SP6</span></span><br><span class=\"line\">$ oslevel -s</span><br><span class=\"line\">7100-05-06-2015</span><br><span class=\"line\">$ ssh -vvv git.company.com</span><br><span class=\"line\">OpenSSH_7.5p1, OpenSSL 1.0.2t  10 Sep 2019</span><br><span class=\"line\">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class=\"line\">debug1: Failed dlopen: /usr/krb5/lib/libkrb5.a(libkrb5.a.so):   0509-022 Cannot load module /usr/krb5/lib/libkrb5.a(libkrb5.a.so).</span><br><span class=\"line\">        0509-026 System error: A file or directory <span class=\"keyword\">in</span> the path name does not exist.</span><br><span class=\"line\"></span><br><span class=\"line\">debug1: Error loading Kerberos, disabling Kerberos auth.</span><br><span class=\"line\">.......</span><br><span class=\"line\">.......</span><br><span class=\"line\">ssh_exchange_identification: <span class=\"built_in\">read</span>: Connection reset by peer</span><br></pre></td></tr></table></figure>\n\n<p>可以看到的差别是 OpenSSH 的版本不同，可能是因此导致的，根据这个推测很快就找到了类似的问题和答案（Stackoverflow <a href=\"https://stackoverflow.com/questions/54191112/bitbucket-ssh-clone-on-aix-7-1-fails\">链接</a>)</p>\n<h2 id=\"问题2：解决办法\"><a href=\"#问题2：解决办法\" class=\"headerlink\" title=\"问题2：解决办法\"></a>问题2：解决办法</h2><p>在 <code>~/.ssh/config</code> 文件里添加选项 <code>AllowPKCS12keystoreAutoOpen no</code></p>\n<p>但问题又来了，这个选项是 AIX 上的一个定制选项，在 Linux 上是没有的。</p>\n<p>这会导致同一个域账户在 AIX 通过 SSH 可以 git clone 成功，但在 Linux 上 git clone 会失败。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Linux 上不识别改选项</span></span><br><span class=\"line\">stderr: /home/****/.ssh/config: line 1: Bad configuration option: allowpkcs12keystoreautoopen</span><br><span class=\"line\">/home/****/.ssh/config: terminating, 1 bad configuration options</span><br><span class=\"line\">fatal: Could not <span class=\"built_in\">read</span> from remote repository.</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li>如果 <code>config</code> 文件可以支持条件选项就好了，即当为 AIX 是添加选项 <code>AllowPKCS12keystoreAutoOpen no</code>，其他系统则没有该选项。可惜 <code>config</code> 并不支持。</li>\n<li>如果能单独的设置当前 AIX 的 ssh config 文件就好了。尝试将 <code>/etc/ssh/ssh_config</code> 文件修改如下，重启服务，再次通过 SSH clone，成功~！</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Host *</span><br><span class=\"line\">  AllowPKCS12keystoreAutoOpen no</span><br><span class=\"line\"><span class=\"comment\">#   ForwardAgent no</span></span><br><span class=\"line\"><span class=\"comment\">#   ForwardX11 no</span></span><br><span class=\"line\"><span class=\"comment\">#   RhostsRSAAuthentication no</span></span><br><span class=\"line\"><span class=\"comment\">#   RSAAuthentication yes</span></span><br><span class=\"line\"><span class=\"comment\">#   PasswordAuthentication yes</span></span><br><span class=\"line\"><span class=\"comment\">#   HostbasedAuthentication no</span></span><br><span class=\"line\"><span class=\"comment\">#   GSSAPIAuthentication no</span></span><br><span class=\"line\"><span class=\"comment\">#   GSSAPIDelegateCredentials no</span></span><br><span class=\"line\"><span class=\"comment\">#   GSSAPIKeyExchange no</span></span><br><span class=\"line\"><span class=\"comment\">#   GSSAPITrustDNS no</span></span><br><span class=\"line\"><span class=\"comment\">#   ....省略</span></span><br></pre></td></tr></table></figure>\n","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>本篇记录两个在做 Jenkins 与 AIX 做持续集成得时候遇到的 Git clone 代码失败的问题，并已解决，分享出来或许能有所帮助。</p>\n<ol>\n<li>Dependent module &#x2F;usr&#x2F;lib&#x2F;libldap.a(libldap-2.4.so.2) could not be loaded.</li>\n<li>通过 SSH 进行 git clone 出现 Authentication failed</li>\n</ol>\n<h2 id=\"问题1：Dependent-module-usr-lib-libldap-a-libldap-2-4-so-2-could-not-be-loaded\"><a href=\"#问题1：Dependent-module-usr-lib-libldap-a-libldap-2-4-so-2-could-not-be-loaded\" class=\"headerlink\" title=\"问题1：Dependent module &#x2F;usr&#x2F;lib&#x2F;libldap.a(libldap-2.4.so.2) could not be loaded\"></a>问题1：Dependent module &#x2F;usr&#x2F;lib&#x2F;libldap.a(libldap-2.4.so.2) could not be loaded</h2><p>Jenkins 通过 <strong>HTTPS</strong> 来 checkout 代码的时候，出现了如下错误：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[2021-06-20T14:50:25.166Z] ERROR: Error cloning remote repo <span class=\"string\">&#x27;origin&#x27;</span></span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] hudson.plugins.git.GitException: Command <span class=\"string\">&quot;git fetch --tags --force --progress --depth=1 -- https://git.company.com/scm/vas/db.git +refs/heads/*:refs/remotes/origin/*&quot;</span> returned status code 128:</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] stdout:</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] stderr: <span class=\"built_in\">exec</span>(): 0509-036 Cannot load program /opt/freeware/libexec64/git-core/git-remote-https because of the following errors:</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \t0509-150   Dependent module /usr/lib/libldap.a(libldap-2.4.so.2) could not be loaded.</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \t0509-153   File /usr/lib/libldap.a is not an archive or</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \t\t   the file could not be <span class=\"built_in\">read</span> properly.</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \t0509-026 System error: Cannot run a file that does not have a valid format.</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z]</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \tat org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandIn(CliGitAPIImpl.java:2450)</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \tat org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandWithCredentials(CliGitAPIImpl.java:2051)</span><br><span class=\"line\">[2021-06-20T14:50:25.166Z] \tat org.jenkinsci.plugins.gitclient.CliGitAPIImpl.access<span class=\"variable\">$500</span>(CliGitAPIImpl.java:84)</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \tat org.jenkinsci.plugins.gitclient.CliGitAPIImpl<span class=\"variable\">$1</span>.execute(CliGitAPIImpl.java:573)</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \tat org.jenkinsci.plugins.gitclient.CliGitAPIImpl<span class=\"variable\">$2</span>.execute(CliGitAPIImpl.java:802)</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \tat org.jenkinsci.plugins.gitclient.RemoteGitImpl$CommandInvocationHandler<span class=\"variable\">$GitCommandMasterToSlaveCallable</span>.call(RemoteGitImpl.java:161)</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \tat org.jenkinsci.plugins.gitclient.RemoteGitImpl$CommandInvocationHandler<span class=\"variable\">$GitCommandMasterToSlaveCallable</span>.call(RemoteGitImpl.java:154)</span><br><span class=\"line\">..........................</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \tSuppressed: hudson.remoting.Channel<span class=\"variable\">$CallSiteStackTrace</span>: Remote call to aix-devasbld-01</span><br><span class=\"line\">[2021-06-20T14:50:25.167Z] \t\tat hudson.remoting.Channel.attachCallSiteStackTrace(Channel.java:1800)</span><br><span class=\"line\">..........................</span><br><span class=\"line\">[2021-06-20T14:50:25.168Z] \t\tat java.lang.Thread.run(Thread.java:748)</span><br><span class=\"line\">[2021-06-20T15:21:20.525Z] Cloning repository https://git.company.com/scm/vas/db.git</span><br></pre></td></tr></table></figure>\n\n<p>但是直接在虚拟机上通过命令 <code>git clone https://git.company.com/scm/vas/db.git</code> ，可以成功下载，没有出现任何问题。</p>\n<ul>\n<li>如果将 <code>LIBPATH</code> 设置为 <code>LIBPATH=/usr/lib</code> 就能重现上面的错误，这说明通过 Jenkins 下载代码的时候它是去 <code>/usr/lib/</code> 下面找 <code>libldap.a</code></li>\n<li>如果将变量 <code>LIBPATH</code> 设置为空 <code>export LIBPATH=</code> 或 <code>unset LIBPATH</code>，执行 <code>git clone https://...</code> 就正常了。</li>\n</ul>\n<blockquote>\n<p>尝试在 Jenkins 启动 agent 的时候修改 <code>LIBPATH</code> 变量设置为空，但都不能解决这个问题，不明白为什么不行！？</p>\n</blockquote>\n<p>那就看看 <code>/usr/lib/libldap.a</code> 是什么问题了。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ldd 的时候发现这个静态库有问题</span></span><br><span class=\"line\">$ ldd /usr/lib/libldap.a</span><br><span class=\"line\">/usr/lib/libldap.a needs:</span><br><span class=\"line\">         /opt/IBM/ldap/V6.4/lib/libibmldapdbg.a</span><br><span class=\"line\">         /usr/lib/threads/libc.a(shr.o)</span><br><span class=\"line\">Cannot find libpthreads.a(shr_xpg5.o)</span><br><span class=\"line\">         /opt/IBM/ldap/V6.4/lib/libidsldapiconv.a</span><br><span class=\"line\">Cannot find libpthreads.a(shr_xpg5.o)</span><br><span class=\"line\">Cannot find libc_r.a(shr.o)</span><br><span class=\"line\">         /unix</span><br><span class=\"line\">         /usr/lib/libcrypt.a(shr.o)</span><br><span class=\"line\">Cannot find libpthreads.a(shr_xpg5.o)</span><br><span class=\"line\">Cannot find libc_r.a(shr.o)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 可以看到它链接到是 IBM LDAP</span></span><br><span class=\"line\">$ <span class=\"built_in\">ls</span> -l /usr/lib/libldap.a</span><br><span class=\"line\">lrwxrwxrwx    1 root     system           35 Jun 10 2020  /usr/lib/libldap.a -&gt; /opt/IBM/ldap/V6.4/lib/libidsldap.a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 再看看同样的 libldap.a 在 /opt/freeware/lib/ 是没问题的</span></span><br><span class=\"line\">$ ldd /opt/freeware/lib/libldap.a</span><br><span class=\"line\">ldd: /opt/freeware/lib/libldap.a: File is an archive.</span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">ls</span> -l /opt/freeware/lib/libldap.a</span><br><span class=\"line\">lrwxrwxrwx    1 root     system           13 May 27 2020  /opt/freeware/lib/libldap.a -&gt; libldap-2.4.a</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"问题1：解决办法\"><a href=\"#问题1：解决办法\" class=\"headerlink\" title=\"问题1：解决办法\"></a>问题1：解决办法</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 尝试替换</span></span><br><span class=\"line\"><span class=\"comment\"># 先将 libldap.a 重名为 libldap.a.old（不删除以防需要恢复）</span></span><br><span class=\"line\">$ sudo <span class=\"built_in\">mv</span> /usr/lib/libldap.a /usr/lib/libldap.a.old</span><br><span class=\"line\"><span class=\"comment\"># 重新链接</span></span><br><span class=\"line\">$ sudo <span class=\"built_in\">ln</span> -s /opt/freeware/lib/libldap.a /usr/lib/libldap.a</span><br><span class=\"line\">$ <span class=\"built_in\">ls</span> -l /usr/lib/libldap.a</span><br><span class=\"line\">lrwxrwxrwx    1 root     system           27 Oct 31 23:27 /usr/lib/libldap.a -&gt; /opt/freeware/lib/libldap.a</span><br></pre></td></tr></table></figure>\n\n<p>重新链接完成后，重新连接 AIX agent，再次执行 Jenkins job 来 clone 代码，成功了！</p>\n<h2 id=\"问题2：通过-SSH-进行-git-clone-出现-Authentication-failed\"><a href=\"#问题2：通过-SSH-进行-git-clone-出现-Authentication-failed\" class=\"headerlink\" title=\"问题2：通过 SSH 进行 git clone 出现 Authentication failed\"></a>问题2：通过 SSH 进行 git clone 出现 Authentication failed</h2><p>由于 AIX 7.1-TL4-SP1 即将 End of Service Pack Support，因此需要升级。但是升级到 AIX 7.1-TL5-SP6 后无法通过 SSH 下载代码。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ git <span class=\"built_in\">clone</span> ssh://git@git.company.com:7999/vas/db.git</span><br><span class=\"line\">Cloning into <span class=\"string\">&#x27;db&#x27;</span>...</span><br><span class=\"line\">Authentication failed.</span><br><span class=\"line\">fatal: Could not <span class=\"built_in\">read</span> from remote repository.</span><br><span class=\"line\"></span><br><span class=\"line\">Please make sure you have the correct access rights</span><br><span class=\"line\">and the repository exists.</span><br></pre></td></tr></table></figure>\n\n<p>像这样的错误，在使用 Git SSH 方式来 clone 代码经常会遇到，通常都是没有设置 public key。只要执行 <code>ssh-keygen -t rsa -C your@email.com</code> 生成 <code>id_rsa</code> keys，然后将 <code>id_rsa.pub</code> 的值添加到 GitHub&#x2F;Bitbucket&#x2F;GitLab 的 public key 中一般就能解决。</p>\n<p>但这次不一样，尽管已经设置了 public key，但错误依旧存在。奇快的是之前 AIX 7.1-TL4-SP1 是好用的，升级到 AIX 7.1-TL5-SP6 就不好用了呢？</p>\n<p>使用命令 <code>ssh -vvv &lt;git-url&gt;</code> 来看看他们在请求 git 服务器时候 debug 信息。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># AIX 7.1-TL4-SP1</span></span><br><span class=\"line\">bash-4.3$ oslevel -s</span><br><span class=\"line\">7100-04-01-1543</span><br><span class=\"line\">bash-4.3$ ssh -vvv git.company.com</span><br><span class=\"line\">OpenSSH_6.0p1, OpenSSL 1.0.1e 11 Feb 2013</span><br><span class=\"line\">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class=\"line\">debug1: Failed dlopen: /usr/krb5/lib/libkrb5.a(libkrb5.a.so):   0509-022 Cannot load module /usr/krb5/lib/libkrb5.a(libkrb5.a.so).</span><br><span class=\"line\">        0509-026 System error: A file or directory <span class=\"keyword\">in</span> the path name does not exist.</span><br><span class=\"line\"></span><br><span class=\"line\">debug1: Error loading Kerberos, disabling Kerberos auth.</span><br><span class=\"line\">.......</span><br><span class=\"line\">.......</span><br><span class=\"line\">ssh_exchange_identification: <span class=\"built_in\">read</span>: Connection reset by peer</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># New machine AIX 7.1-TL5-SP6</span></span><br><span class=\"line\">$ oslevel -s</span><br><span class=\"line\">7100-05-06-2015</span><br><span class=\"line\">$ ssh -vvv git.company.com</span><br><span class=\"line\">OpenSSH_7.5p1, OpenSSL 1.0.2t  10 Sep 2019</span><br><span class=\"line\">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class=\"line\">debug1: Failed dlopen: /usr/krb5/lib/libkrb5.a(libkrb5.a.so):   0509-022 Cannot load module /usr/krb5/lib/libkrb5.a(libkrb5.a.so).</span><br><span class=\"line\">        0509-026 System error: A file or directory <span class=\"keyword\">in</span> the path name does not exist.</span><br><span class=\"line\"></span><br><span class=\"line\">debug1: Error loading Kerberos, disabling Kerberos auth.</span><br><span class=\"line\">.......</span><br><span class=\"line\">.......</span><br><span class=\"line\">ssh_exchange_identification: <span class=\"built_in\">read</span>: Connection reset by peer</span><br></pre></td></tr></table></figure>\n\n<p>可以看到的差别是 OpenSSH 的版本不同，可能是因此导致的，根据这个推测很快就找到了类似的问题和答案（Stackoverflow <a href=\"https://stackoverflow.com/questions/54191112/bitbucket-ssh-clone-on-aix-7-1-fails\">链接</a>)</p>\n<h2 id=\"问题2：解决办法\"><a href=\"#问题2：解决办法\" class=\"headerlink\" title=\"问题2：解决办法\"></a>问题2：解决办法</h2><p>在 <code>~/.ssh/config</code> 文件里添加选项 <code>AllowPKCS12keystoreAutoOpen no</code></p>\n<p>但问题又来了，这个选项是 AIX 上的一个定制选项，在 Linux 上是没有的。</p>\n<p>这会导致同一个域账户在 AIX 通过 SSH 可以 git clone 成功，但在 Linux 上 git clone 会失败。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Linux 上不识别改选项</span></span><br><span class=\"line\">stderr: /home/****/.ssh/config: line 1: Bad configuration option: allowpkcs12keystoreautoopen</span><br><span class=\"line\">/home/****/.ssh/config: terminating, 1 bad configuration options</span><br><span class=\"line\">fatal: Could not <span class=\"built_in\">read</span> from remote repository.</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li>如果 <code>config</code> 文件可以支持条件选项就好了，即当为 AIX 是添加选项 <code>AllowPKCS12keystoreAutoOpen no</code>，其他系统则没有该选项。可惜 <code>config</code> 并不支持。</li>\n<li>如果能单独的设置当前 AIX 的 ssh config 文件就好了。尝试将 <code>/etc/ssh/ssh_config</code> 文件修改如下，重启服务，再次通过 SSH clone，成功~！</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Host *</span><br><span class=\"line\">  AllowPKCS12keystoreAutoOpen no</span><br><span class=\"line\"><span class=\"comment\">#   ForwardAgent no</span></span><br><span class=\"line\"><span class=\"comment\">#   ForwardX11 no</span></span><br><span class=\"line\"><span class=\"comment\">#   RhostsRSAAuthentication no</span></span><br><span class=\"line\"><span class=\"comment\">#   RSAAuthentication yes</span></span><br><span class=\"line\"><span class=\"comment\">#   PasswordAuthentication yes</span></span><br><span class=\"line\"><span class=\"comment\">#   HostbasedAuthentication no</span></span><br><span class=\"line\"><span class=\"comment\">#   GSSAPIAuthentication no</span></span><br><span class=\"line\"><span class=\"comment\">#   GSSAPIDelegateCredentials no</span></span><br><span class=\"line\"><span class=\"comment\">#   GSSAPIKeyExchange no</span></span><br><span class=\"line\"><span class=\"comment\">#   GSSAPITrustDNS no</span></span><br><span class=\"line\"><span class=\"comment\">#   ....省略</span></span><br></pre></td></tr></table></figure>\n","categories":[{"name":"AIX","path":"api/categories/AIX.json"}],"tags":[{"name":"Git","path":"api/tags/Git.json"},{"name":"Jenkins","path":"api/tags/Jenkins.json"},{"name":"AIX","path":"api/tags/AIX.json"}]}