{"title":"Jenkins upgrade issue \"Windows agents won't start\" workaround","slug":"2021/02/jenkins-windows-agent-cannot-start","date":"2021-02-11T08:09:06.000Z","updated":"2023-05-06T08:50:57.623Z","comments":true,"path":"api/articles/2021/02/jenkins-windows-agent-cannot-start.json","excerpt":null,"covers":null,"content":"<p>Today, when I tried to upgrade my team’s Jenkins server from Jenkins 2.235.1 to Jenkins 2.263.3, I met a problem that can not launch the Windows agent.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[2021-01-29 23:50:40] [windows-agents] Connecting to xxx.xxx.xxx.xxx</span><br><span class=\"line\">Checking if Java exists</span><br><span class=\"line\">java -version returned 11.0.2.</span><br><span class=\"line\">[2021-01-29 23:50:40] [windows-agents] Installing the Jenkins agent service</span><br><span class=\"line\">[2021-01-29 23:50:40] [windows-agents] Copying jenkins-agent.exe</span><br><span class=\"line\">ERROR: Unexpected error in launching an agent. This is probably a bug in Jenkins</span><br><span class=\"line\">Also: java.lang.Throwable: launched here</span><br><span class=\"line\">at hudson.slaves.SlaveComputer._connect(SlaveComputer.java:286)</span><br><span class=\"line\">at hudson.model.Computer.connect(Computer.java:435)</span><br><span class=\"line\">at hudson.slaves.SlaveComputer.doLaunchSlaveAgent(SlaveComputer.java:790)</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">at java.lang.Thread.run(Thread.java:748)</span><br><span class=\"line\">java.lang.NullPointerException</span><br><span class=\"line\">at hudson.os.windows.ManagedWindowsServiceLauncher.launch(ManagedWindowsServiceLauncher.java:298)</span><br></pre></td></tr></table></figure>\n\n<p>This issue had been raised in the Jenkins Jira project: <a href=\"https://issues.jenkins.io/browse/JENKINS-63198\">JENKINS-63198</a> and <a href=\"https://issues.jenkins.io/browse/JENKINS-63198\">JENKINS-63198</a></p>\n<p>There is also a Windows Support Updates guide <a href=\"https://www.jenkins.io/blog/2020/07/23/windows-support-updates/\">here</a> that mentioned this problem.</p>\n<p>Finally, I fixed this problem by the following steps:</p>\n<ol>\n<li>Update <a href=\"https://github.com/jenkinsci/windows-slaves-plugin\">windows-slaves-plugin</a> to the lastest version 1.7 (fixes for Jenkins 2.248+)</li>\n</ol>\n<p>Then the error should be like this</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[2021-01-30 23:53:40] [windows-agents] Connecting to xxx.xxx.xxx.xxx</span><br><span class=\"line\">Checking if Java exists</span><br><span class=\"line\">java -version returned 11.0.2.</span><br><span class=\"line\">[2021-01-30 23:53:47] [windows-agents] Copying jenkins-agent.xml</span><br><span class=\"line\">[2021-01-30 23:53:48] [windows-agents] Copying agent.jar</span><br><span class=\"line\">[2021-01-30 23:53:48] [windows-agents] Starting the service</span><br><span class=\"line\">ERROR: Unexpected error in launching an agent. This is probably a bug in Jenkins</span><br><span class=\"line\">org.jinterop.dcom.common.JIException: Unknown Failure</span><br><span class=\"line\">\tat org.jvnet.hudson.wmi.Win32Service$Implementation.start(Win32Service.java:149)</span><br><span class=\"line\">Caused: java.lang.reflect.InvocationTargetException</span><br><span class=\"line\">\tat sun.reflect.GeneratedMethodAccessor219.invoke(Unknown Source)</span><br><span class=\"line\">\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class=\"line\">\tat java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class=\"line\">\tat org.kohsuke.jinterop.JInteropInvocationHandler.invoke(JInteropInvocationHandler.java:140)</span><br><span class=\"line\">Also:   java.lang.Throwable: launched here</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>Then change <code>jenkins-agent.exe.config</code> file. remove or comment out this line <code>&lt;supportedRuntime version=&quot;v2.0.50727&quot; /&gt;</code> as below</li>\n</ol>\n<blockquote>\n<p>also do this for <code>jenkins-slave.exe.config</code> in case it also exists.</p>\n</blockquote>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">runtime</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- see http://support.microsoft.com/kb/936707 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">generatePublisherEvidence</span> <span class=\"attr\">enabled</span>=<span class=\"string\">&quot;false&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">runtime</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">startup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- this can be hosted either on .NET 2.0 or 4.0 --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- &lt;supportedRuntime version=&quot;v2.0.50727&quot; /&gt; --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">supportedRuntime</span> <span class=\"attr\">version</span>=<span class=\"string\">&quot;v4.0&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">startup</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li>Then try to Launch agent.</li>\n</ol>\n<p>If it still does not work and has this error message “.NET Framework 2.0 or later is required on this computer to run a Jenkins agent as a Windows service”, you need to upgrade your .NET Framework.</p>\n<blockquote>\n<p>Here is a <a href=\"https://shenxianpeng.github.io/2020/07/jenkins-windows-agent-connect-problem/\">link</a> for update .NET Framework.</p>\n</blockquote>\n<p>Hopefully, this could help you to fix connect the issue of the Windows agent. Let me know in case of any questions.</p>\n","more":"<p>Today, when I tried to upgrade my team’s Jenkins server from Jenkins 2.235.1 to Jenkins 2.263.3, I met a problem that can not launch the Windows agent.</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[2021-01-29 23:50:40] [windows-agents] Connecting to xxx.xxx.xxx.xxx</span><br><span class=\"line\">Checking if Java exists</span><br><span class=\"line\">java -version returned 11.0.2.</span><br><span class=\"line\">[2021-01-29 23:50:40] [windows-agents] Installing the Jenkins agent service</span><br><span class=\"line\">[2021-01-29 23:50:40] [windows-agents] Copying jenkins-agent.exe</span><br><span class=\"line\">ERROR: Unexpected error in launching an agent. This is probably a bug in Jenkins</span><br><span class=\"line\">Also: java.lang.Throwable: launched here</span><br><span class=\"line\">at hudson.slaves.SlaveComputer._connect(SlaveComputer.java:286)</span><br><span class=\"line\">at hudson.model.Computer.connect(Computer.java:435)</span><br><span class=\"line\">at hudson.slaves.SlaveComputer.doLaunchSlaveAgent(SlaveComputer.java:790)</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">at java.lang.Thread.run(Thread.java:748)</span><br><span class=\"line\">java.lang.NullPointerException</span><br><span class=\"line\">at hudson.os.windows.ManagedWindowsServiceLauncher.launch(ManagedWindowsServiceLauncher.java:298)</span><br></pre></td></tr></table></figure>\n\n<p>This issue had been raised in the Jenkins Jira project: <a href=\"https://issues.jenkins.io/browse/JENKINS-63198\">JENKINS-63198</a> and <a href=\"https://issues.jenkins.io/browse/JENKINS-63198\">JENKINS-63198</a></p>\n<p>There is also a Windows Support Updates guide <a href=\"https://www.jenkins.io/blog/2020/07/23/windows-support-updates/\">here</a> that mentioned this problem.</p>\n<p>Finally, I fixed this problem by the following steps:</p>\n<ol>\n<li>Update <a href=\"https://github.com/jenkinsci/windows-slaves-plugin\">windows-slaves-plugin</a> to the lastest version 1.7 (fixes for Jenkins 2.248+)</li>\n</ol>\n<p>Then the error should be like this</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[2021-01-30 23:53:40] [windows-agents] Connecting to xxx.xxx.xxx.xxx</span><br><span class=\"line\">Checking if Java exists</span><br><span class=\"line\">java -version returned 11.0.2.</span><br><span class=\"line\">[2021-01-30 23:53:47] [windows-agents] Copying jenkins-agent.xml</span><br><span class=\"line\">[2021-01-30 23:53:48] [windows-agents] Copying agent.jar</span><br><span class=\"line\">[2021-01-30 23:53:48] [windows-agents] Starting the service</span><br><span class=\"line\">ERROR: Unexpected error in launching an agent. This is probably a bug in Jenkins</span><br><span class=\"line\">org.jinterop.dcom.common.JIException: Unknown Failure</span><br><span class=\"line\">\tat org.jvnet.hudson.wmi.Win32Service$Implementation.start(Win32Service.java:149)</span><br><span class=\"line\">Caused: java.lang.reflect.InvocationTargetException</span><br><span class=\"line\">\tat sun.reflect.GeneratedMethodAccessor219.invoke(Unknown Source)</span><br><span class=\"line\">\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class=\"line\">\tat java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class=\"line\">\tat org.kohsuke.jinterop.JInteropInvocationHandler.invoke(JInteropInvocationHandler.java:140)</span><br><span class=\"line\">Also:   java.lang.Throwable: launched here</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>Then change <code>jenkins-agent.exe.config</code> file. remove or comment out this line <code>&lt;supportedRuntime version=&quot;v2.0.50727&quot; /&gt;</code> as below</li>\n</ol>\n<blockquote>\n<p>also do this for <code>jenkins-slave.exe.config</code> in case it also exists.</p>\n</blockquote>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">runtime</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- see http://support.microsoft.com/kb/936707 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">generatePublisherEvidence</span> <span class=\"attr\">enabled</span>=<span class=\"string\">&quot;false&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">runtime</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">startup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- this can be hosted either on .NET 2.0 or 4.0 --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- &lt;supportedRuntime version=&quot;v2.0.50727&quot; /&gt; --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">supportedRuntime</span> <span class=\"attr\">version</span>=<span class=\"string\">&quot;v4.0&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">startup</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li>Then try to Launch agent.</li>\n</ol>\n<p>If it still does not work and has this error message “.NET Framework 2.0 or later is required on this computer to run a Jenkins agent as a Windows service”, you need to upgrade your .NET Framework.</p>\n<blockquote>\n<p>Here is a <a href=\"https://shenxianpeng.github.io/2020/07/jenkins-windows-agent-connect-problem/\">link</a> for update .NET Framework.</p>\n</blockquote>\n<p>Hopefully, this could help you to fix connect the issue of the Windows agent. Let me know in case of any questions.</p>\n","categories":[{"name":"Jenkins","path":"api/categories/Jenkins.json"}],"tags":[{"name":"Jenkins","path":"api/tags/Jenkins.json"}]}