{"title":"Execute sudo without password","slug":"2019/07/execute-sudo-without-password","date":"2019-07-16T13:07:39.000Z","updated":"2021-07-15T16:10:44.746Z","comments":true,"path":"api/articles/2019/07/execute-sudo-without-password.json","excerpt":"在使用 Jenkins pipeline 的时候，在 Linux 需要用 root 来执行，我想通过 Jenkins pipeline 的语法来解决，但是只找到这种方式：SSH Pipeline Steps","covers":null,"content":"<p>在使用 Jenkins pipeline 的时候，在 Linux 需要用 root 来执行，我想通过 Jenkins pipeline 的语法来解决，但是只找到这种方式：<a href=\"https://jenkins.io/doc/pipeline/steps/ssh-steps/\" target=\"_blank\" rel=\"noopener\">SSH Pipeline Steps</a></p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def remote = [:]</span><br><span class=\"line\">remote.name = <span class=\"string\">'test'</span></span><br><span class=\"line\">remote.host = <span class=\"string\">'test.domain.com'</span></span><br><span class=\"line\">remote.user = <span class=\"string\">'root'</span></span><br><span class=\"line\">remote.password = <span class=\"string\">'password'</span></span><br><span class=\"line\">remote.allowAnyHosts = <span class=\"literal\">true</span></span><br><span class=\"line\">stage(<span class=\"string\">'Remote SSH'</span>) &#123;</span><br><span class=\"line\">    sshCommand remote: remote, <span class=\"built_in\">command</span>: <span class=\"string\">\"ls -lrt\"</span></span><br><span class=\"line\">    sshCommand remote: remote, <span class=\"built_in\">command</span>: <span class=\"string\">\"for i in &#123;1..5&#125;; do echo -n \\\"Loop \\$i \\\"; date ; sleep 1; done\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">* <span class=\"built_in\">command</span></span><br><span class=\"line\">    * Type: String</span><br><span class=\"line\">* dryRun (optional)</span><br><span class=\"line\">    * Type: boolean</span><br><span class=\"line\">* failOnError (optional)</span><br><span class=\"line\">    * Type: boolean</span><br><span class=\"line\">* remote (optional)</span><br><span class=\"line\">    * Nested Choice of Objects</span><br><span class=\"line\">* sudo (optional)</span><br><span class=\"line\">    * Type: boolean</span><br></pre></td></tr></table></figure>\n\n<p>从 example 来看需要提供的参数比较多，很多参数我已经在 Pipeline 的 environment 已经设置过了，这里再设置就显得不够优美，且限于没有足够的 example，你知道的 Jenkinsfile 调试非常痛苦和麻烦，我就没通过这种方式来尝试解决。</p>\n<p>通过 Linux 设置来解决</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// open a shell console and <span class=\"built_in\">type</span></span><br><span class=\"line\">$ sudo visudo</span><br><span class=\"line\"></span><br><span class=\"line\">// <span class=\"built_in\">type</span> your user name</span><br><span class=\"line\">jenkins ALL=(ALL) NOPASSWD: ALL</span><br></pre></td></tr></table></figure>\n\n<p>但即使这样设置，通过 Jenkins 执行 shell 脚本的时候还是出现如下问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo: no tty present and no askpass program specified</span><br></pre></td></tr></table></figure>\n\n<p>最后通过如下脚本解决了我的问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Jenkinsfile</span><br><span class=\"line\"></span><br><span class=\"line\">environment &#123;</span><br><span class=\"line\">    JENKINS = credentials(\"d1cbab74-823d-41aa-abb7-85848595\")</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sh 'sudo -S &lt;&lt;&lt; \"$JENKINS_PSW\" sh test.sh'</span><br></pre></td></tr></table></figure>\n\n<p>如果你有更好的方式，欢迎留言评论，谢谢。</p>\n","more":"<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def remote = [:]</span><br><span class=\"line\">remote.name = <span class=\"string\">'test'</span></span><br><span class=\"line\">remote.host = <span class=\"string\">'test.domain.com'</span></span><br><span class=\"line\">remote.user = <span class=\"string\">'root'</span></span><br><span class=\"line\">remote.password = <span class=\"string\">'password'</span></span><br><span class=\"line\">remote.allowAnyHosts = <span class=\"literal\">true</span></span><br><span class=\"line\">stage(<span class=\"string\">'Remote SSH'</span>) &#123;</span><br><span class=\"line\">    sshCommand remote: remote, <span class=\"built_in\">command</span>: <span class=\"string\">\"ls -lrt\"</span></span><br><span class=\"line\">    sshCommand remote: remote, <span class=\"built_in\">command</span>: <span class=\"string\">\"for i in &#123;1..5&#125;; do echo -n \\\"Loop \\$i \\\"; date ; sleep 1; done\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">* <span class=\"built_in\">command</span></span><br><span class=\"line\">    * Type: String</span><br><span class=\"line\">* dryRun (optional)</span><br><span class=\"line\">    * Type: boolean</span><br><span class=\"line\">* failOnError (optional)</span><br><span class=\"line\">    * Type: boolean</span><br><span class=\"line\">* remote (optional)</span><br><span class=\"line\">    * Nested Choice of Objects</span><br><span class=\"line\">* sudo (optional)</span><br><span class=\"line\">    * Type: boolean</span><br></pre></td></tr></table></figure>\n\n<p>从 example 来看需要提供的参数比较多，很多参数我已经在 Pipeline 的 environment 已经设置过了，这里再设置就显得不够优美，且限于没有足够的 example，你知道的 Jenkinsfile 调试非常痛苦和麻烦，我就没通过这种方式来尝试解决。</p>\n<p>通过 Linux 设置来解决</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// open a shell console and <span class=\"built_in\">type</span></span><br><span class=\"line\">$ sudo visudo</span><br><span class=\"line\"></span><br><span class=\"line\">// <span class=\"built_in\">type</span> your user name</span><br><span class=\"line\">jenkins ALL=(ALL) NOPASSWD: ALL</span><br></pre></td></tr></table></figure>\n\n<p>但即使这样设置，通过 Jenkins 执行 shell 脚本的时候还是出现如下问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo: no tty present and no askpass program specified</span><br></pre></td></tr></table></figure>\n\n<p>最后通过如下脚本解决了我的问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// Jenkinsfile</span><br><span class=\"line\"></span><br><span class=\"line\">environment &#123;</span><br><span class=\"line\">    JENKINS = credentials(\"d1cbab74-823d-41aa-abb7-85848595\")</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sh 'sudo -S &lt;&lt;&lt; \"$JENKINS_PSW\" sh test.sh'</span><br></pre></td></tr></table></figure>\n\n<p>如果你有更好的方式，欢迎留言评论，谢谢。</p>","categories":[{"name":"OS","path":"api/categories/OS.json"}],"tags":[{"name":"Jenkins","path":"api/tags/Jenkins.json"},{"name":"Pipeline","path":"api/tags/Pipeline.json"},{"name":"Shell","path":"api/tags/Shell.json"}]}