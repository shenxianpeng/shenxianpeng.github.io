{"title":"Execute sudo without password","slug":"2019/07/execute-sudo-without-password","date":"2019-07-16T13:07:39.000Z","updated":"2023-12-04T04:14:14.261Z","comments":true,"path":"api/articles/2019/07/execute-sudo-without-password.json","excerpt":"在使用 Jenkins pipeline 的时候，在 Linux 需要用 root 来执行，我想通过 Jenkins pipeline 的语法来解决，但是只找到这种方式：SSH Pipeline Steps","covers":null,"content":"<p>在使用 Jenkins pipeline 的时候，在 Linux 需要用 root 来执行，我想通过 Jenkins pipeline 的语法来解决，但是只找到这种方式：<a href=\"https://jenkins.io/doc/pipeline/steps/ssh-steps/\">SSH Pipeline Steps</a></p>\n<span id=\"more\"></span>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">def remote = [:]</span><br><span class=\"line\">remote.name = <span class=\"string\">&#x27;test&#x27;</span></span><br><span class=\"line\">remote.host = <span class=\"string\">&#x27;test.domain.com&#x27;</span></span><br><span class=\"line\">remote.user = <span class=\"string\">&#x27;root&#x27;</span></span><br><span class=\"line\">remote.password = <span class=\"string\">&#x27;password&#x27;</span></span><br><span class=\"line\">remote.allowAnyHosts = <span class=\"literal\">true</span></span><br><span class=\"line\">stage(<span class=\"string\">&#x27;Remote SSH&#x27;</span>) &#123;</span><br><span class=\"line\">    sshCommand remote: remote, <span class=\"built_in\">command</span>: <span class=\"string\">&quot;ls -lrt&quot;</span></span><br><span class=\"line\">    sshCommand remote: remote, <span class=\"built_in\">command</span>: <span class=\"string\">&quot;for i in &#123;1..5&#125;; do echo -n \\&quot;Loop \\$i \\&quot;; date ; sleep 1; done&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">* <span class=\"built_in\">command</span></span><br><span class=\"line\">    * Type: String</span><br><span class=\"line\">* dryRun (optional)</span><br><span class=\"line\">    * Type: boolean</span><br><span class=\"line\">* failOnError (optional)</span><br><span class=\"line\">    * Type: boolean</span><br><span class=\"line\">* remote (optional)</span><br><span class=\"line\">    * Nested Choice of Objects</span><br><span class=\"line\">* sudo (optional)</span><br><span class=\"line\">    * Type: boolean</span><br></pre></td></tr></table></figure>\n\n<p>从 example 来看需要提供的参数比较多，很多参数我已经在 Pipeline 的 environment 已经设置过了，这里再设置就显得不够优美，且限于没有足够的 example，你知道的 Jenkinsfile 调试非常痛苦和麻烦，我就没通过这种方式来尝试解决。</p>\n<p>通过 Linux 设置来解决</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">// open a shell console and <span class=\"built_in\">type</span></span><br><span class=\"line\">$ sudo visudo</span><br><span class=\"line\"></span><br><span class=\"line\">// <span class=\"built_in\">type</span> your user name</span><br><span class=\"line\">jenkins ALL=(ALL) NOPASSWD: ALL</span><br></pre></td></tr></table></figure>\n\n<p>但即使这样设置，通过 Jenkins 执行 shell 脚本的时候还是出现如下问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">sudo: no tty present and no askpass program specified</span><br></pre></td></tr></table></figure>\n\n<p>最后通过如下脚本解决了我的问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">// Jenkinsfile</span><br><span class=\"line\"></span><br><span class=\"line\">environment &#123;</span><br><span class=\"line\">    JENKINS = credentials(&quot;d1cbab74-823d-41aa-abb7-85848595&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sh &#x27;sudo -S &lt;&lt;&lt; &quot;$JENKINS_PSW&quot; sh test.sh&#x27;</span><br></pre></td></tr></table></figure>\n\n<p>如果你有更好的方式，欢迎留言评论，谢谢。</p>\n","more":"<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">def remote = [:]</span><br><span class=\"line\">remote.name = <span class=\"string\">&#x27;test&#x27;</span></span><br><span class=\"line\">remote.host = <span class=\"string\">&#x27;test.domain.com&#x27;</span></span><br><span class=\"line\">remote.user = <span class=\"string\">&#x27;root&#x27;</span></span><br><span class=\"line\">remote.password = <span class=\"string\">&#x27;password&#x27;</span></span><br><span class=\"line\">remote.allowAnyHosts = <span class=\"literal\">true</span></span><br><span class=\"line\">stage(<span class=\"string\">&#x27;Remote SSH&#x27;</span>) &#123;</span><br><span class=\"line\">    sshCommand remote: remote, <span class=\"built_in\">command</span>: <span class=\"string\">&quot;ls -lrt&quot;</span></span><br><span class=\"line\">    sshCommand remote: remote, <span class=\"built_in\">command</span>: <span class=\"string\">&quot;for i in &#123;1..5&#125;; do echo -n \\&quot;Loop \\$i \\&quot;; date ; sleep 1; done&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">* <span class=\"built_in\">command</span></span><br><span class=\"line\">    * Type: String</span><br><span class=\"line\">* dryRun (optional)</span><br><span class=\"line\">    * Type: boolean</span><br><span class=\"line\">* failOnError (optional)</span><br><span class=\"line\">    * Type: boolean</span><br><span class=\"line\">* remote (optional)</span><br><span class=\"line\">    * Nested Choice of Objects</span><br><span class=\"line\">* sudo (optional)</span><br><span class=\"line\">    * Type: boolean</span><br></pre></td></tr></table></figure>\n\n<p>从 example 来看需要提供的参数比较多，很多参数我已经在 Pipeline 的 environment 已经设置过了，这里再设置就显得不够优美，且限于没有足够的 example，你知道的 Jenkinsfile 调试非常痛苦和麻烦，我就没通过这种方式来尝试解决。</p>\n<p>通过 Linux 设置来解决</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">// open a shell console and <span class=\"built_in\">type</span></span><br><span class=\"line\">$ sudo visudo</span><br><span class=\"line\"></span><br><span class=\"line\">// <span class=\"built_in\">type</span> your user name</span><br><span class=\"line\">jenkins ALL=(ALL) NOPASSWD: ALL</span><br></pre></td></tr></table></figure>\n\n<p>但即使这样设置，通过 Jenkins 执行 shell 脚本的时候还是出现如下问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">sudo: no tty present and no askpass program specified</span><br></pre></td></tr></table></figure>\n\n<p>最后通过如下脚本解决了我的问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">// Jenkinsfile</span><br><span class=\"line\"></span><br><span class=\"line\">environment &#123;</span><br><span class=\"line\">    JENKINS = credentials(&quot;d1cbab74-823d-41aa-abb7-85848595&quot;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">sh &#x27;sudo -S &lt;&lt;&lt; &quot;$JENKINS_PSW&quot; sh test.sh&#x27;</span><br></pre></td></tr></table></figure>\n\n<p>如果你有更好的方式，欢迎留言评论，谢谢。</p>","categories":[{"name":"OS","path":"api/categories/OS.json"}],"tags":[{"name":"Jenkins","path":"api/tags/Jenkins.json"},{"name":"Pipeline","path":"api/tags/Pipeline.json"},{"name":"Shell","path":"api/tags/Shell.json"}]}