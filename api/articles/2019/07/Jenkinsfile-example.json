{"title":"Jenkinsfile example - 实现交互、clone 多个仓库以及 git push","slug":"2019/07/Jenkinsfile-example","date":"2019-07-07T10:45:53.000Z","updated":"2020-07-03T05:27:57.288Z","comments":true,"path":"api/articles/2019/07/Jenkinsfile-example.json","excerpt":"这个pipeline里包含了如下几个技术：如何使用其他机器，agent如何使用环境变量，environment如何在build前通过参数化输入，parameters如何使用交互，input如何同时clone多个repos如何进行条件判断，anyOf","covers":null,"content":"<p>这个pipeline里包含了如下几个技术：</p>\n<ul>\n<li>如何使用其他机器，agent</li>\n<li>如何使用环境变量，environment</li>\n<li>如何在build前通过参数化输入，parameters</li>\n<li>如何使用交互，input</li>\n<li>如何同时clone多个repos</li>\n<li>如何进行条件判断，anyOf</li>\n</ul>\n<a id=\"more\"></a>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent &#123;</span><br><span class=\"line\">        node &#123;</span><br><span class=\"line\">            label <span class=\"string\">'windows-agent'</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    environment &#123;</span><br><span class=\"line\">        MY_CRE = credentials(<span class=\"string\">\"2aee7e0c-a728-4d9c-b25b-ad5451a12d\"</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    parameters &#123;</span><br><span class=\"line\">        // Jenkins parameter</span><br><span class=\"line\">        choice(</span><br><span class=\"line\">            name: <span class=\"string\">'REPO'</span>,</span><br><span class=\"line\">            choices: [<span class=\"string\">'repo1'</span>, <span class=\"string\">'repo2'</span>, <span class=\"string\">'repo3'</span>, <span class=\"string\">'repo4'</span>],</span><br><span class=\"line\">            description: <span class=\"string\">'Required: pick a repo you want to build'</span>)</span><br><span class=\"line\">        string(</span><br><span class=\"line\">            name: <span class=\"string\">'BRANCH'</span>,</span><br><span class=\"line\">            defaultValue: <span class=\"string\">''</span>,</span><br><span class=\"line\">            description: <span class=\"string\">'Required: chose a branch you want to checkout'</span>)</span><br><span class=\"line\">        string(</span><br><span class=\"line\">            name: <span class=\"string\">'BUILD_NO'</span>,</span><br><span class=\"line\">            defaultValue: <span class=\"string\">''</span>,</span><br><span class=\"line\">            description: <span class=\"string\">'Required: input build number'</span>)</span><br><span class=\"line\">        string(</span><br><span class=\"line\">            name: <span class=\"string\">'JIRA_NO'</span>,</span><br><span class=\"line\">            defaultValue: <span class=\"string\">''</span>,</span><br><span class=\"line\">            description: <span class=\"string\">'Optional: input jira ticket number for commit message'</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">\"Are you sure?\"</span>)&#123;</span><br><span class=\"line\">            steps&#123;</span><br><span class=\"line\">                // make sure you want to start this build</span><br><span class=\"line\">                input message: <span class=\"string\">\"<span class=\"variable\">$&#123;REPO&#125;</span>/<span class=\"variable\">$&#123;BRANCH&#125;</span>:<span class=\"variable\">$&#123;BUILD_NO&#125;</span>, are you sure?\"</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">\"I'm sure!\"</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Git clone repos'</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                // git <span class=\"built_in\">clone</span> one repo <span class=\"built_in\">source</span> code</span><br><span class=\"line\">                checkout([</span><br><span class=\"line\">                    <span class=\"variable\">$class</span>: <span class=\"string\">'GitSCM'</span>, branches: [[name: <span class=\"string\">'refs/heads/$&#123;BRANCH&#125;'</span>]], browser: [<span class=\"variable\">$class</span>: <span class=\"string\">'GitHub'</span>, repoUrl: <span class=\"string\">'https://github.com/$&#123;REPO&#125;'</span>], doGenerateSubmoduleConfigurations: <span class=\"literal\">false</span>, extensions: [[<span class=\"variable\">$class</span>: <span class=\"string\">'CleanBeforeCheckout'</span>], [<span class=\"variable\">$class</span>: <span class=\"string\">'LocalBranch'</span>, localBranch: <span class=\"string\">'**'</span>], [<span class=\"variable\">$class</span>: <span class=\"string\">'RelativeTargetDirectory'</span>, relativeTargetDir: <span class=\"string\">'../$&#123;REPO&#125;'</span>]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: <span class=\"string\">'2aee7e0c-a728-4d9c-b25b'</span>, url: <span class=\"string\">'https://github.com/$&#123;REPO&#125;.git'</span>]]])</span><br><span class=\"line\"></span><br><span class=\"line\">                // git <span class=\"built_in\">clone</span> another repo <span class=\"built_in\">source</span> code</span><br><span class=\"line\">                checkout([</span><br><span class=\"line\">                    <span class=\"variable\">$class</span>: <span class=\"string\">'GitSCM'</span>, branches: [[name: <span class=\"string\">'refs/heads/$&#123;BRANCH&#125;'</span>]], browser: [<span class=\"variable\">$class</span>: <span class=\"string\">'GitHub'</span>, repoUrl: <span class=\"string\">'https://github.com/$&#123;REPO&#125;'</span>], doGenerateSubmoduleConfigurations: <span class=\"literal\">false</span>, extensions: [[<span class=\"variable\">$class</span>: <span class=\"string\">'CleanBeforeCheckout'</span>], [<span class=\"variable\">$class</span>: <span class=\"string\">'LocalBranch'</span>, localBranch: <span class=\"string\">'**'</span>], [<span class=\"variable\">$class</span>: <span class=\"string\">'RelativeTargetDirectory'</span>, relativeTargetDir: <span class=\"string\">'../$&#123;REPO&#125;'</span>]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: <span class=\"string\">'2aee7e0c-a728-4d9c-b25b'</span>, url: <span class=\"string\">'https://github.com/$&#123;REPO&#125;.git'</span>]]])</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Build repo1 and repo2'</span>) &#123;</span><br><span class=\"line\">            when &#123;</span><br><span class=\"line\">                // <span class=\"keyword\">if</span> REPO=repo1 or REPO=repo2, execute build_repo12.sh</span><br><span class=\"line\">                anyOf &#123;</span><br><span class=\"line\">                    environment name: <span class=\"string\">'REPO'</span>, value: <span class=\"string\">'repo1'</span></span><br><span class=\"line\">                    environment name: <span class=\"string\">'REPO'</span>, value: <span class=\"string\">'repo2'</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh label: <span class=\"string\">''</span>, script: <span class=\"string\">'$&#123;REPO&#125;/build_repo12.sh $&#123;REPO&#125; $&#123;BUILD_NO&#125; $&#123;JIRA_NO&#125;'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Build repo3 and repo4'</span>) &#123;</span><br><span class=\"line\">            when &#123;</span><br><span class=\"line\">                // <span class=\"keyword\">if</span> REPO=repo3 or REPO=repo4, execute build_repo34.sh</span><br><span class=\"line\">                anyOf &#123;</span><br><span class=\"line\">                    environment name: <span class=\"string\">'REPO'</span>, value: <span class=\"string\">'repo3'</span></span><br><span class=\"line\">                    environment name: <span class=\"string\">'REPO'</span>, value: <span class=\"string\">'repo4'</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh label: <span class=\"string\">''</span>, script: <span class=\"string\">'$&#123;REPO&#125;/build_repo34.sh $&#123;REPO&#125; $&#123;BUILD_NO&#125; $&#123;JIRA_NO&#125;'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        stage(<span class=\"string\">'Git push to remote repo'</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                // commit code to remote repo</span><br><span class=\"line\">                sshagent([<span class=\"string\">'2aee7e0c-a728-4d9c-b25b'</span>]) &#123;</span><br><span class=\"line\">                    sh <span class=\"string\">\"git push https://%MY_CRE_USR%:%MY_CRE_PSW%@github.com/<span class=\"variable\">$&#123;REPO&#125;</span>.git\"</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","more":"<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent &#123;</span><br><span class=\"line\">        node &#123;</span><br><span class=\"line\">            label <span class=\"string\">'windows-agent'</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    environment &#123;</span><br><span class=\"line\">        MY_CRE = credentials(<span class=\"string\">\"2aee7e0c-a728-4d9c-b25b-ad5451a12d\"</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    parameters &#123;</span><br><span class=\"line\">        // Jenkins parameter</span><br><span class=\"line\">        choice(</span><br><span class=\"line\">            name: <span class=\"string\">'REPO'</span>,</span><br><span class=\"line\">            choices: [<span class=\"string\">'repo1'</span>, <span class=\"string\">'repo2'</span>, <span class=\"string\">'repo3'</span>, <span class=\"string\">'repo4'</span>],</span><br><span class=\"line\">            description: <span class=\"string\">'Required: pick a repo you want to build'</span>)</span><br><span class=\"line\">        string(</span><br><span class=\"line\">            name: <span class=\"string\">'BRANCH'</span>,</span><br><span class=\"line\">            defaultValue: <span class=\"string\">''</span>,</span><br><span class=\"line\">            description: <span class=\"string\">'Required: chose a branch you want to checkout'</span>)</span><br><span class=\"line\">        string(</span><br><span class=\"line\">            name: <span class=\"string\">'BUILD_NO'</span>,</span><br><span class=\"line\">            defaultValue: <span class=\"string\">''</span>,</span><br><span class=\"line\">            description: <span class=\"string\">'Required: input build number'</span>)</span><br><span class=\"line\">        string(</span><br><span class=\"line\">            name: <span class=\"string\">'JIRA_NO'</span>,</span><br><span class=\"line\">            defaultValue: <span class=\"string\">''</span>,</span><br><span class=\"line\">            description: <span class=\"string\">'Optional: input jira ticket number for commit message'</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">\"Are you sure?\"</span>)&#123;</span><br><span class=\"line\">            steps&#123;</span><br><span class=\"line\">                // make sure you want to start this build</span><br><span class=\"line\">                input message: <span class=\"string\">\"<span class=\"variable\">$&#123;REPO&#125;</span>/<span class=\"variable\">$&#123;BRANCH&#125;</span>:<span class=\"variable\">$&#123;BUILD_NO&#125;</span>, are you sure?\"</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">\"I'm sure!\"</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Git clone repos'</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                // git <span class=\"built_in\">clone</span> one repo <span class=\"built_in\">source</span> code</span><br><span class=\"line\">                checkout([</span><br><span class=\"line\">                    <span class=\"variable\">$class</span>: <span class=\"string\">'GitSCM'</span>, branches: [[name: <span class=\"string\">'refs/heads/$&#123;BRANCH&#125;'</span>]], browser: [<span class=\"variable\">$class</span>: <span class=\"string\">'GitHub'</span>, repoUrl: <span class=\"string\">'https://github.com/$&#123;REPO&#125;'</span>], doGenerateSubmoduleConfigurations: <span class=\"literal\">false</span>, extensions: [[<span class=\"variable\">$class</span>: <span class=\"string\">'CleanBeforeCheckout'</span>], [<span class=\"variable\">$class</span>: <span class=\"string\">'LocalBranch'</span>, localBranch: <span class=\"string\">'**'</span>], [<span class=\"variable\">$class</span>: <span class=\"string\">'RelativeTargetDirectory'</span>, relativeTargetDir: <span class=\"string\">'../$&#123;REPO&#125;'</span>]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: <span class=\"string\">'2aee7e0c-a728-4d9c-b25b'</span>, url: <span class=\"string\">'https://github.com/$&#123;REPO&#125;.git'</span>]]])</span><br><span class=\"line\"></span><br><span class=\"line\">                // git <span class=\"built_in\">clone</span> another repo <span class=\"built_in\">source</span> code</span><br><span class=\"line\">                checkout([</span><br><span class=\"line\">                    <span class=\"variable\">$class</span>: <span class=\"string\">'GitSCM'</span>, branches: [[name: <span class=\"string\">'refs/heads/$&#123;BRANCH&#125;'</span>]], browser: [<span class=\"variable\">$class</span>: <span class=\"string\">'GitHub'</span>, repoUrl: <span class=\"string\">'https://github.com/$&#123;REPO&#125;'</span>], doGenerateSubmoduleConfigurations: <span class=\"literal\">false</span>, extensions: [[<span class=\"variable\">$class</span>: <span class=\"string\">'CleanBeforeCheckout'</span>], [<span class=\"variable\">$class</span>: <span class=\"string\">'LocalBranch'</span>, localBranch: <span class=\"string\">'**'</span>], [<span class=\"variable\">$class</span>: <span class=\"string\">'RelativeTargetDirectory'</span>, relativeTargetDir: <span class=\"string\">'../$&#123;REPO&#125;'</span>]], submoduleCfg: [], userRemoteConfigs: [[credentialsId: <span class=\"string\">'2aee7e0c-a728-4d9c-b25b'</span>, url: <span class=\"string\">'https://github.com/$&#123;REPO&#125;.git'</span>]]])</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Build repo1 and repo2'</span>) &#123;</span><br><span class=\"line\">            when &#123;</span><br><span class=\"line\">                // <span class=\"keyword\">if</span> REPO=repo1 or REPO=repo2, execute build_repo12.sh</span><br><span class=\"line\">                anyOf &#123;</span><br><span class=\"line\">                    environment name: <span class=\"string\">'REPO'</span>, value: <span class=\"string\">'repo1'</span></span><br><span class=\"line\">                    environment name: <span class=\"string\">'REPO'</span>, value: <span class=\"string\">'repo2'</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh label: <span class=\"string\">''</span>, script: <span class=\"string\">'$&#123;REPO&#125;/build_repo12.sh $&#123;REPO&#125; $&#123;BUILD_NO&#125; $&#123;JIRA_NO&#125;'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">'Build repo3 and repo4'</span>) &#123;</span><br><span class=\"line\">            when &#123;</span><br><span class=\"line\">                // <span class=\"keyword\">if</span> REPO=repo3 or REPO=repo4, execute build_repo34.sh</span><br><span class=\"line\">                anyOf &#123;</span><br><span class=\"line\">                    environment name: <span class=\"string\">'REPO'</span>, value: <span class=\"string\">'repo3'</span></span><br><span class=\"line\">                    environment name: <span class=\"string\">'REPO'</span>, value: <span class=\"string\">'repo4'</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh label: <span class=\"string\">''</span>, script: <span class=\"string\">'$&#123;REPO&#125;/build_repo34.sh $&#123;REPO&#125; $&#123;BUILD_NO&#125; $&#123;JIRA_NO&#125;'</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        stage(<span class=\"string\">'Git push to remote repo'</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                // commit code to remote repo</span><br><span class=\"line\">                sshagent([<span class=\"string\">'2aee7e0c-a728-4d9c-b25b'</span>]) &#123;</span><br><span class=\"line\">                    sh <span class=\"string\">\"git push https://%MY_CRE_USR%:%MY_CRE_PSW%@github.com/<span class=\"variable\">$&#123;REPO&#125;</span>.git\"</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":[{"name":"Jenkins","path":"api/categories/Jenkins.json"}],"tags":[{"name":"Jenkins","path":"api/tags/Jenkins.json"},{"name":"Pipeline","path":"api/tags/Pipeline.json"}]}