{"title":"Multibranch Pipeline","slug":"2019/06/multi-branch-pipeline","date":"2019-06-25T14:15:42.000Z","updated":"2020-05-23T16:08:16.730Z","comments":true,"path":"api/articles/2019/06/multi-branch-pipeline.json","excerpt":null,"covers":null,"content":"<h2 id=\"Problems\"><a href=\"#Problems\" class=\"headerlink\" title=\"Problems\"></a>Problems</h2><p>Like database product, it runs on multi-platform, but for software enginner they may only works on one platform, how they could identify their code works on all platform? manually build the various platforms? NO!</p>\n<h2 id=\"Solution\"><a href=\"#Solution\" class=\"headerlink\" title=\"Solution\"></a>Solution</h2><p>Most people would know we can use Jenkins pipeline, they may create multi Jenkins job for different stuation.</p>\n<p>How to do it in an elegant way, I would want to share how to use multibranch pipeline to achieve.</p>\n<ol>\n<li>When create a pull request, auto parallel start simple build.</li>\n<li>Reviewers can decide whether to merge base on build results.</li>\n<li>After code merged, auto start full build.</li>\n</ol>\n<h2 id=\"Benefits\"><a href=\"#Benefits\" class=\"headerlink\" title=\"Benefits\"></a>Benefits</h2><p>What are the benefits:</p>\n<ol>\n<li>One Jenkins job and one pipeline can manage multi branches.</li>\n<li>Do not need to compile platforms to verify, save huge time and machines.</li>\n<li>Stop looking for other people’s mistakes, no one can break the build.</li>\n<li>Builds can be generated quickly for QA testing</li>\n</ol>\n<h2 id=\"Jenkinsfile-example\"><a href=\"#Jenkinsfile-example\" class=\"headerlink\" title=\"Jenkinsfile example\"></a>Jenkinsfile example</h2><p>In case of reduce simple build time and let PR creater and reviewer know the builds status as soon as possbile, you may need to do something different here, like below, used when condition and branch variable to check it is a develop branch or pull request branch.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">when &#123;</span><br><span class=\"line\">    branch <span class=\"string\">'PR-*'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">when &#123;</span><br><span class=\"line\">    branch <span class=\"string\">'develop'</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The entire code pipeline looks like this:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// This Jenkinsfile is an explame <span class=\"keyword\">for</span> multibranch pipeline</span><br><span class=\"line\"></span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent none</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">\"All platform builds\"</span>) &#123;</span><br><span class=\"line\">            parallel &#123;</span><br><span class=\"line\">                stage(<span class=\"string\">\"Windows build\"</span>) &#123;</span><br><span class=\"line\">                    agent &#123;</span><br><span class=\"line\">                        node &#123;</span><br><span class=\"line\">                            label <span class=\"string\">'windows-vm01'</span></span><br><span class=\"line\">                            customWorkspace <span class=\"string\">'C:\\\\agent\\\\workspace\\\\blog'</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    stages &#123;</span><br><span class=\"line\">                        stage(<span class=\"string\">\"PR build\"</span>) &#123;</span><br><span class=\"line\">                            when &#123;</span><br><span class=\"line\">                                branch <span class=\"string\">'PR-*'</span></span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            steps &#123;</span><br><span class=\"line\">                                checkout scm</span><br><span class=\"line\">                                dir(<span class=\"string\">'src\\\\build'</span>) &#123;</span><br><span class=\"line\">                                    bat label: <span class=\"string\">''</span>, script: <span class=\"string\">'build.bat PR'</span></span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        stage(<span class=\"string\">\"Release build\"</span>) &#123;</span><br><span class=\"line\">                            when &#123;</span><br><span class=\"line\">                                branch <span class=\"string\">'develop'</span></span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            steps &#123;</span><br><span class=\"line\">                                cleanWs()</span><br><span class=\"line\">                                checkout scm</span><br><span class=\"line\">                                dir(<span class=\"string\">'src\\\\build'</span>) &#123;</span><br><span class=\"line\">                                    bat label: <span class=\"string\">''</span>, script: <span class=\"string\">'build.bat release'</span></span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        stage(<span class=\"string\">\"Deploy\"</span>) &#123;</span><br><span class=\"line\">                            <span class=\"built_in\">echo</span> <span class=\"string\">\"====if you have more stage, can add stage like this===\"</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                stage(<span class=\"string\">\"Linux build\"</span>) &#123;</span><br><span class=\"line\">                    agent &#123;</span><br><span class=\"line\">                        node &#123;</span><br><span class=\"line\">                            label <span class=\"string\">'linux-vm01'</span></span><br><span class=\"line\">                            customWorkspace <span class=\"string\">'/agent/workspace/blog'</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    stages &#123;</span><br><span class=\"line\">                        stage(<span class=\"string\">\"PR build\"</span>) &#123;</span><br><span class=\"line\">                            when &#123;</span><br><span class=\"line\">                                branch <span class=\"string\">'PR-*'</span></span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            steps &#123;</span><br><span class=\"line\">                                checkout scm</span><br><span class=\"line\">                                dir(<span class=\"string\">'src/build'</span>) &#123;</span><br><span class=\"line\">                                    bat label: <span class=\"string\">''</span>, script: <span class=\"string\">'build.sh PR'</span></span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        stage(<span class=\"string\">\"Release build\"</span>) &#123;</span><br><span class=\"line\">                            when &#123;</span><br><span class=\"line\">                                branch <span class=\"string\">'develop'</span></span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            steps &#123;</span><br><span class=\"line\">                                cleanWs()</span><br><span class=\"line\">                                checkout scm</span><br><span class=\"line\">                                dir(<span class=\"string\">'src/build'</span>) &#123;</span><br><span class=\"line\">                                    bat label: <span class=\"string\">''</span>, script: <span class=\"string\">'build.sh release'</span></span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                stage(<span class=\"string\">\"AIX build\"</span>)&#123;</span><br><span class=\"line\">                    steps&#123;</span><br><span class=\"line\">                        <span class=\"built_in\">echo</span> <span class=\"string\">\"====same as windows/Linux example, can write the code here you need ====\"</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","more":"<h2 id=\"Problems\"><a href=\"#Problems\" class=\"headerlink\" title=\"Problems\"></a>Problems</h2><p>Like database product, it runs on multi-platform, but for software enginner they may only works on one platform, how they could identify their code works on all platform? manually build the various platforms? NO!</p>\n<h2 id=\"Solution\"><a href=\"#Solution\" class=\"headerlink\" title=\"Solution\"></a>Solution</h2><p>Most people would know we can use Jenkins pipeline, they may create multi Jenkins job for different stuation.</p>\n<p>How to do it in an elegant way, I would want to share how to use multibranch pipeline to achieve.</p>\n<ol>\n<li>When create a pull request, auto parallel start simple build.</li>\n<li>Reviewers can decide whether to merge base on build results.</li>\n<li>After code merged, auto start full build.</li>\n</ol>\n<h2 id=\"Benefits\"><a href=\"#Benefits\" class=\"headerlink\" title=\"Benefits\"></a>Benefits</h2><p>What are the benefits:</p>\n<ol>\n<li>One Jenkins job and one pipeline can manage multi branches.</li>\n<li>Do not need to compile platforms to verify, save huge time and machines.</li>\n<li>Stop looking for other people’s mistakes, no one can break the build.</li>\n<li>Builds can be generated quickly for QA testing</li>\n</ol>\n<h2 id=\"Jenkinsfile-example\"><a href=\"#Jenkinsfile-example\" class=\"headerlink\" title=\"Jenkinsfile example\"></a>Jenkinsfile example</h2><p>In case of reduce simple build time and let PR creater and reviewer know the builds status as soon as possbile, you may need to do something different here, like below, used when condition and branch variable to check it is a develop branch or pull request branch.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">when &#123;</span><br><span class=\"line\">    branch <span class=\"string\">'PR-*'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">when &#123;</span><br><span class=\"line\">    branch <span class=\"string\">'develop'</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>The entire code pipeline looks like this:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// This Jenkinsfile is an explame <span class=\"keyword\">for</span> multibranch pipeline</span><br><span class=\"line\"></span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent none</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">\"All platform builds\"</span>) &#123;</span><br><span class=\"line\">            parallel &#123;</span><br><span class=\"line\">                stage(<span class=\"string\">\"Windows build\"</span>) &#123;</span><br><span class=\"line\">                    agent &#123;</span><br><span class=\"line\">                        node &#123;</span><br><span class=\"line\">                            label <span class=\"string\">'windows-vm01'</span></span><br><span class=\"line\">                            customWorkspace <span class=\"string\">'C:\\\\agent\\\\workspace\\\\blog'</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    stages &#123;</span><br><span class=\"line\">                        stage(<span class=\"string\">\"PR build\"</span>) &#123;</span><br><span class=\"line\">                            when &#123;</span><br><span class=\"line\">                                branch <span class=\"string\">'PR-*'</span></span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            steps &#123;</span><br><span class=\"line\">                                checkout scm</span><br><span class=\"line\">                                dir(<span class=\"string\">'src\\\\build'</span>) &#123;</span><br><span class=\"line\">                                    bat label: <span class=\"string\">''</span>, script: <span class=\"string\">'build.bat PR'</span></span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        stage(<span class=\"string\">\"Release build\"</span>) &#123;</span><br><span class=\"line\">                            when &#123;</span><br><span class=\"line\">                                branch <span class=\"string\">'develop'</span></span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            steps &#123;</span><br><span class=\"line\">                                cleanWs()</span><br><span class=\"line\">                                checkout scm</span><br><span class=\"line\">                                dir(<span class=\"string\">'src\\\\build'</span>) &#123;</span><br><span class=\"line\">                                    bat label: <span class=\"string\">''</span>, script: <span class=\"string\">'build.bat release'</span></span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        stage(<span class=\"string\">\"Deploy\"</span>) &#123;</span><br><span class=\"line\">                            <span class=\"built_in\">echo</span> <span class=\"string\">\"====if you have more stage, can add stage like this===\"</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                stage(<span class=\"string\">\"Linux build\"</span>) &#123;</span><br><span class=\"line\">                    agent &#123;</span><br><span class=\"line\">                        node &#123;</span><br><span class=\"line\">                            label <span class=\"string\">'linux-vm01'</span></span><br><span class=\"line\">                            customWorkspace <span class=\"string\">'/agent/workspace/blog'</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    stages &#123;</span><br><span class=\"line\">                        stage(<span class=\"string\">\"PR build\"</span>) &#123;</span><br><span class=\"line\">                            when &#123;</span><br><span class=\"line\">                                branch <span class=\"string\">'PR-*'</span></span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            steps &#123;</span><br><span class=\"line\">                                checkout scm</span><br><span class=\"line\">                                dir(<span class=\"string\">'src/build'</span>) &#123;</span><br><span class=\"line\">                                    bat label: <span class=\"string\">''</span>, script: <span class=\"string\">'build.sh PR'</span></span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        stage(<span class=\"string\">\"Release build\"</span>) &#123;</span><br><span class=\"line\">                            when &#123;</span><br><span class=\"line\">                                branch <span class=\"string\">'develop'</span></span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            steps &#123;</span><br><span class=\"line\">                                cleanWs()</span><br><span class=\"line\">                                checkout scm</span><br><span class=\"line\">                                dir(<span class=\"string\">'src/build'</span>) &#123;</span><br><span class=\"line\">                                    bat label: <span class=\"string\">''</span>, script: <span class=\"string\">'build.sh release'</span></span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                stage(<span class=\"string\">\"AIX build\"</span>)&#123;</span><br><span class=\"line\">                    steps&#123;</span><br><span class=\"line\">                        <span class=\"built_in\">echo</span> <span class=\"string\">\"====same as windows/Linux example, can write the code here you need ====\"</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","categories":[{"name":"Jenkins","path":"api/categories/Jenkins.json"}],"tags":[{"name":"Jenkins","path":"api/tags/Jenkins.json"},{"name":"Pipeline","path":"api/tags/Pipeline.json"},{"name":"multi-branch","path":"api/tags/multi-branch.json"}]}