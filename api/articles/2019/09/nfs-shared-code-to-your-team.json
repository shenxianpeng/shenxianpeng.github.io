{"title":"通过 NFS 和 Jenkins 来共享和同步第三方库代码","slug":"2019/09/nfs-shared-code-to-your-team","date":"2019-09-10T14:38:47.000Z","updated":"2020-06-07T03:27:59.592Z","comments":true,"path":"api/articles/2019/09/nfs-shared-code-to-your-team.json","excerpt":null,"covers":null,"content":"<p>最近遇到这样一个需求，我们有一个共享仓库的代码所在用的空间非常大（超过 20 G），在每个产品构建时候都需要用到这个仓库的代码（从里面 copy 第三方库），如果每个人都要 git clone 这个第三方仓库，一是网络开销非常大，二是 git clone 时间长，三是占用大量的物理空间。</p>\n<p>这里通过 NFS 和 Jenkins 来解决。</p>\n<p>什么是 NFS？NFS（Network File System）即网络文件系统，是 FreeBSD 支持的文件系统中的一种，它允许网络中的计算机之间共享资源。在 NFS 的应用中，本地 NFS 的客户端应用可以透明地读写位于远端 NFS 服务器上的文件，就像访问本地文件一样，Windows 上俗称共享。</p>\n<p>Jenkins 不必多说，用它主要是来监测如果这个容量巨大的仓库有代码提交就自动执行 git pull 操作，更新最近的代码到共享服务器上。</p>\n<h2 id=\"设置-NFS-及-启动命令\"><a href=\"#设置-NFS-及-启动命令\" class=\"headerlink\" title=\"设置 NFS 及 启动命令\"></a>设置 NFS 及 启动命令</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 例如在 Linux 上, 共享服务器的 ip 是 192.168.1.1</span></span><br><span class=\"line\">sudo vi /etc/exports</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以下是我的 exports 文件的配置</span></span><br><span class=\"line\"><span class=\"comment\"># 假设内网 ip 是这样的区间 192.168.1.1 ~ 192.168.1.250</span></span><br><span class=\"line\"><span class=\"comment\"># ro 表示只读</span></span><br><span class=\"line\"><span class=\"comment\"># all_squash 表示不管使用 NFS 的用户是谁，他的身份都会被限定成为一个指定的普通用户身份(nfsnobody)</span></span><br><span class=\"line\">/agent/workspace/opensrc 192.168.1.*(ro,all_squash)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动 NFS 服务，需要启动portmap和nfs两个服务，并且portmap一定要先于nfs启动;</span></span><br><span class=\"line\">service portmap start</span><br><span class=\"line\">service nfs start</span><br><span class=\"line\"><span class=\"comment\"># 查看 portmap 状态</span></span><br><span class=\"line\">service portmap status</span><br><span class=\"line\"><span class=\"comment\"># 查看 NFS 状态</span></span><br><span class=\"line\">service nfs status</span><br><span class=\"line\"><span class=\"comment\"># 停止 NFS 服务</span></span><br><span class=\"line\">service nfs stop</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 当改变/etc/exports配置文件后，不用重启 NFS 服务直接用这个 exportfs 即可</span></span><br><span class=\"line\">sudo exportfs -rv</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"挂载到不同-UNIX-平台\"><a href=\"#挂载到不同-UNIX-平台\" class=\"headerlink\" title=\"挂载到不同 UNIX 平台\"></a>挂载到不同 UNIX 平台</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Linux</span></span><br><span class=\"line\">sudo mount -t nfs 192.168.1.1:/agent/workspace/opensrc /agent/workspace/opensrc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># AIX</span></span><br><span class=\"line\">sudo nfso -o nfs_use_reserved_ports=1     <span class=\"comment\"># should only first time mount need to run this command</span></span><br><span class=\"line\">sudo mount -F nfs 192.168.1.1:/agent/workspace/opensrc /agent/workspace/opensrc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># HP-UX</span></span><br><span class=\"line\">sudo mount -F nfs 192.168.1.1:/agent/workspace/opensrc /agent/workspace/opensrc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Solaris-SPARC</span></span><br><span class=\"line\"><span class=\"comment\"># 如果你不能直接在命令行执行 mount</span></span><br><span class=\"line\">sudo /usr/sbin/mount -F nfs 192.168.1.1:/agent/workspace/opensrc /agent/workspace/opensrc</span><br></pre></td></tr></table></figure>\n","more":"<p>最近遇到这样一个需求，我们有一个共享仓库的代码所在用的空间非常大（超过 20 G），在每个产品构建时候都需要用到这个仓库的代码（从里面 copy 第三方库），如果每个人都要 git clone 这个第三方仓库，一是网络开销非常大，二是 git clone 时间长，三是占用大量的物理空间。</p>\n<p>这里通过 NFS 和 Jenkins 来解决。</p>\n<p>什么是 NFS？NFS（Network File System）即网络文件系统，是 FreeBSD 支持的文件系统中的一种，它允许网络中的计算机之间共享资源。在 NFS 的应用中，本地 NFS 的客户端应用可以透明地读写位于远端 NFS 服务器上的文件，就像访问本地文件一样，Windows 上俗称共享。</p>\n<p>Jenkins 不必多说，用它主要是来监测如果这个容量巨大的仓库有代码提交就自动执行 git pull 操作，更新最近的代码到共享服务器上。</p>\n<h2 id=\"设置-NFS-及-启动命令\"><a href=\"#设置-NFS-及-启动命令\" class=\"headerlink\" title=\"设置 NFS 及 启动命令\"></a>设置 NFS 及 启动命令</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 例如在 Linux 上, 共享服务器的 ip 是 192.168.1.1</span></span><br><span class=\"line\">sudo vi /etc/exports</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以下是我的 exports 文件的配置</span></span><br><span class=\"line\"><span class=\"comment\"># 假设内网 ip 是这样的区间 192.168.1.1 ~ 192.168.1.250</span></span><br><span class=\"line\"><span class=\"comment\"># ro 表示只读</span></span><br><span class=\"line\"><span class=\"comment\"># all_squash 表示不管使用 NFS 的用户是谁，他的身份都会被限定成为一个指定的普通用户身份(nfsnobody)</span></span><br><span class=\"line\">/agent/workspace/opensrc 192.168.1.*(ro,all_squash)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动 NFS 服务，需要启动portmap和nfs两个服务，并且portmap一定要先于nfs启动;</span></span><br><span class=\"line\">service portmap start</span><br><span class=\"line\">service nfs start</span><br><span class=\"line\"><span class=\"comment\"># 查看 portmap 状态</span></span><br><span class=\"line\">service portmap status</span><br><span class=\"line\"><span class=\"comment\"># 查看 NFS 状态</span></span><br><span class=\"line\">service nfs status</span><br><span class=\"line\"><span class=\"comment\"># 停止 NFS 服务</span></span><br><span class=\"line\">service nfs stop</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 当改变/etc/exports配置文件后，不用重启 NFS 服务直接用这个 exportfs 即可</span></span><br><span class=\"line\">sudo exportfs -rv</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"挂载到不同-UNIX-平台\"><a href=\"#挂载到不同-UNIX-平台\" class=\"headerlink\" title=\"挂载到不同 UNIX 平台\"></a>挂载到不同 UNIX 平台</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Linux</span></span><br><span class=\"line\">sudo mount -t nfs 192.168.1.1:/agent/workspace/opensrc /agent/workspace/opensrc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># AIX</span></span><br><span class=\"line\">sudo nfso -o nfs_use_reserved_ports=1     <span class=\"comment\"># should only first time mount need to run this command</span></span><br><span class=\"line\">sudo mount -F nfs 192.168.1.1:/agent/workspace/opensrc /agent/workspace/opensrc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># HP-UX</span></span><br><span class=\"line\">sudo mount -F nfs 192.168.1.1:/agent/workspace/opensrc /agent/workspace/opensrc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Solaris-SPARC</span></span><br><span class=\"line\"><span class=\"comment\"># 如果你不能直接在命令行执行 mount</span></span><br><span class=\"line\">sudo /usr/sbin/mount -F nfs 192.168.1.1:/agent/workspace/opensrc /agent/workspace/opensrc</span><br></pre></td></tr></table></figure>\n","categories":[{"name":"LinuxUnix","path":"api/categories/LinuxUnix.json"}],"tags":[{"name":"Jenkins","path":"api/tags/Jenkins.json"},{"name":"Shell","path":"api/tags/Shell.json"},{"name":"NFS","path":"api/tags/NFS.json"}]}