{"title":"Witness 和 SLSA 💃","slug":"2023/11/witness-and-slsa","date":"2023-11-30T06:25:39.000Z","updated":"2024-04-03T06:02:32.462Z","comments":true,"path":"api/articles/2023/11/witness-and-slsa.json","excerpt":"由于近些年针对软件的供应链的攻击越来越频繁，因此 Google 在 2021 提出的解决方案是软件工件供应链级别（Supply chain Levels for Software Artifacts，”SLSA”）本篇将介绍在非 GitHub 生态系统中，我们如何生成和验证软件工件的来源，从而提高你的项目的 SLSA Level。Witness 是一个可插拔的软件供应链风险管理框架，它能自动、规范和验证软件工件出处。它是 in-toto 是 CNCF 下的项目之一。它的最初作者是 Testifysec，后来捐赠给了 in-toto。什么是 WitnessWitness 是一个可插拔的供应链安全框架，可创建整个软件开发生命周期（SDLC）的证据（Provenance）跟踪，确保软件从源代码到目标的完整性。它支持大多数主要的 CI 和基础架构提供商，是确保软件供应链安全的多功能、灵活的解决方案。安全 PKI (Public Key Infrastructure - 公钥基础设施)分发系统的使用和验证 Witness 元数据的能力进一步增强了流程的安全性，并有助于减少许多软件供应链攻击向量。Witness 的工作原理是封装在持续集成流程中执行的命令，为软件开发生命周期（SDLC）中的每个操作提供证据跟踪，这样就可以详细、可验证地记录软件是如何构建的、由谁构建以及使用了哪些工具。这些证据可用于评估政策合规性，检测任何潜在的篡改或恶意活动，并确保只有授权用户或机器才能完成流程中的某一步骤。总结 - Witness 可以做什么验证软件由谁构建、如何构建以及使用了哪些工具检测任何潜在的篡改或恶意活动确保只有经授权的用户或机器才能完成流程的每一步分发证词（Attestations）和策略（Policy）如何使用 Witness主要分三步：witness run - 运行提供的命令并记录有关执行的证词。witness sign - 使用提供的密钥签署提供的文件。witness verify - 验证 witness 策略。快速开始这是我创建的 Witness Demo 仓库用于演示 witness 的工作流程，具体可以根据如下步骤进行。","covers":null,"content":"<p>由于近些年针对软件的供应链的攻击越来越频繁，因此 Google 在 2021 提出的解决方案是软件工件供应链级别（Supply chain Levels for Software Artifacts，”SLSA”）</p>\n<p>本篇将介绍在<strong>非 GitHub</strong> 生态系统中，我们如何生成和验证软件工件的来源，从而提高你的项目的 SLSA Level。</p>\n<p>Witness 是一个可插拔的软件供应链风险管理框架，它能自动、规范和验证软件工件出处。它是 in-toto 是 <a href=\"https://www.cncf.io/projects/in-toto/\">CNCF</a> 下的项目之一。它的最初作者是 Testifysec，后来捐赠给了 <a href=\"https://in-toto.io/\">in-toto</a>。</p>\n<h2 id=\"什么是-Witness\"><a href=\"#什么是-Witness\" class=\"headerlink\" title=\"什么是 Witness\"></a>什么是 Witness</h2><p>Witness 是一个可插拔的供应链安全框架，可创建整个软件开发生命周期（SDLC）的证据（Provenance）跟踪，确保软件从源代码到目标的完整性。它支持大多数主要的 CI 和基础架构提供商，是确保软件供应链安全的多功能、灵活的解决方案。</p>\n<p>安全 PKI (Public Key Infrastructure - 公钥基础设施)分发系统的使用和验证 Witness 元数据的能力进一步增强了流程的安全性，并有助于减少许多软件供应链攻击向量。</p>\n<p>Witness 的工作原理是封装在持续集成流程中执行的命令，为软件开发生命周期（SDLC）中的每个操作提供证据跟踪，这样就可以详细、可验证地记录软件是如何构建的、由谁构建以及使用了哪些工具。</p>\n<p>这些证据可用于评估政策合规性，检测任何潜在的篡改或恶意活动，并确保只有授权用户或机器才能完成流程中的某一步骤。</p>\n<p>总结 - Witness 可以做什么</p>\n<ul>\n<li>验证软件由谁构建、如何构建以及使用了哪些工具</li>\n<li>检测任何潜在的篡改或恶意活动</li>\n<li>确保只有经授权的用户或机器才能完成流程的每一步</li>\n<li>分发证词（Attestations）和策略（Policy）</li>\n</ul>\n<h2 id=\"如何使用-Witness\"><a href=\"#如何使用-Witness\" class=\"headerlink\" title=\"如何使用 Witness\"></a>如何使用 Witness</h2><p>主要分三步：</p>\n<ol>\n<li><code>witness run</code> - 运行提供的命令并记录有关执行的证词。</li>\n<li><code>witness sign</code> - 使用提供的密钥签署提供的文件。</li>\n<li><code>witness verify</code> - 验证 witness 策略。</li>\n</ol>\n<h3 id=\"快速开始\"><a href=\"#快速开始\" class=\"headerlink\" title=\"快速开始\"></a>快速开始</h3><p>这是我创建的 <a href=\"https://github.com/shenxianpeng/witness-demo\">Witness Demo 仓库</a>用于演示 witness 的工作流程，具体可以根据如下步骤进行。</p>\n<span id=\"more\"></span>\n\n<h4 id=\"准备环境\"><a href=\"#准备环境\" class=\"headerlink\" title=\"准备环境\"></a>准备环境</h4><p>安装 witnesss，下载 demo 项目</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -s https://raw.githubusercontent.com/in-toto/witness/main/install-witness.sh)</span><br><span class=\"line\">Latest version of Witness is 0.1.14</span><br><span class=\"line\">Downloading <span class=\"keyword\">for</span> linux amd64 from https://github.com/in-toto/witness/releases/download/v0.1.14/witness_0.1.14_linux_amd64.tar.gz</span><br><span class=\"line\">expected checksum: f9b67ca04cb391cd854aec3397eb904392ff689dcd3c38305d38c444781a5a67</span><br><span class=\"line\">file checksum:     f9b67ca04cb391cd854aec3397eb904392ff689dcd3c38305d38c444781a5a67</span><br><span class=\"line\">witness v0.1.14-aa35c1f</span><br><span class=\"line\">Witness v0.1.14 has been installed at /usr/local/bin/witness</span><br><span class=\"line\"></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/shenxianpeng/witness-demo.git</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"创建钥匙对\"><a href=\"#创建钥匙对\" class=\"headerlink\" title=\"创建钥匙对\"></a>创建钥匙对</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">openssl genpkey -algorithm ed25519 -outform PEM -out witness-demo-key.pem</span><br><span class=\"line\">openssl pkey -<span class=\"keyword\">in</span> witness-demo-key.pem -pubout &gt; witness-demo-pub.pem</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"准备-Witness-配置文件-witness-yaml\"><a href=\"#准备-Witness-配置文件-witness-yaml\" class=\"headerlink\" title=\"准备 Witness 配置文件 .witness.yaml\"></a>准备 Witness 配置文件 <code>.witness.yaml</code></h3><figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">run:</span></span><br><span class=\"line\">    <span class=\"attr\">signer-file-key-path:</span> <span class=\"string\">witness-demo-key.pem</span></span><br><span class=\"line\">    <span class=\"attr\">trace:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">verify:</span></span><br><span class=\"line\">    <span class=\"attr\">attestations:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;witness-demo-att.json&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">policy:</span> <span class=\"string\">policy-signed.json</span></span><br><span class=\"line\">    <span class=\"attr\">publickey:</span> <span class=\"string\">witness-demo-pub.pem</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将构建步骤进入到证词（Attestation）中\"><a href=\"#将构建步骤进入到证词（Attestation）中\" class=\"headerlink\" title=\"将构建步骤进入到证词（Attestation）中\"></a>将构建步骤进入到证词（Attestation）中</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">witness run --step build -o witness-demo-att.json -- python3 -m pip wheel --no-deps -w dist .</span><br><span class=\"line\">INFO    Using config file: .witness.yaml</span><br><span class=\"line\">INFO    Starting environment attestor...</span><br><span class=\"line\">INFO    Starting git attestor...</span><br><span class=\"line\">INFO    Starting material attestor...</span><br><span class=\"line\">INFO    Starting command-run attestor...</span><br><span class=\"line\">Processing /tmp/witness-demo</span><br><span class=\"line\">Building wheels for collected packages: witness-demo</span><br><span class=\"line\">  Running setup.py bdist_wheel for witness-demo: started</span><br><span class=\"line\">  Running setup.py bdist_wheel for witness-demo: finished with status &#x27;done&#x27;</span><br><span class=\"line\">  Stored in directory: /tmp/witness-demo/dist</span><br><span class=\"line\">Successfully built witness-demo</span><br><span class=\"line\">INFO    Starting product attestor...</span><br></pre></td></tr></table></figure>\n\n<p>即在之前的 build command 中加入 <code>witness run</code> 的相关命令。</p>\n<h4 id=\"查看已签名的-Attestation-的验证数据\"><a href=\"#查看已签名的-Attestation-的验证数据\" class=\"headerlink\" title=\"查看已签名的 Attestation 的验证数据\"></a>查看已签名的 Attestation 的验证数据</h4><p>因为 Attestation 数据是进行的 base64 编码，因此需要解码进行查看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> witness-demo-att.json | jq -r .payload | <span class=\"built_in\">base64</span> -d | jq</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以下是部分输出</span></span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;https://witness.dev/attestations/command-run/v0.1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;attestation&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;cmd&quot;</span>: [</span><br><span class=\"line\">      <span class=\"string\">&quot;python3&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;-m&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;pip&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;wheel&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;--no-deps&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;-w&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;dist&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;.&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;stdout&quot;</span>: <span class=\"string\">&quot;Processing /tmp/witness-demo\\nBuilding wheels for collected packages: witness-demo\\n  Running setup.py bdist_wheel for witness-demo: started\\n  Running setup.py bdist_wheel for witness-demo: finished with status &#x27;done&#x27;\\n  Stored in directory: /tmp/witness-demo/dist\\nSuccessfully built witness-demo\\n&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;exitcode&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;starttime&quot;</span>: <span class=\"string\">&quot;2023-11-29T05:15:19.227943473-05:00&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;endtime&quot;</span>: <span class=\"string\">&quot;2023-11-29T05:15:20.078517025-05:00&quot;</span></span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;https://witness.dev/attestations/product/v0.1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;attestation&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;dist/witness_demo-1.0.0-py3-none-any.whl&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;mime_type&quot;</span>: <span class=\"string\">&quot;application/zip&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;digest&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;gitoid:sha1&quot;</span>: <span class=\"string\">&quot;gitoid:blob:sha1:b4b7210729998829c82208685837058f5ad614ab&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;gitoid:sha256&quot;</span>: <span class=\"string\">&quot;gitoid:blob:sha256:473a0f4c3be8a93681a267e3b1e9a7dcda1185436fe141f7749120a303721813&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;sha256&quot;</span>: <span class=\"string\">&quot;471985cd3b0d3e0101a1cbba8840819bfdc8d8f8cc19bd08add1e04be25b51ec&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;starttime&quot;</span>: <span class=\"string\">&quot;2023-11-29T05:15:20.078579187-05:00&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;endtime&quot;</span>: <span class=\"string\">&quot;2023-11-29T05:15:20.081170078-05:00&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"创建-Policy-文件\"><a href=\"#创建-Policy-文件\" class=\"headerlink\" title=\"创建 Policy 文件\"></a>创建 Policy 文件</h4><p><code>policy.json</code> 用来定义或要求一个步骤由具有特定属性或满足一些特殊的值，从而要求验证 Attestation 才能成功。比如这里的 <code>expires</code> 字段过期了即小于当前的时间，那么在执行 <code>witness verify</code> 的时候就会失败。</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;expires&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;2033-12-17T23:57:40-05:00&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;steps&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;build&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;build&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;attestations&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;https://witness.dev/attestations/material/v0.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;regopolicies&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;https://witness.dev/attestations/command-run/v0.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;regopolicies&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;https://witness.dev/attestations/product/v0.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;regopolicies&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;functionaries&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;publickeyid&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;&#123;&#123;PUBLIC_KEY_ID&#125;&#125;&quot;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">]</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;publickeys&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;&#123;&#123;PUBLIC_KEY_ID&#125;&#125;&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;keyid&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;&#123;&#123;PUBLIC_KEY_ID&#125;&#125;&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;key&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;&#123;&#123;B64_PUBLIC_KEY&#125;&#125;&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>更多关于 policy 的属性和设置可以参考这里：<a href=\"https://github.com/in-toto/witness/blob/main/docs/policy.md\">https://github.com/in-toto/witness/blob/main/docs/policy.md</a></p>\n<h3 id=\"给-Policy-文件做签名\"><a href=\"#给-Policy-文件做签名\" class=\"headerlink\" title=\"给 Policy 文件做签名\"></a>给 Policy 文件做签名</h3><p>在签名之前需要先替换到 Policy 文件的变量</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">id</span>=`<span class=\"built_in\">sha256sum</span> witness-demo-pub.pem | awk <span class=\"string\">&#x27;&#123;print $1&#125;&#x27;</span>` &amp;&amp; sed -i <span class=\"string\">&quot;s/&#123;&#123;PUBLIC_KEY_ID&#125;&#125;/<span class=\"variable\">$id</span>/g&quot;</span> policy.json</span><br><span class=\"line\"></span><br><span class=\"line\">pubb64=`<span class=\"built_in\">cat</span> witness-demo-pub.pem | <span class=\"built_in\">base64</span> -w 0` &amp;&amp; sed -i <span class=\"string\">&quot;s/&#123;&#123;B64_PUBLIC_KEY&#125;&#125;/<span class=\"variable\">$pubb64</span>/g&quot;</span> policy.json</span><br></pre></td></tr></table></figure>\n\n<p>然后使用 <code>witness sign</code> 来做签名</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">witness sign -f policy.json --signer-file-key-path witness-demo-key.pem --outfile policy-signed.json</span><br><span class=\"line\">INFO    Using config file: .witness.yaml</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"验证二进制文件是否符合政策要求\"><a href=\"#验证二进制文件是否符合政策要求\" class=\"headerlink\" title=\"验证二进制文件是否符合政策要求\"></a>验证二进制文件是否符合政策要求</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">witness verify -f dist/witness_demo-1.0.0-py3-none-any.whl -a witness-demo-att.json -p policy-signed.json -k witness-demo-pub.pem </span><br><span class=\"line\">INFO    Using config file: .witness.yaml             </span><br><span class=\"line\">INFO    Verification succeeded                       </span><br><span class=\"line\">INFO    Evidence:                                    </span><br><span class=\"line\">INFO    0: witness-demo-att.json </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>以上就是使用 witness 针对 Non-GitHub 项目的演示。</p>\n<p>如果你的项目代码是放在 GitHub 上的，目前最容易、最流行的方式就是使用 <a href=\"https://github.com/slsa-framework/slsa-github-generator\">slsa-github-generator</a> 一个由 <a href=\"https://github.com/slsa-framework\">SLSA Framework</a> 官方提供的工具，然后使用 <a href=\"https://github.com/slsa-framework/slsa-verifier\">slsa-verifier</a> 来验证 Provenance。具体可以参考我的上一篇文章 <a href=\"https://shenxianpeng.github.io/2023/11/python-and-slsa/\">Python 和 SLSA 💃</a></p>\n<hr>\n<p>转载本站文章请注明作者和出处，请勿用于任何商业用途。欢迎关注公众号「DevOps攻城狮」</p>\n","more":"<h4 id=\"准备环境\"><a href=\"#准备环境\" class=\"headerlink\" title=\"准备环境\"></a>准备环境</h4><p>安装 witnesss，下载 demo 项目</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -s https://raw.githubusercontent.com/in-toto/witness/main/install-witness.sh)</span><br><span class=\"line\">Latest version of Witness is 0.1.14</span><br><span class=\"line\">Downloading <span class=\"keyword\">for</span> linux amd64 from https://github.com/in-toto/witness/releases/download/v0.1.14/witness_0.1.14_linux_amd64.tar.gz</span><br><span class=\"line\">expected checksum: f9b67ca04cb391cd854aec3397eb904392ff689dcd3c38305d38c444781a5a67</span><br><span class=\"line\">file checksum:     f9b67ca04cb391cd854aec3397eb904392ff689dcd3c38305d38c444781a5a67</span><br><span class=\"line\">witness v0.1.14-aa35c1f</span><br><span class=\"line\">Witness v0.1.14 has been installed at /usr/local/bin/witness</span><br><span class=\"line\"></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/shenxianpeng/witness-demo.git</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"创建钥匙对\"><a href=\"#创建钥匙对\" class=\"headerlink\" title=\"创建钥匙对\"></a>创建钥匙对</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">openssl genpkey -algorithm ed25519 -outform PEM -out witness-demo-key.pem</span><br><span class=\"line\">openssl pkey -<span class=\"keyword\">in</span> witness-demo-key.pem -pubout &gt; witness-demo-pub.pem</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"准备-Witness-配置文件-witness-yaml\"><a href=\"#准备-Witness-配置文件-witness-yaml\" class=\"headerlink\" title=\"准备 Witness 配置文件 .witness.yaml\"></a>准备 Witness 配置文件 <code>.witness.yaml</code></h3><figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">run:</span></span><br><span class=\"line\">    <span class=\"attr\">signer-file-key-path:</span> <span class=\"string\">witness-demo-key.pem</span></span><br><span class=\"line\">    <span class=\"attr\">trace:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"attr\">verify:</span></span><br><span class=\"line\">    <span class=\"attr\">attestations:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;witness-demo-att.json&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">policy:</span> <span class=\"string\">policy-signed.json</span></span><br><span class=\"line\">    <span class=\"attr\">publickey:</span> <span class=\"string\">witness-demo-pub.pem</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将构建步骤进入到证词（Attestation）中\"><a href=\"#将构建步骤进入到证词（Attestation）中\" class=\"headerlink\" title=\"将构建步骤进入到证词（Attestation）中\"></a>将构建步骤进入到证词（Attestation）中</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">witness run --step build -o witness-demo-att.json -- python3 -m pip wheel --no-deps -w dist .</span><br><span class=\"line\">INFO    Using config file: .witness.yaml</span><br><span class=\"line\">INFO    Starting environment attestor...</span><br><span class=\"line\">INFO    Starting git attestor...</span><br><span class=\"line\">INFO    Starting material attestor...</span><br><span class=\"line\">INFO    Starting command-run attestor...</span><br><span class=\"line\">Processing /tmp/witness-demo</span><br><span class=\"line\">Building wheels for collected packages: witness-demo</span><br><span class=\"line\">  Running setup.py bdist_wheel for witness-demo: started</span><br><span class=\"line\">  Running setup.py bdist_wheel for witness-demo: finished with status &#x27;done&#x27;</span><br><span class=\"line\">  Stored in directory: /tmp/witness-demo/dist</span><br><span class=\"line\">Successfully built witness-demo</span><br><span class=\"line\">INFO    Starting product attestor...</span><br></pre></td></tr></table></figure>\n\n<p>即在之前的 build command 中加入 <code>witness run</code> 的相关命令。</p>\n<h4 id=\"查看已签名的-Attestation-的验证数据\"><a href=\"#查看已签名的-Attestation-的验证数据\" class=\"headerlink\" title=\"查看已签名的 Attestation 的验证数据\"></a>查看已签名的 Attestation 的验证数据</h4><p>因为 Attestation 数据是进行的 base64 编码，因此需要解码进行查看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> witness-demo-att.json | jq -r .payload | <span class=\"built_in\">base64</span> -d | jq</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以下是部分输出</span></span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;https://witness.dev/attestations/command-run/v0.1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;attestation&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;cmd&quot;</span>: [</span><br><span class=\"line\">      <span class=\"string\">&quot;python3&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;-m&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;pip&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;wheel&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;--no-deps&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;-w&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;dist&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;.&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;stdout&quot;</span>: <span class=\"string\">&quot;Processing /tmp/witness-demo\\nBuilding wheels for collected packages: witness-demo\\n  Running setup.py bdist_wheel for witness-demo: started\\n  Running setup.py bdist_wheel for witness-demo: finished with status &#x27;done&#x27;\\n  Stored in directory: /tmp/witness-demo/dist\\nSuccessfully built witness-demo\\n&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;exitcode&quot;</span>: 0</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;starttime&quot;</span>: <span class=\"string\">&quot;2023-11-29T05:15:19.227943473-05:00&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;endtime&quot;</span>: <span class=\"string\">&quot;2023-11-29T05:15:20.078517025-05:00&quot;</span></span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;https://witness.dev/attestations/product/v0.1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;attestation&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;dist/witness_demo-1.0.0-py3-none-any.whl&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;mime_type&quot;</span>: <span class=\"string\">&quot;application/zip&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;digest&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;gitoid:sha1&quot;</span>: <span class=\"string\">&quot;gitoid:blob:sha1:b4b7210729998829c82208685837058f5ad614ab&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;gitoid:sha256&quot;</span>: <span class=\"string\">&quot;gitoid:blob:sha256:473a0f4c3be8a93681a267e3b1e9a7dcda1185436fe141f7749120a303721813&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;sha256&quot;</span>: <span class=\"string\">&quot;471985cd3b0d3e0101a1cbba8840819bfdc8d8f8cc19bd08add1e04be25b51ec&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;starttime&quot;</span>: <span class=\"string\">&quot;2023-11-29T05:15:20.078579187-05:00&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;endtime&quot;</span>: <span class=\"string\">&quot;2023-11-29T05:15:20.081170078-05:00&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"创建-Policy-文件\"><a href=\"#创建-Policy-文件\" class=\"headerlink\" title=\"创建 Policy 文件\"></a>创建 Policy 文件</h4><p><code>policy.json</code> 用来定义或要求一个步骤由具有特定属性或满足一些特殊的值，从而要求验证 Attestation 才能成功。比如这里的 <code>expires</code> 字段过期了即小于当前的时间，那么在执行 <code>witness verify</code> 的时候就会失败。</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;expires&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;2033-12-17T23:57:40-05:00&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;steps&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;build&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;build&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;attestations&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;https://witness.dev/attestations/material/v0.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;regopolicies&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;https://witness.dev/attestations/command-run/v0.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;regopolicies&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;https://witness.dev/attestations/product/v0.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;regopolicies&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;functionaries&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;publickeyid&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;&#123;&#123;PUBLIC_KEY_ID&#125;&#125;&quot;</span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">]</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;publickeys&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;&#123;&#123;PUBLIC_KEY_ID&#125;&#125;&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;keyid&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;&#123;&#123;PUBLIC_KEY_ID&#125;&#125;&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;key&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;&#123;&#123;B64_PUBLIC_KEY&#125;&#125;&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>更多关于 policy 的属性和设置可以参考这里：<a href=\"https://github.com/in-toto/witness/blob/main/docs/policy.md\">https://github.com/in-toto/witness/blob/main/docs/policy.md</a></p>\n<h3 id=\"给-Policy-文件做签名\"><a href=\"#给-Policy-文件做签名\" class=\"headerlink\" title=\"给 Policy 文件做签名\"></a>给 Policy 文件做签名</h3><p>在签名之前需要先替换到 Policy 文件的变量</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">id</span>=`<span class=\"built_in\">sha256sum</span> witness-demo-pub.pem | awk <span class=\"string\">&#x27;&#123;print $1&#125;&#x27;</span>` &amp;&amp; sed -i <span class=\"string\">&quot;s/&#123;&#123;PUBLIC_KEY_ID&#125;&#125;/<span class=\"variable\">$id</span>/g&quot;</span> policy.json</span><br><span class=\"line\"></span><br><span class=\"line\">pubb64=`<span class=\"built_in\">cat</span> witness-demo-pub.pem | <span class=\"built_in\">base64</span> -w 0` &amp;&amp; sed -i <span class=\"string\">&quot;s/&#123;&#123;B64_PUBLIC_KEY&#125;&#125;/<span class=\"variable\">$pubb64</span>/g&quot;</span> policy.json</span><br></pre></td></tr></table></figure>\n\n<p>然后使用 <code>witness sign</code> 来做签名</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">witness sign -f policy.json --signer-file-key-path witness-demo-key.pem --outfile policy-signed.json</span><br><span class=\"line\">INFO    Using config file: .witness.yaml</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"验证二进制文件是否符合政策要求\"><a href=\"#验证二进制文件是否符合政策要求\" class=\"headerlink\" title=\"验证二进制文件是否符合政策要求\"></a>验证二进制文件是否符合政策要求</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">witness verify -f dist/witness_demo-1.0.0-py3-none-any.whl -a witness-demo-att.json -p policy-signed.json -k witness-demo-pub.pem </span><br><span class=\"line\">INFO    Using config file: .witness.yaml             </span><br><span class=\"line\">INFO    Verification succeeded                       </span><br><span class=\"line\">INFO    Evidence:                                    </span><br><span class=\"line\">INFO    0: witness-demo-att.json </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>以上就是使用 witness 针对 Non-GitHub 项目的演示。</p>\n<p>如果你的项目代码是放在 GitHub 上的，目前最容易、最流行的方式就是使用 <a href=\"https://github.com/slsa-framework/slsa-github-generator\">slsa-github-generator</a> 一个由 <a href=\"https://github.com/slsa-framework\">SLSA Framework</a> 官方提供的工具，然后使用 <a href=\"https://github.com/slsa-framework/slsa-verifier\">slsa-verifier</a> 来验证 Provenance。具体可以参考我的上一篇文章 <a href=\"https://shenxianpeng.github.io/2023/11/python-and-slsa/\">Python 和 SLSA 💃</a></p>\n<hr>\n<p>转载本站文章请注明作者和出处，请勿用于任何商业用途。欢迎关注公众号「DevOps攻城狮」</p>","categories":[{"name":"DevSecOps","path":"api/categories/DevSecOps.json"}],"tags":[{"name":"SLSA","path":"api/tags/SLSA.json"},{"name":"Witness","path":"api/tags/Witness.json"}]}