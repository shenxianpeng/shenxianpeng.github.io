{"title":"Ansible 实践（一）","slug":"2020/10/ansible-practice1","date":"2020-10-28T02:09:41.000Z","updated":"2021-06-28T16:07:49.212Z","comments":true,"path":"api/articles/2020/10/ansible-practice1.json","excerpt":"最近在思考如何将团队里的所有的虚拟机都很好的管理并监控起来，但是由于我们的虚拟机的操作系统繁多，包括 Windows, Linux, AIX, HP-UX, Solaris SPARC 和 Solaris x86. 到底选择哪种方式来管理比较好呢？这需要结合具体场景来考虑。选择合适的工具仅管理 Windows 和 Linux如果你的虚拟机没有这么多平台，只是 Windows 和 Linux，假如你已经有了 VMware vSphere 来管理了，那么可以通过 VMware vSphere API 来查看这些机器的状态。这里是 VMware 官方的 API Library 供使用：VMware vSphere API Python BindingsGo library for the VMware vSphere API管理多个操作系统如果你和我的情况一下，想监控很多个操作操作系统，那么就只能通过 ssh 来登录到每一台机器上去查看，比如执行 uptime 等命令。可以写 shell 脚本来完成这些登录、检测等操作。另外就是使用 Ansible 的 Playbook。Playbook 里描述了你要做的操作，这是一个权衡，学习 Ansible 的 Playbook 需要花些时间的。如果想了解下 Ansible 那么可以试试 Ansible Playbook。以下是我使用 Ansible 做了一些练习。Playbook结构1<br>2<br>3<br>4<br>5<br>+- vars<br>|   +- vars.yml<br>|   +- ...<br>+- hosts               # save all hosts you want to monitor<br>+- run.yml             # ansible executable file<br>Playbook具体代码","covers":null,"content":"<p>最近在思考如何将团队里的所有的虚拟机都很好的管理并监控起来，但是由于我们的虚拟机的操作系统繁多，包括 Windows, Linux, AIX, HP-UX, Solaris SPARC 和 Solaris x86. 到底选择哪种方式来管理比较好呢？这需要结合具体场景来考虑。</p>\n<h2 id=\"选择合适的工具\"><a href=\"#选择合适的工具\" class=\"headerlink\" title=\"选择合适的工具\"></a>选择合适的工具</h2><h3 id=\"仅管理-Windows-和-Linux\"><a href=\"#仅管理-Windows-和-Linux\" class=\"headerlink\" title=\"仅管理 Windows 和 Linux\"></a>仅管理 Windows 和 Linux</h3><p>如果你的虚拟机没有这么多平台，只是 Windows 和 Linux，假如你已经有了 VMware vSphere 来管理了，那么可以通过 VMware vSphere API 来查看这些机器的状态。</p>\n<p>这里是 VMware 官方的 API Library 供使用：</p>\n<ul>\n<li><a href=\"https://github.com/vmware/pyvmomi\" target=\"_blank\" rel=\"noopener\">VMware vSphere API Python Bindings</a></li>\n<li><a href=\"https://github.com/vmware/govmomi\" target=\"_blank\" rel=\"noopener\">Go library for the VMware vSphere API</a></li>\n</ul>\n<h3 id=\"管理多个操作系统\"><a href=\"#管理多个操作系统\" class=\"headerlink\" title=\"管理多个操作系统\"></a>管理多个操作系统</h3><p>如果你和我的情况一下，想监控很多个操作操作系统，那么就只能通过 ssh 来登录到每一台机器上去查看，比如执行 <code>uptime</code> 等命令。可以写 shell 脚本来完成这些登录、检测等操作。</p>\n<p>另外就是使用 Ansible 的 Playbook。Playbook 里描述了你要做的操作，这是一个权衡，学习 Ansible 的 Playbook 需要花些时间的。</p>\n<p>如果想了解下 Ansible 那么可以试试 Ansible Playbook。以下是我使用 Ansible 做了一些练习。</p>\n<h4 id=\"Playbook结构\"><a href=\"#Playbook结构\" class=\"headerlink\" title=\"Playbook结构\"></a>Playbook结构</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+- vars</span><br><span class=\"line\">|   +- vars.yml</span><br><span class=\"line\">|   +- ...</span><br><span class=\"line\">+- hosts               <span class=\"comment\"># save all hosts you want to monitor</span></span><br><span class=\"line\">+- run.yml             <span class=\"comment\"># ansible executable file</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Playbook具体代码\"><a href=\"#Playbook具体代码\" class=\"headerlink\" title=\"Playbook具体代码\"></a>Playbook具体代码</h4><a id=\"more\"></a>\n\n<p>vars/vars.yml</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># system</span></span><br><span class=\"line\"><span class=\"attr\">ip:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_default_ipv4['address'] &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">host_name:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_hostname &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">os:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_distribution &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_distribution_version &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">total_mb:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_memtotal_mb &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">vcpus:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_processor_vcpus &#125;&#125;</span>\"</span></span><br></pre></td></tr></table></figure>\n\n<p>hosts</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[unix-vm]</span></span><br><span class=\"line\"><span class=\"string\">aix</span> <span class=\"string\">ansible_host=walbld01.dev.company.com</span> <span class=\"string\">ansible_user=test</span> <span class=\"string\">ansible_become_pass=test</span></span><br><span class=\"line\"><span class=\"string\">hp-ux</span>  <span class=\"string\">ansible_host=walbld04.dev.company.com</span> <span class=\"string\">ansible_user=test</span> <span class=\"string\">ansible_become_pass=test</span></span><br><span class=\"line\"><span class=\"string\">linux</span> <span class=\"string\">ansible_host=walbld05.dev.company.com</span> <span class=\"string\">ansible_user=test</span> <span class=\"string\">ansible_become_pass=test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[win-vm]</span></span><br><span class=\"line\"><span class=\"string\">win-bld02</span> <span class=\"string\">ansible_host=walbld02.dev.company.com</span> <span class=\"string\">ansible_user=Administrator</span> <span class=\"string\">ansible_password=admin</span> <span class=\"string\">ansible_port=5985</span> <span class=\"string\">ansible_connection=winrm</span> <span class=\"string\">ansible_winrm_server_cert_validation=ignore</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[other-vm]</span></span><br><span class=\"line\"><span class=\"string\">solaris</span> <span class=\"string\">ansible_host=walbld07.dev.company.com</span> <span class=\"string\">ansible_user=test</span> <span class=\"string\">ansible_become_pass=test</span></span><br><span class=\"line\"><span class=\"string\">win-udb03</span> <span class=\"string\">ansible_host=walbld03.dev.company.com</span> <span class=\"string\">ansible_user=administrator</span> <span class=\"string\">ansible_become_pass=admin</span></span><br></pre></td></tr></table></figure>\n\n<p>run.yml</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># this playbook is simple test</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">\"get unix build machine info\"</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> <span class=\"string\">unix-vm</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">get</span> <span class=\"string\">uname,</span> <span class=\"string\">hostname</span> <span class=\"string\">and</span> <span class=\"string\">uptime</span></span><br><span class=\"line\">    <span class=\"attr\">shell:</span> <span class=\"string\">\"uname &amp;&amp; hostname &amp;&amp; uptime\"</span></span><br><span class=\"line\">    <span class=\"attr\">register:</span> <span class=\"string\">output</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">var=output['stdout_lines']</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">\"get windows build machine os info\"</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> <span class=\"string\">win-vm</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">var=hostvars['win-bld02'].ansible_facts.hostname</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">var=hostvars['win-bld02'].ansible_distribution</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"如何执行\"><a href=\"#如何执行\" class=\"headerlink\" title=\"如何执行\"></a>如何执行</h4><p>首先需要安装了 ansible，然后执行</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># run with playbook</span></span><br><span class=\"line\">ansible-playbook -i hosts run.yml</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>注：上面的代码是脱敏过的，不保证能一次性运行成功 :)</p>\n</blockquote>\n","more":"<p>vars/vars.yml</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># system</span></span><br><span class=\"line\"><span class=\"attr\">ip:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_default_ipv4['address'] &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">host_name:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_hostname &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">os:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_distribution &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_distribution_version &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">total_mb:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_memtotal_mb &#125;&#125;</span>\"</span></span><br><span class=\"line\"><span class=\"attr\">vcpus:</span> <span class=\"string\">\"<span class=\"template-variable\">&#123;&#123; ansible_processor_vcpus &#125;&#125;</span>\"</span></span><br></pre></td></tr></table></figure>\n\n<p>hosts</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">[unix-vm]</span></span><br><span class=\"line\"><span class=\"string\">aix</span> <span class=\"string\">ansible_host=walbld01.dev.company.com</span> <span class=\"string\">ansible_user=test</span> <span class=\"string\">ansible_become_pass=test</span></span><br><span class=\"line\"><span class=\"string\">hp-ux</span>  <span class=\"string\">ansible_host=walbld04.dev.company.com</span> <span class=\"string\">ansible_user=test</span> <span class=\"string\">ansible_become_pass=test</span></span><br><span class=\"line\"><span class=\"string\">linux</span> <span class=\"string\">ansible_host=walbld05.dev.company.com</span> <span class=\"string\">ansible_user=test</span> <span class=\"string\">ansible_become_pass=test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[win-vm]</span></span><br><span class=\"line\"><span class=\"string\">win-bld02</span> <span class=\"string\">ansible_host=walbld02.dev.company.com</span> <span class=\"string\">ansible_user=Administrator</span> <span class=\"string\">ansible_password=admin</span> <span class=\"string\">ansible_port=5985</span> <span class=\"string\">ansible_connection=winrm</span> <span class=\"string\">ansible_winrm_server_cert_validation=ignore</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">[other-vm]</span></span><br><span class=\"line\"><span class=\"string\">solaris</span> <span class=\"string\">ansible_host=walbld07.dev.company.com</span> <span class=\"string\">ansible_user=test</span> <span class=\"string\">ansible_become_pass=test</span></span><br><span class=\"line\"><span class=\"string\">win-udb03</span> <span class=\"string\">ansible_host=walbld03.dev.company.com</span> <span class=\"string\">ansible_user=administrator</span> <span class=\"string\">ansible_become_pass=admin</span></span><br></pre></td></tr></table></figure>\n\n<p>run.yml</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># this playbook is simple test</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">\"get unix build machine info\"</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> <span class=\"string\">unix-vm</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">get</span> <span class=\"string\">uname,</span> <span class=\"string\">hostname</span> <span class=\"string\">and</span> <span class=\"string\">uptime</span></span><br><span class=\"line\">    <span class=\"attr\">shell:</span> <span class=\"string\">\"uname &amp;&amp; hostname &amp;&amp; uptime\"</span></span><br><span class=\"line\">    <span class=\"attr\">register:</span> <span class=\"string\">output</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">var=output['stdout_lines']</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">\"get windows build machine os info\"</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> <span class=\"string\">win-vm</span></span><br><span class=\"line\">  <span class=\"attr\">gather_facts:</span> <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">var=hostvars['win-bld02'].ansible_facts.hostname</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">debug:</span> <span class=\"string\">var=hostvars['win-bld02'].ansible_distribution</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"如何执行\"><a href=\"#如何执行\" class=\"headerlink\" title=\"如何执行\"></a>如何执行</h4><p>首先需要安装了 ansible，然后执行</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># run with playbook</span></span><br><span class=\"line\">ansible-playbook -i hosts run.yml</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>注：上面的代码是脱敏过的，不保证能一次性运行成功 :)</p>\n</blockquote>","categories":[{"name":"DevOps","path":"api/categories/DevOps.json"}],"tags":[{"name":"Ansible","path":"api/tags/Ansible.json"}]}