<!doctype html><html lang=zh-cn dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>你一定要了解这 17 条 Docker 最佳实践！ &#183; DevOps 攻城狮</title><meta name=title content="你一定要了解这 17 条 Docker 最佳实践！ &#183; DevOps 攻城狮"><meta name=description content="本文分享了在编写 Dockerfiles 和使用 Docker 时应遵循的一些最佳实践，包括多阶段构建、镜像优化、安全性等方面的建议。"><meta name=keywords content="Dokerfile,Docker,"><link rel=canonical href=https://shenxianpeng.github.io/posts/2022/docker-best-practice/><link type=text/css rel=stylesheet href=/css/main.bundle.min.d7672814413dccdcf76c504d9b0ebb8d0f964dbe6b30a3d4b25b15809a94c2eb732d99898aded2009aacdd1fa8b17cea1369fd81560790cd355aee00bbd142fd.css integrity="sha512-12coFEE9zNz3bFBNmw67jQ+WTb5rMKPUslsVgJqUwutzLZmJit7SAJqs3R+osXzqE2n9gVYHkM01Wu4Au9FC/Q=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.98bb8ce8f123e03c4d2171eeec151dd404b5c476beb5ef1068d0e8b1a2afb923065e6552fc14b2d867c85ee4bd8529a43193f729f874d3908517ba03b5d1cc57.js integrity="sha512-mLuM6PEj4DxNIXHu7BUd1AS1xHa+te8QaNDosaKvuSMGXmVS/BSy2GfIXuS9hSmkMZP3Kfh005CFF7oDtdHMVw==" data-copy=复制 data-copied=已复制></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=google-site-verification content="2E2Cl6XpgMYdmYe_jdwSrs6XdeFCzHgFhOBisOn9hbs"><meta property="og:url" content="https://shenxianpeng.github.io/posts/2022/docker-best-practice/"><meta property="og:site_name" content="DevOps 攻城狮"><meta property="og:title" content="你一定要了解这 17 条 Docker 最佳实践！"><meta property="og:description" content="本文分享了在编写 Dockerfiles 和使用 Docker 时应遵循的一些最佳实践，包括多阶段构建、镜像优化、安全性等方面的建议。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-12T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-12T00:00:00+00:00"><meta property="article:tag" content="Dokerfile"><meta property="article:tag" content="Docker"><meta property="og:image" content="https://shenxianpeng.github.io/posts/2022/docker-best-practice/featured.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://shenxianpeng.github.io/posts/2022/docker-best-practice/featured.png"><meta name=twitter:title content="你一定要了解这 17 条 Docker 最佳实践！"><meta name=twitter:description content="本文分享了在编写 Dockerfiles 和使用 Docker 时应遵循的一些最佳实践，包括多阶段构建、镜像优化、安全性等方面的建议。"><meta name=twitter:image content="https://shenxianpeng.github.io/posts/2022/docker-best-practice/featured.png"><meta property="og:image" content="https://shenxianpeng.github.io/posts/2022/docker-best-practice/featured.png"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"你一定要了解这 17 条 Docker 最佳实践！","headline":"你一定要了解这 17 条 Docker 最佳实践！","abstract":"本文分享了在编写 Dockerfiles 和使用 Docker 时应遵循的一些最佳实践，包括多阶段构建、镜像优化、安全性等方面的建议。","inLanguage":"zh-cn","url":"https:\/\/shenxianpeng.github.io\/posts\/2022\/docker-best-practice\/","author":{"@type":"Person","name":"沈显鹏"},"copyrightYear":"2022","dateCreated":"2022-01-12T00:00:00\u002b00:00","datePublished":"2022-01-12T00:00:00\u002b00:00","dateModified":"2022-01-12T00:00:00\u002b00:00","keywords":["Dokerfile","Docker"],"mainEntityOfPage":"true","wordCount":"8494"}]</script><meta name=author content="沈显鹏"><link href=index.xml rel=me><link href=https://github.com/shenxianpeng rel=me><link href=https://www.linkedin.com/in/xianpeng-shen/ rel=me><link href=https://medium.com/@xianpeng.shen/ rel=me><link href=https://dev.to/shenxianpeng rel=me><link href=https://www.youtube.com/@shenxianpeng rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LDW3BHJTTW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LDW3BHJTTW")</script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>
跳过正文</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px] z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">DevOps 攻城狮</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=关于>关于</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Posts>文章</p></a><a href=/misc/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Miscs>码农随笔</p></a><a href=/hireme/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=沈显鹏的简历>聘用我</p></a><a href=/portfolio/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Portfolios>作品</p></a><a href=/archive/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=文章归档>归档</p></a><a href=https://x.com/xianpengshen target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span><p class="text-base font-medium" title></p></a><a href=https://github.com/shenxianpeng target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><p class="text-base font-medium" title></p></a><div><div class="cursor-pointer flex items-center nested-menu"><span class="ltr:mr-1 rtl:ml-1"><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span></span><div class="text-sm font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="你一定要了解这 17 条 Docker 最佳实践！">简体中文</div></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/en/posts/2022/docker-best-practice/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="You Must Know These 17 Docker Best Practices!">English</p></a><a href=/posts/2022/docker-best-practice/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="你一定要了解这 17 条 Docker 最佳实践！">简体中文</p></a></div></div></div></div><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="搜索 (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span><div><div class="cursor-pointer flex items-center nested-menu"><span class="ltr:mr-1 rtl:ml-1"><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span></span><div class="text-sm font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="你一定要了解这 17 条 Docker 最佳实践！">简体中文</div></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/en/posts/2022/docker-best-practice/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="You Must Know These 17 Docker Best Practices!">English</p></a><a href=/posts/2022/docker-best-practice/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="你一定要了解这 17 条 Docker 最佳实践！">简体中文</p></a></div></div></div></div><button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="搜索 (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=关于>关于</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Posts>文章</p></a></li><li class=mt-1><a href=/misc/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Miscs>码农随笔</p></a></li><li class=mt-1><a href=/hireme/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=沈显鹏的简历>聘用我</p></a></li><li class=mt-1><a href=/portfolio/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Portfolios>作品</p></a></li><li class=mt-1><a href=/archive/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=文章归档>归档</p></a></li><li class=mt-1><a href=https://x.com/xianpengshen target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></div><p class="text-bg font-bg" title></p></a></li><li class=mt-1><a href=https://github.com/shenxianpeng target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></div><p class="text-bg font-bg" title></p></a></li></ul></div></div></div></div><script>(function(){var e=$(".main-menu"),t=window.location.pathname;e.find('a[href="'+t+'"]').each(function(e,t){$(t).children("p").addClass("active")})})()</script></div></div><script type=text/javascript src=/js/background-blur.min.0ad33cb9c066f652728b2cc09c9ceaf32645544f48e8b6b38f120d86f433ed997da275a49e6151fe0176430c45376812708d84727f3f969101fb44a4345b3f34.js integrity="sha512-CtM8ucBm9lJyiyzAnJzq8yZFVE9I6LazjxINhvQz7Zl9onWknmFR/gF2QwxFN2gScI2Ecn8/lpEB+0SkNFs/NA==" data-target-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/></a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Posts</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/2022/docker-best-practice/>你一定要了解这 17 条 Docker 最佳实践！</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">你一定要了解这 17 条 Docker 最佳实践！</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2022-01-12T00:00:00+00:00>2022-01-12</time><span class="px-2 text-primary-500">&#183;</span><span>8494 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>17 分钟</span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/shenxianpeng/blog/tree/main/content/posts/2022/docker-best-practice/index.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title=编辑内容><span class="inline-block align-text-bottom"><span class="relative block icon"><svg height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M441 58.9 453.1 71c9.4 9.4 9.4 24.6.0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9.0zM209.8 256.2 344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1L186.9 325l16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25 175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 1e2c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l1e2-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7.0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4.0 152V424c0 48.6 39.4 88 88 88H360c48.6.0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1.0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H2e2c13.3.0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></span></span></a>
</span><span class="px-2 text-primary-500">&#183;</span>
<script type=text/javascript src=/js/zen-mode.min.9814dee9614d32aeb56239d118edfe20acd6231424f9b19c2dd48835038414130a5e946c0d1c9087d60e60e31840c9babfd217e3d4b95643dc8d651a71ccdf4a.js integrity="sha512-mBTe6WFNMq61YjnRGO3+IKzWIxQk+bGcLdSINQOEFBMKXpRsDRyQh9YOYOMYQMm6v9IX49S5VkPcjWUacczfSg=="></script><span class=mb-[2px]><span id=zen-mode-button class="text-lg hover:text-primary-500" title=啟用阅读模式 data-title-i18n-disable=啟用阅读模式 data-title-i18n-enable=停用阅读模式><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentColor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div class="flex flex-row flex-wrap items-center"><a href=/authors/shenxianpeng/ class=relative>沈显鹏</a></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/dokerfile/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Dokerfile
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/docker/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Docker</span></span></a></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt=沈显鹏 src=/img/sxp_hu_e622561bc4524c0d.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">沈显鹏</div><div class="text-sm text-neutral-700 dark:text-neutral-400">DevOps & Build 工程师 | Python 爱好者 | 开源贡献者</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:xianpeng.shen@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=index.xml target=_blank aria-label=Rss rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span></span></a>
<a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/shenxianpeng target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.linkedin.com/in/xianpeng-shen/ target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://medium.com/@xianpeng.shen/ target=_blank aria-label=Medium rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M180.5 74.262C80.813 74.262.0 155.633.0 256S80.819 437.738 180.5 437.738 361 356.373 361 256 280.191 74.262 180.5 74.262zm288.25 10.646c-49.845.0-90.245 76.619-90.245 171.095s40.406 171.1 90.251 171.1 90.251-76.619 90.251-171.1H559C559 161.5 518.6 84.908 468.752 84.908zm139.506 17.821c-17.526.0-31.735 68.628-31.735 153.274s14.2 153.274 31.735 153.274S640 340.631 640 256c0-84.649-14.215-153.271-31.742-153.271z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://dev.to/shenxianpeng target=_blank aria-label=Dev rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88.0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59.0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21.0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44.0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44.0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.youtube.com/@shenxianpeng target=_blank aria-label=Youtube rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#文章目录>文章目录</a></li><li><a href=#dockerfile-最佳实践>Dockerfile 最佳实践</a><ul><li><a href=#1-使用多阶段的构建>1. 使用多阶段的构建</a></li><li><a href=#2-调整-dockerfile-命令的顺序>2. 调整 Dockerfile 命令的顺序</a></li><li><a href=#3-使用小型-docker-基础镜像>3. 使用小型 Docker 基础镜像</a></li><li><a href=#4-尽量减少层的数量>4. 尽量减少层的数量</a><ul><li><a href=#注意>注意</a></li><li><a href=#提示>提示</a></li></ul></li><li><a href=#5-使用无特权的容器>5. 使用无特权的容器</a></li><li><a href=#6-优先选择-copy-而不是-add>6. 优先选择 <code>COPY</code> 而不是 <code>ADD</code></a></li><li><a href=#7-缓存安装包到-docker-主机上>7. 缓存安装包到 Docker 主机上</a></li><li><a href=#8-每个容器只运行一个进程>8. 每个容器只运行一个进程</a></li><li><a href=#9-优先选择数组而不是字符串语法>9. 优先选择数组而不是字符串语法</a><ul><li><a href=#10-了解-entrypoint-和-cmd-之间的区别>10. 了解 <code>ENTRYPOINT</code> 和 <code>CMD</code> 之间的区别</a></li></ul></li><li><a href=#11-添加健康检查-healthcheck>11. 添加健康检查 <code>HEALTHCHECK</code></a></li></ul></li><li><a href=#docker-镜像最佳实践>Docker 镜像最佳实践</a><ul><li><a href=#1-docker-镜像版本>1. Docker 镜像版本</a></li><li><a href=#2-不要在镜像中存储机密信息>2. 不要在镜像中存储机密信息</a><ul><li><a href=#环境变量>环境变量</a></li><li><a href=#构建时参数>构建时参数</a></li><li><a href=#docker-密钥>Docker 密钥</a></li></ul></li><li><a href=#3-使用-dockerignore-文件>3. 使用 .dockerignore 文件</a></li><li><a href=#4-检查并扫描你的-dockerfile-和镜像>4. 检查并扫描你的 Dockerfile 和镜像</a></li><li><a href=#5-签名和验证镜像>5. 签名和验证镜像</a></li><li><a href=#6-设置内存和-cpu-的限制>6. 设置内存和 CPU 的限制</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#文章目录>文章目录</a></li><li><a href=#dockerfile-最佳实践>Dockerfile 最佳实践</a><ul><li><a href=#1-使用多阶段的构建>1. 使用多阶段的构建</a></li><li><a href=#2-调整-dockerfile-命令的顺序>2. 调整 Dockerfile 命令的顺序</a></li><li><a href=#3-使用小型-docker-基础镜像>3. 使用小型 Docker 基础镜像</a></li><li><a href=#4-尽量减少层的数量>4. 尽量减少层的数量</a><ul><li><a href=#注意>注意</a></li><li><a href=#提示>提示</a></li></ul></li><li><a href=#5-使用无特权的容器>5. 使用无特权的容器</a></li><li><a href=#6-优先选择-copy-而不是-add>6. 优先选择 <code>COPY</code> 而不是 <code>ADD</code></a></li><li><a href=#7-缓存安装包到-docker-主机上>7. 缓存安装包到 Docker 主机上</a></li><li><a href=#8-每个容器只运行一个进程>8. 每个容器只运行一个进程</a></li><li><a href=#9-优先选择数组而不是字符串语法>9. 优先选择数组而不是字符串语法</a><ul><li><a href=#10-了解-entrypoint-和-cmd-之间的区别>10. 了解 <code>ENTRYPOINT</code> 和 <code>CMD</code> 之间的区别</a></li></ul></li><li><a href=#11-添加健康检查-healthcheck>11. 添加健康检查 <code>HEALTHCHECK</code></a></li></ul></li><li><a href=#docker-镜像最佳实践>Docker 镜像最佳实践</a><ul><li><a href=#1-docker-镜像版本>1. Docker 镜像版本</a></li><li><a href=#2-不要在镜像中存储机密信息>2. 不要在镜像中存储机密信息</a><ul><li><a href=#环境变量>环境变量</a></li><li><a href=#构建时参数>构建时参数</a></li><li><a href=#docker-密钥>Docker 密钥</a></li></ul></li><li><a href=#3-使用-dockerignore-文件>3. 使用 .dockerignore 文件</a></li><li><a href=#4-检查并扫描你的-dockerfile-和镜像>4. 检查并扫描你的 Dockerfile 和镜像</a></li><li><a href=#5-签名和验证镜像>5. 签名和验证镜像</a></li><li><a href=#6-设置内存和-cpu-的限制>6. 设置内存和 CPU 的限制</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></details><script>(function(){"use strict";const n=.33,s="#TableOfContents",o=".anchor",i='a[href^="#"]',a="li ul",r="active";function c(e,t){const s=window.scrollY+window.innerHeight*t,o=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],n=new Set(o.map(e=>e.getAttribute("href").substring(1)));for(let t=e.length-1;t>=0;t--){const o=e[t].getBoundingClientRect().top+window.scrollY;if(o<=s&&n.has(e[t].id))return e[t].id}return e.find(e=>n.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=c(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(r,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function t(){const t=document.querySelector(s);if(!t)return;const c=!1,l=[...document.querySelectorAll(o)],d=[...t.querySelectorAll(i)];c&&t.querySelectorAll(a).forEach(e=>e.style.display="none");const r={toc:t,anchors:l,links:d,scrollOffset:n,collapseInactive:c};window.addEventListener("scroll",()=>e(r),{passive:!0}),window.addEventListener("hashchange",()=>e(r),{passive:!0}),e(r)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>本篇分享在编写 Dockerfiles 和使用 Docker 时应遵循的一些最佳实践。篇幅较长，建议先收藏慢慢看，保证看完会很有收获。</p><h2 class="relative group">文章目录<div id=文章目录 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#%e6%96%87%e7%ab%a0%e7%9b%ae%e5%bd%95 aria-label=锚点>#</a></span></h2><p>Dockerfile 最佳实践</p><ol><li>使用多阶段的构建</li><li>调整 Dockerfile 命令的顺序</li><li>使用小型 Docker 基础镜像</li><li>尽量减少层的数量</li><li>使用无特权的容器</li><li>优先选择 <code>COPY</code> 而不是 <code>ADD</code></li><li>将 <code>Python</code> 包缓存到 Docker 主机上</li><li>每个容器只运行一个进程</li><li>优先选择数组而不是字符串语法</li><li>理解 <code>ENTRYPOINT</code> 和 <code>CMD</code> 之间的区别</li><li>添加健康检查 <code>HEALTHCHECK</code></li></ol><p>Docker 镜像最佳实践</p><ol><li>Docker 镜像的版本</li><li>不要在镜像中存储密钥</li><li>使用 <code>.dockerignore</code> 文件</li><li>检查和扫描你的 Docker 文件和镜像</li><li>签署和验证镜像</li></ol><h2 class="relative group">Dockerfile 最佳实践<div id=dockerfile-最佳实践 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#dockerfile-%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label=锚点>#</a></span></h2><h3 class="relative group">1. 使用多阶段的构建<div id=1-使用多阶段的构建 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#1-%e4%bd%bf%e7%94%a8%e5%a4%9a%e9%98%b6%e6%ae%b5%e7%9a%84%e6%9e%84%e5%bb%ba aria-label=锚点>#</a></span></h3><p>利用多阶段构建的优势来创建更精简、更安全的Docker镜像。多阶段 Docker 构建(<a href=https://docs.docker.com/develop/develop-images/multistage-build/ target=_blank>multi-stage builds</a>)允许你将你的 Dockerfile 分成几个阶段。</p><p>例如，你可以有一个阶段用于编译和构建你的应用程序，然后可以复制到后续阶段。由于只有最后一个阶段被用来创建镜像，与构建应用程序相关的依赖关系和工具就会被丢弃，因此可以留下一个精简的、模块化的、可用于生产的镜像。</p><p>Web 开发示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=c># 临时阶段</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> python:3.9-slim as builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    apt-get install -y --no-install-recommends gcc<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip wheel --no-cache-dir --no-deps --wheel-dir /app/wheels -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 最终阶段</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> python:3.9-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /app/wheels /wheels<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /app/requirements.txt .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install --no-cache /wheels/*<span class=err>
</span></span></span></code></pre></div><p>在这个例子中，GCC 编译器在安装某些 Python 包时是必需的，所以我们添加了一个临时的、构建时的阶段来处理构建阶段。</p><p>由于最终的运行时映像不包含 GCC，所以它更轻，也更安全。镜像大小比较：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>REPOSITORY                 TAG                    IMAGE ID       CREATED          SIZE
</span></span><span class=line><span class=cl>docker-single              latest                 8d6b6a4d7fb6   <span class=m>16</span> seconds ago   259MB
</span></span><span class=line><span class=cl>docker-multi               latest                 813c2fa9b114   <span class=m>3</span> minutes ago    156MB
</span></span></code></pre></div><p>再来看一个例子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=c># 临时阶段</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> python:3.9 as builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip wheel --no-cache-dir --no-deps --wheel-dir /wheels jupyter pandas<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 最终阶段</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> python:3.9-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /notebooks</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /wheels /wheels<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install --no-cache /wheels/*<span class=err>
</span></span></span></code></pre></div><p>镜像大小比较：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>REPOSITORY                  TAG                   IMAGE ID       CREATED         SIZE
</span></span><span class=line><span class=cl>ds-multi                    latest                b4195deac742   <span class=m>2</span> minutes ago   357MB
</span></span><span class=line><span class=cl>ds-single                   latest                7c23c43aeda6   <span class=m>6</span> minutes ago   969MB
</span></span></code></pre></div><p>总之，多阶段构建可以减少你的生产镜像的大小，帮助你节省时间和金钱。此外，这将简化你的生产容器。由于尺寸较小和简单，相对会有较小的攻击面。</p><h3 class="relative group">2. 调整 Dockerfile 命令的顺序<div id=2-调整-dockerfile-命令的顺序 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#2-%e8%b0%83%e6%95%b4-dockerfile-%e5%91%bd%e4%bb%a4%e7%9a%84%e9%a1%ba%e5%ba%8f aria-label=锚点>#</a></span></h3><p>密切注意你的 Dockerfile 命令的顺序，以利用层缓存。</p><p>Docker 在一个特定的 Docker 文件中缓存每个步骤（或层），以加快后续的构建。当一个步骤发生变化时，不仅该步骤，而且所有后续步骤的缓存都将被废止。</p><p>例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.9-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> sample.py .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install -r /requirements.txt<span class=err>
</span></span></span></code></pre></div><p>在这个 Dockerfile 中，我们在安装需求之前复制了应用程序的代码。现在，每次我们改变 sample.py 时，构建都会重新安装软件包。这是非常低效的，特别是在使用 Docker 容器作为开发环境时。因此，把经常变化的文件放在 Dockerfile 的末尾是很关键的。</p><blockquote><p>你也可以通过使用 .dockerignore 文件来排除不必要的文件，使其不被添加到 Docker 构建环境和最终镜像中，从而帮助防止不必要的缓存失效。更多信息后面会提到。</p></blockquote><p>因此，在上面的 Dockerfile 中，你应该把 <code>COPY sample.py .</code> 命令移到底部，如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.9-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install -r /requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> sample.py .<span class=err>
</span></span></span></code></pre></div><p>注意。</p><ol><li>总是把可能发生变化的层放在 Dockerfile 中尽可能的低。</li><li>将多个 <code>RUN apt-get update</code>，<code>RUN apt-get install</code> 等命令结合到一起执行。(这也有助于减少镜像的大小，后面会很快就会提到这一点)。</li><li>如果你想关闭某个 Docker 构建的缓存，可以添加 <code>--no-cache=True</code> 标志。</li></ol><h3 class="relative group">3. 使用小型 Docker 基础镜像<div id=3-使用小型-docker-基础镜像 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#3-%e4%bd%bf%e7%94%a8%e5%b0%8f%e5%9e%8b-docker-%e5%9f%ba%e7%a1%80%e9%95%9c%e5%83%8f aria-label=锚点>#</a></span></h3><p>较小的 Docker 镜像更具有模块化和安全性。较小的 Docker 基础镜像在构建、推送和拉动镜像的速度较小，它们也往往更安全，因为它们只包括运行应用程序所需的必要库和系统依赖。</p><p>你应该使用哪个 Docker 基础镜像？这个没有一个固定的答案，它这取决于你要做什么。下面是 Python 的各种 Docker 基础镜像的大小比较。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>REPOSITORY   TAG                 IMAGE ID       CREATED      SIZE
</span></span><span class=line><span class=cl>python       3.9.6-alpine3.14    f773016f760e   <span class=m>3</span> days ago   45.1MB
</span></span><span class=line><span class=cl>python       3.9.6-slim          907fc13ca8e7   <span class=m>3</span> days ago   115MB
</span></span><span class=line><span class=cl>python       3.9.6-slim-buster   907fc13ca8e7   <span class=m>3</span> days ago   115MB
</span></span><span class=line><span class=cl>python       3.9.6               cba42c28d9b8   <span class=m>3</span> days ago   886MB
</span></span><span class=line><span class=cl>python       3.9.6-buster        cba42c28d9b8   <span class=m>3</span> days ago   886MB
</span></span></code></pre></div><p>虽然基于 Alpine Linux 的 Alpine flavor 是最小的，但如果你找不到可以与之配合的编译二进制文件，往往会导致构建时间的增加。因此，你最终可能不得不自己构建二进制文件，这可能会增加镜像的大小（取决于所需的系统级依赖）和构建时间（由于必须从源头编译）。</p><blockquote><p>关于为什么最好不要使用基于 Alpine 的基础镜像，请参考<a href=https://pythonspeed.com/articles/base-image-python-docker-images/ target=_blank>适用于 Python 应用程序的最佳 Docker 基础映像</a> 和 <a href=https://pythonspeed.com/articles/alpine-docker-python/ target=_blank>使用 Alpine 可以使 Python Docker 构建速度慢 50 倍</a> 了解更多关于为什么最好避免使用基于 Alpine 的基础镜像。</p></blockquote><p>归根结底，这都是关于平衡的问题。如果有疑问，从 <code>*-slim</code> flavor 开始，特别是在开发模式下，因为你正在构建你的应用程序。你想避免在添加新的 <code>Python</code> 包时不得不不断地更新 Dockerfile 以安装必要的系统级依赖。当你为生产强化你的应用程序和 Dockerfile 时，你可能想探索使用 Alpine 来完成多阶段构建的最终镜像。</p><p>另外，别忘了定期更新你的基础镜像，以提高安全性和性能。当一个基础镜像的新版本发布时，例如：<code>3.9.6-slim</code> &ndash;> <code>3.9.7-slim</code>，你应该拉出新的镜像并更新你正在运行的容器以获得所有最新的安全补丁。</p><h3 class="relative group">4. 尽量减少层的数量<div id=4-尽量减少层的数量 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#4-%e5%b0%bd%e9%87%8f%e5%87%8f%e5%b0%91%e5%b1%82%e7%9a%84%e6%95%b0%e9%87%8f aria-label=锚点>#</a></span></h3><p>尽量把 <code>RUN</code>、<code>COPY</code> 和 <code>ADD</code> 命令结合起来使用，因为它们会创建层。每一层都会增加镜像的大小，因为它们是被缓存的。因此，随着层数的增加，镜像大小也会增加。</p><p>你可以用 <code>docker history</code> 命令来测试一下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker images
</span></span><span class=line><span class=cl>REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
</span></span><span class=line><span class=cl>dockerfile   latest    180f98132d02   <span class=m>51</span> seconds ago   259MB
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker <span class=nb>history</span> 180f98132d02
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>IMAGE          CREATED              CREATED BY                                      SIZE      COMMENT
</span></span><span class=line><span class=cl>180f98132d02   <span class=m>58</span> seconds ago       COPY . . <span class=c1># buildkit                             6.71kB    buildkit.dockerfile.v0</span>
</span></span><span class=line><span class=cl>&lt;missing&gt;      <span class=m>58</span> seconds ago       RUN /bin/sh -c pip install -r requirements.t…   35.5MB    buildkit.dockerfile.v0
</span></span><span class=line><span class=cl>&lt;missing&gt;      About a minute ago   COPY requirements.txt . <span class=c1># buildkit              58B       buildkit.dockerfile.v0</span>
</span></span><span class=line><span class=cl>&lt;missing&gt;      About a minute ago   WORKDIR /app
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>请注意尺寸。只有 <code>RUN</code>、<code>COPY</code> 和 <code>ADD</code> 命令增加了镜像的尺寸，你可以尽可能地通过合并命令来减少镜像的大小。比如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>RUN</span> apt-get update<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get install -y gcc<span class=err>
</span></span></span></code></pre></div><p>可以合并成一个 <code>RUN</code> 命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y gcc<span class=err>
</span></span></span></code></pre></div><p>因此，创建一个单层而不是两个，这就减少了最终镜像的大小。虽然减少层数是个好主意，但更重要的是，这本身不是一个目标，而是减少镜像大小和构建时间的一个副作用。换句话说呢，与其试图优化每一条命令，你更应该关注前面的三种做法！！！</p><ol><li>多阶段构建</li><li>Dockerfile命令的顺序</li><li>以及使用一个小的基础镜像。</li></ol><h4 class="relative group">注意<div id=注意 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#%e6%b3%a8%e6%84%8f aria-label=锚点>#</a></span></h4><ol><li><code>RUN</code>、<code>COPY</code> 和 <code>ADD</code> 都会创建图层</li><li>每个图层都包含与前一个图层的差异</li><li>图层会增加最终镜像的大小</li></ol><h4 class="relative group">提示<div id=提示 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#%e6%8f%90%e7%a4%ba aria-label=锚点>#</a></span></h4><ol><li>合并相关命令</li><li>在创建过程中执行 <code>RUN</code> 步骤中删除不必要的文件</li><li>尽量减少运行 <code>apt-get upgrade</code> 的次数，因为它将所有软件包升级到最新版本。</li><li>对于多阶段的构建，不要太担心过度优化临时阶段的命令</li></ol><p>最后，为了便于阅读，建议将多行参数按字母数字排序。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    git <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    gcc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    matplotlib <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    pillow  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span class=err>
</span></span></span></code></pre></div><h3 class="relative group">5. 使用无特权的容器<div id=5-使用无特权的容器 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#5-%e4%bd%bf%e7%94%a8%e6%97%a0%e7%89%b9%e6%9d%83%e7%9a%84%e5%ae%b9%e5%99%a8 aria-label=锚点>#</a></span></h3><p>默认情况下，Docker 在容器内以 root 身份运行容器进程。然而，这是一个糟糕的做法，因为在容器内以 root 身份运行的进程在 Docker 主机中也是以 root 身份运行。</p><p>因此，如果攻击者获得了对容器的访问权，他们就可以获得所有的 root 权限，并可以对 Docker 主机进行一些攻击，例如：</p><ol><li>将敏感信息从主机的文件系统复制到容器中</li><li>执行远程命令</li></ol><p>为了防止这种情况，确保以非 root 用户运行容器进程。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>RUN</span> addgroup --system app <span class=o>&amp;&amp;</span> adduser --system --group app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span></code></pre></div><p>你可以更进一步，删除 shell 权限，确保没有主目录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>RUN</span> addgroup --gid <span class=m>1001</span> --system app <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    adduser --no-create-home --shell /bin/false --disabled-password --uid <span class=m>1001</span> --system --group app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span></code></pre></div><p>验证</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -i sample id
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1001<span class=o>(</span>app<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1001<span class=o>(</span>app<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1001<span class=o>(</span>app<span class=o>)</span>
</span></span></code></pre></div><p>在这里，容器内的应用程序在一个非 root 用户下运行。然而，请记住，Docker 守护进程和容器本身仍然是以 root 权限运行的。</p><p>请务必查看以非根用户身份运行 Docker 守护进程，以获得以非根用户身份运行守护进程和容器的帮助。</p><h3 class="relative group">6. 优先选择 <code>COPY</code> 而不是 <code>ADD</code><div id=6-优先选择-copy-而不是-add class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#6-%e4%bc%98%e5%85%88%e9%80%89%e6%8b%a9-copy-%e8%80%8c%e4%b8%8d%e6%98%af-add aria-label=锚点>#</a></span></h3><p>除非你确定你需要 <code>ADD</code> 所带来的额外功能，否则请使用 <code>COPY</code>。</p><p>那么 <code>COPY</code> 和 <code>ADD</code> 的区别是什么？</p><p>首先，这两个命令都允许你从一个特定的位置复制文件到 Docker 镜像中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ADD</span> &lt;src&gt; &lt;dest&gt;<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> &lt;src&gt; &lt;dest&gt;<span class=err>
</span></span></span></code></pre></div><p>虽然它们看起来作用相同，但 <code>ADD</code> 有一些额外的功能。</p><ul><li><code>COPY</code> 用于将本地文件或目录从 Docker 主机复制到镜像上。</li><li><code>ADD</code> 可以用于同样的事情，也可以用于下载外部文件。另外，如果你使用压缩文件（tar、gzip、bzip2等）作为 <src>参数，<code>ADD</code> 会自动将内容解压到指定位置。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 将主机上的本地文件复制到目的地</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> /source/path  /destination/path<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ADD</span> /source/path  /destination/path<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 下载外部文件并复制到目的地</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ADD</span> http://external.file/url  /destination/path<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 复制和提取本地压缩文件</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ADD</span> source.file.tar.gz /destination/path<span class=err>
</span></span></span></code></pre></div><p>最后 <code>COPY</code> 在语义上比 <code>ADD</code> 更加明确和更容易理解。</p><h3 class="relative group">7. 缓存安装包到 Docker 主机上<div id=7-缓存安装包到-docker-主机上 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#7-%e7%bc%93%e5%ad%98%e5%ae%89%e8%a3%85%e5%8c%85%e5%88%b0-docker-%e4%b8%bb%e6%9c%ba%e4%b8%8a aria-label=锚点>#</a></span></h3><p>当一个需求文件被改变时，镜像需要被重建以安装新的包。先前的步骤将被缓存，正如在最小化层数中提到的。在重建镜像时下载所有的包会导致大量的网络活动，并需要大量的时间。每次重建都要占用同等的时间来下载不同构建中的通用包。</p><p>以 Python 为例，你可以通过将 pip 缓存目录映射到主机上的一个目录来避免这种情况。所以对于每次重建，缓存的版本会持续存在，这可以提高构建速度。</p><p>在 Docker 运行中添加一个卷，作为 <code>-v $HOME/.cache/pip-docker/:/root/.cache/pip</code> 或者作为 Docker Compose 文件中的映射。</p><p>上面介绍的目录只供参考，要确保你映射的是 cache 目录，而不是 site-packages（内置包所在的位置）。</p><p>将缓存从 docker 镜像中移到主机上可以为你节省最终镜像的空间。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 忽略 ...</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>cache,target<span class=o>=</span>/root/.cache/pip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        pip install -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 忽略 ...</span><span class=err>
</span></span></span></code></pre></div><h3 class="relative group">8. 每个容器只运行一个进程<div id=8-每个容器只运行一个进程 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#8-%e6%af%8f%e4%b8%aa%e5%ae%b9%e5%99%a8%e5%8f%aa%e8%bf%90%e8%a1%8c%e4%b8%80%e4%b8%aa%e8%bf%9b%e7%a8%8b aria-label=锚点>#</a></span></h3><p>为什么建议每个容器只运行一个进程？</p><p>让我们假设你的应用程序栈由两个 Web 服务器和一个数据库组成。虽然你可以很容易地从一个容器中运行所有三个，但你应该在一个单独的容器中运行每个服务，以便更容易重复使用和扩展每个单独的服务。</p><ul><li>扩展性 - 由于每个服务都在一个单独的容器中，你可以根据需要水平地扩展你的一个网络服务器来处理更多的流量。</li><li>可重用性 - 也许你有另一个服务需要一个容器化的数据库，你可以简单地重复使用同一个数据库容器，而不需要带着两个不必要的服务。</li><li>日志 - 耦合容器会让日志变得更加复杂。（我们将在本文后面进一步详细讨论这个问题）</li><li>可移植性和可预测性 - 当容器有较少的部分在工作时，制作安全补丁或调试问题就会容易得多。</li></ul><h3 class="relative group">9. 优先选择数组而不是字符串语法<div id=9-优先选择数组而不是字符串语法 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#9-%e4%bc%98%e5%85%88%e9%80%89%e6%8b%a9%e6%95%b0%e7%bb%84%e8%80%8c%e4%b8%8d%e6%98%af%e5%ad%97%e7%ac%a6%e4%b8%b2%e8%af%ad%e6%b3%95 aria-label=锚点>#</a></span></h3><p>你可以在你的 Dockerfiles 中以数组（exec）或字符串（shell）格式</p><p>在 Dockerfile 中，你可以以数组（exec）或字符串（shell）格式来使用 <code>CMD</code> 和 <code>ENTRYPOINT</code> 命令</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 数组（exec）</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;gunicorn&#34;</span><span class=p>,</span> <span class=s2>&#34;-w&#34;</span><span class=p>,</span> <span class=s2>&#34;4&#34;</span><span class=p>,</span> <span class=s2>&#34;-k&#34;</span><span class=p>,</span> <span class=s2>&#34;uvicorn.workers.UvicornWorker&#34;</span><span class=p>,</span> <span class=s2>&#34;main:app&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 字符串（shell）</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=s2>&#34;gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app&#34;</span><span class=err>
</span></span></span></code></pre></div><p>两者都是正确的，并且实现了几乎相同的事情；但是，你应该尽可能地使用 exec 格式。</p><p>以下来自 <a href=https://docs.docker.com/compose/faq/#why-do-my-services-take-10-seconds-to-recreate-or-stop target=_blank>Docker的官方文档</a>内容：</p><ul><li>确保你在 Dockerfile 中使用 <code>CMD</code> 和 <code>ENTRYPOINT</code> 的 exec 形式。</li><li>例如，使用 <code>["program", "arg1", "arg2"]</code> 而不是 <code>"program arg1 arg2"</code>。使用字符串形式会导致 Docker 使用 <code>bash</code> 运行你的进程，而 <code>bash</code> 并不能正确处理信号。Compose 总是使用 JSON 形式，所以不用担心如果你在你的 Compose 文件中覆盖了命令或入口。</li></ul><p>因此，由于大多数 shell 不处理对子进程的信号，如果你使用 shell 格式，CTRL-C（产生 <code>SIGTERM</code>）可能不会停止一个子进程。</p><p>例子:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ubuntu:18.04</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># BAD: 字符串（shell）格式</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> top -d<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># GOOD: 数组（exec）格式</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;top&#34;</span><span class=p>,</span> <span class=s2>&#34;-d&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><p>这两种情况执行效果一样。但请注意，在字符串（shell）格式的情况下，<code>CTRL-C</code> 不会杀死这个进程。相反，你会看到 <code>^C^C^C^C^C^C^C^C^C^C</code>。</p><p>另一个注意事项是，字符串（shell）格式携带的是 shell 的 PID，而不是进程本身。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 数组格式</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>root@18d8fd3fd4d2:/app# ps ax<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  PID TTY      STAT   TIME COMMAND<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=m>1</span> ?        Ss     0:00 python manage.py runserver 0.0.0.0:8000<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=m>7</span> ?        Sl     0:02 /usr/local/bin/python manage.py runserver 0.0.0.0:8000<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>   <span class=m>25</span> pts/0    Ss     0:00 bash<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=m>356</span> pts/0    R+     0:00 ps ax<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 字符串格式</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>root@ede24a5ef536:/app# ps ax<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  PID TTY      STAT   TIME COMMAND<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=m>1</span> ?        Ss     0:00 /bin/sh -c python manage.py runserver 0.0.0.0:8000<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=m>8</span> ?        S      0:00 python manage.py runserver 0.0.0.0:8000<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=m>9</span> ?        Sl     0:01 /usr/local/bin/python manage.py runserver 0.0.0.0:8000<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>   <span class=m>13</span> pts/0    Ss     0:00 bash<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=m>342</span> pts/0    R+     0:00 ps ax<span class=err>
</span></span></span></code></pre></div><h4 class="relative group">10. 了解 <code>ENTRYPOINT</code> 和 <code>CMD</code> 之间的区别<div id=10-了解-entrypoint-和-cmd-之间的区别 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#10-%e4%ba%86%e8%a7%a3-entrypoint-%e5%92%8c-cmd-%e4%b9%8b%e9%97%b4%e7%9a%84%e5%8c%ba%e5%88%ab aria-label=锚点>#</a></span></h4><p>我应该使用 <code>ENTRYPOINT</code> 还是 <code>CMD</code> 来运行容器进程？有两种方法可以在容器中运行命令。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;gunicorn&#34;</span><span class=p>,</span> <span class=s2>&#34;config.wsgi&#34;</span><span class=p>,</span> <span class=s2>&#34;-b&#34;</span><span class=p>,</span> <span class=s2>&#34;0.0.0.0:8000&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 和</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;gunicorn&#34;</span><span class=p>,</span> <span class=s2>&#34;config.wsgi&#34;</span><span class=p>,</span> <span class=s2>&#34;-b&#34;</span><span class=p>,</span> <span class=s2>&#34;0.0.0.0:8000&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><p>两者本质上做的是同一件事：用 <code>Gunicorn</code> 服务器在 <code>config.wsgi</code> 启动应用程序，并将其绑定到 <code>0.0.0.0:8000</code>。</p><p><code>CMD</code> 很容易被重写。如果你运行 <code>docker run &lt;image_name> uvicorn config.asgi</code>，上述 <code>CMD</code> 就会被新的参数所取代。</p><p>例如，<code>uvicorn config.asgi</code>。而要覆盖 <code>ENTRYPOINT</code> 命令，必须指定 <code>--entrypoint</code> 选项。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --entrypoint uvicorn config.asgi &lt;image_name&gt;
</span></span></code></pre></div><p>在这里，很明显，我们正在覆盖入口点。所以，建议使用 <code>ENTRYPOINT</code> 而不是 <code>CMD</code>，以防止意外地覆盖命令。</p><p>它们也可以一起使用。比如说</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;gunicorn&#34;</span><span class=p>,</span> <span class=s2>&#34;config.wsgi&#34;</span><span class=p>,</span> <span class=s2>&#34;-w&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;4&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><p>当像这样一起使用时，为启动容器所运行的命令就变成了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>gunicorn config.wsgi -w <span class=m>4</span>
</span></span></code></pre></div><p>如上所述，<code>CMD</code> 很容易被重写。因此，<code>CMD</code> 可以被用来向 <code>ENTRYPOINT</code> 命令传递参数。比如很容易更改 workers 的数量，就像这样：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run &lt;image_name&gt; <span class=m>6</span>
</span></span></code></pre></div><p>这样就将有 6 个 Gunicorn workers 启动容器，而不是默认的 4 个。</p><h3 class="relative group">11. 添加健康检查 <code>HEALTHCHECK</code><div id=11-添加健康检查-healthcheck class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#11-%e6%b7%bb%e5%8a%a0%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5-healthcheck aria-label=锚点>#</a></span></h3><p>使用 <code>HEALTHCHECK</code> 来确定容器中运行的进程是否不仅已启动并正在运行，而且是“健康”的。</p><p>Docker 公开了一个 API 来检查容器中运行的进程的状态，它提供的信息不仅仅是进程是否“正在运行”，因为“运行”涵盖了“它正在运行”、“仍在启动”、甚至“陷入某种无限循环错误状态”。你可以通过 <a href=https://docs.docker.com/engine/reference/builder/#healthcheck target=_blank><code>HEALTHCHECK</code></a> 指令与此 API 交互。</p><p>例如，如果你正在提供 Web 应用程序，则可以使用以下内容来确定 <code>/</code> 端点是否已启动并可以处理服务请求：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>HEALTHCHECK</span> CMD curl --fail http://localhost:8000 <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span><span class=err>
</span></span></span></code></pre></div><p>如果你运行 <code>docker ps</code>，你可以看到 <code>HEALTHCHECK</code> 的状态。</p><p>健康的示例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>CONTAINER ID   IMAGE         COMMAND                  CREATED          STATUS                            PORTS                                       NAMES
</span></span><span class=line><span class=cl>09c2eb4970d4   healthcheck   <span class=s2>&#34;python manage.py ru…&#34;</span>   <span class=m>10</span> seconds ago   Up <span class=m>8</span> seconds <span class=o>(</span>health: starting<span class=o>)</span>   0.0.0.0:8000-&gt;8000/tcp, :::8000-&gt;8000/tcp   xenodochial_clarke
</span></span></code></pre></div><p>不健康的示例</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>CONTAINER ID   IMAGE         COMMAND                  CREATED              STATUS                          PORTS                                       NAMES
</span></span><span class=line><span class=cl>09c2eb4970d4   healthcheck   <span class=s2>&#34;python manage.py ru…&#34;</span>   About a minute ago   Up About a minute <span class=o>(</span>unhealthy<span class=o>)</span>   0.0.0.0:8000-&gt;8000/tcp, :::8000-&gt;8000/tcp   xenodochial_clarke
</span></span></code></pre></div><p>你可以更进一步，设置一个仅用于健康检查的自定义端点，然后配置 <code>HEALTHCHECK</code> 以针对返回的数据进行测试。</p><p>例如，如果端点返回 <code>{"ping": "pong"}</code> 的 JSON 响应，你可以指示 <code>HEALTHCHECK</code> 验证响应正文。</p><p>以下是使用 <code>docker inspect</code> 查看运行状况检查状态的方法：</p><blockquote><p>这里省略了部分输出。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>❯ docker inspect --format <span class=s2>&#34;{{json .State.Health }}&#34;</span> ab94f2ac7889
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;Status&#34;</span>: <span class=s2>&#34;healthy&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;FailingStreak&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;Log&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Start&#34;</span>: <span class=s2>&#34;2021-09-28T15:22:57.5764644Z&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;End&#34;</span>: <span class=s2>&#34;2021-09-28T15:22:57.7825527Z&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;ExitCode&#34;</span>: 0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;Output&#34;</span>: <span class=s2>&#34;...&#34;</span>
</span></span></code></pre></div><p>你还可以向 Docker Compose 文件添加运行状况检查：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.8&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;8000:8000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=l>curl --fail http://localhost:8000 || exit 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre></div><p>选项：</p><ul><li><code>test</code>：要测试的命令。</li><li><code>interval</code>：要测试的间隔 - 即，测试每 x 时间单位。</li><li><code>timeout</code>：等待响应的最长时间。</li><li><code>start_period</code>：何时开始健康检查。它可以在容器准备就绪之前执行其他任务时使用，例如运行迁移。</li><li><code>retries</code>：在将测试指定为失败之前的最大重试次数。</li></ul><p>如果你使用的是 Docker Swarm 以外的编排工具（比如 Kubernetes 或 AWS ECS），它们很可能有自己的内部系统来处理健康检查。在添加 <code>HEALTHCHECK</code> 指令之前，请参阅特定工具的文档。</p><h2 class="relative group">Docker 镜像最佳实践<div id=docker-镜像最佳实践 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#docker-%e9%95%9c%e5%83%8f%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label=锚点>#</a></span></h2><h3 class="relative group">1. Docker 镜像版本<div id=1-docker-镜像版本 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#1-docker-%e9%95%9c%e5%83%8f%e7%89%88%e6%9c%ac aria-label=锚点>#</a></span></h3><p>只要有可能，就要避免使用 <code>latest</code> 标签的镜像。</p><p>如果你依赖 <code>latest</code> 标签（这并不是一个真正的 &ldquo;标签&rdquo;，因为当镜像没有明确的标签时，它是默认应用的），你无法根据镜像标签来判断你的代码正在运行哪个版本。</p><p>如果你想回滚就变得很困难，并且很容易被覆盖（无论是意外还是恶意的）。标签，就像你的基础设施和部署，应该是不可改变的。</p><p>所以无论你如何对待你的内部镜像，都不应该对基本镜像使用 <code>latest</code> 标签，因为你可能会无意中把一个带有破坏性变化的新版本部署到生产中。</p><p>对于内部镜像，应使用描述性的标签，以便更容易分辨哪个版本的代码正在运行，处理回滚，并避免命名冲突。例如，你可以使用以下描述符来组成一个标签。</p><ol><li>时间戳</li><li>Docker 镜像 ID</li><li>Git 提交哈希值</li><li>语义版本 (Semantic version)</li></ol><p>关于更多的选择，也可以参考 Stack Overflow <a href=https://stackoverflow.com/a/56213290/1799408 target=_blank>问题</a> &ldquo;Properly Versioning Docker Images&rdquo; 中的这个答案。</p><p>比如说</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build -t web-prod-b25a262-1.0.0 .
</span></span></code></pre></div><p>在这里，我们用下面的内容来形成标签</p><ol><li>项目名称：web</li><li>环境名称: prod</li><li>Git commit short hash: b25a262 (通过命令 <code>git rev-parse --short HEAD</code> 来获得)</li><li>语义学版本：1.0.0</li></ol><p>选择一个标签方案并与之保持一致是至关重要的。由于提交哈希值（commit hashes）可以很容易地将镜像标签与代码联系起来，建议将它们纳入你的标签方案。</p><h3 class="relative group">2. 不要在镜像中存储机密信息<div id=2-不要在镜像中存储机密信息 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#2-%e4%b8%8d%e8%a6%81%e5%9c%a8%e9%95%9c%e5%83%8f%e4%b8%ad%e5%ad%98%e5%82%a8%e6%9c%ba%e5%af%86%e4%bf%a1%e6%81%af aria-label=锚点>#</a></span></h3><p>Secrets 是敏感的信息，如密码、数据库凭证、SSH密钥、令牌和 TLS 证书等。这些信息不应该在没有加密的情况下被放入你的镜像中，因为未经授权的用户如果获得了镜像的访问权，只需要检查这些层就可以提取密钥。</p><p>因此不要在 Docker 文件中添加明文的密钥，尤其是当你把镜像推送到像 Docker Hub 这样的公共仓库！！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.9-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> DATABASE_PASSWORD <span class=s2>&#34;SuperSecretSauce&#34;</span><span class=err>
</span></span></span></code></pre></div><p>相反，它们应该通过以下方式注入</p><ol><li>环境变量（在运行时)</li><li>构建时参数（在构建时)</li><li>协调工具，如 Docker Swarm（通过 Docker secrets）或 Kubernetes（通过 Kubernetes secrets）。</li></ol><p>此外，你还可以通过在你的 <code>.dockerignore</code> 文件中添加常见的密钥文件和文件夹来帮助防止密钥的泄露。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>**/.env
</span></span><span class=line><span class=cl>**/.aws
</span></span><span class=line><span class=cl>**/.ssh
</span></span></code></pre></div><p>最后，要明确哪些文件会被复制到镜像中，而不是递归地复制所有文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 不好的做法</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 好的做法</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./app.py .<span class=err>
</span></span></span></code></pre></div><p>明确的做法也有助于限制缓存的破坏。</p><h4 class="relative group">环境变量<div id=环境变量 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f aria-label=锚点>#</a></span></h4><p>你可以通过环境变量来传递密钥，但它们会在所有子进程、链接的容器和日志以及 <code>docker inspect</code> 中可见。要更新它们也很困难。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --detach --env <span class=s2>&#34;DATABASE_PASSWORD=SuperSecretSauce&#34;</span> python：3.9-slim
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>b25a262f870eb0fdbf03c666e7fcf18f9664314b79ad58bc7618ea3445e39239
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker inspect --format<span class=o>=</span><span class=s1>&#39;{{range .Config.Env}}{{println .}}{{end}}&#39;</span> b25a262f870eb0fdbf03c666e7fcf18f9664314b79ad58bc7618ea3445e39239
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_PASSWORD</span><span class=o>=</span>SuperSecretSauce
</span></span><span class=line><span class=cl><span class=nv>PATH</span><span class=o>=</span>/usr/local/bin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span class=line><span class=cl><span class=nv>LANG</span><span class=o>=</span>C.UTF-8
</span></span><span class=line><span class=cl><span class=nv>GPG_KEY</span><span class=o>=</span>E3FF2839C048B25C084DEBE9B26995E310250568
</span></span><span class=line><span class=cl><span class=nv>python_version</span><span class=o>=</span>3.9.7
</span></span><span class=line><span class=cl><span class=nv>python_pip_version</span><span class=o>=</span>21.2.4
</span></span><span class=line><span class=cl><span class=nv>python_setuptools_version</span><span class=o>=</span>57.5.0
</span></span><span class=line><span class=cl><span class=nv>python_get_pip_url</span><span class=o>=</span>https://github.com/pypa/get-pip/raw/c20b0cfd643cd4a19246ccf204e2997af70f6b21/public/get-pip.py
</span></span><span class=line><span class=cl><span class=nv>PYTHON_GET_PIP_SHA256</span><span class=o>=</span>fa6f3fb93cce234cd4e8dd2beb54a51ab9c247653b52855a48dd44e6b21ff28b
</span></span></code></pre></div><p>这是最直接的密钥管理方法。虽然它不是最安全的，但它会让诚实的人保持诚实，因为它提供了一个薄薄的保护层，有助于使密钥不被好奇的游荡的眼睛发现。</p><p>使用共享卷传递密钥是一个更好的解决方案，但它们应该被加密，通过 Vault 或 AWS密钥管理服务（KMS），因为它们被保存到磁盘。</p><h4 class="relative group">构建时参数<div id=构建时参数 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#%e6%9e%84%e5%bb%ba%e6%97%b6%e5%8f%82%e6%95%b0 aria-label=锚点>#</a></span></h4><p>你可以在构建时使用构建时参数来传递密钥，但这些密钥对于那些可以通过 docker 历史访问镜像的人来说是可见的。</p><p>例子</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> python:3.9-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> DATABASE_PASSWORD<span class=err>
</span></span></span></code></pre></div><p>构建</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build --build-arg <span class=s2>&#34;DATABASE_PASSWORD=SuperSecretSauce&#34;</span> .
</span></span></code></pre></div><p>如果你只需要临时使用密钥作为构建的一部分。例如，用于克隆私有 repo 或下载私有软件包的 SSH 密钥。你应该使用多阶段构建，因为构建者的历史会被临时阶段忽略。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 临时阶段</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> python:3.9-slim as builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 密钥参数</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>arg</span> ssh_private_key<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 安装 git</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> （运行 apt-get update）。<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    apt-get install -y --no-install-recommends git<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 使用 ssh 密钥来克隆 repo</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir -p /root/.ssh/ <span class=o>&amp;&amp;</span> <span class=se>\\</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PRIVATE_SSH_KEY</span><span class=si>}</span><span class=s2>&#34;</span> &gt; /root/.ssh/id_rsa<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> touch /root/.ssh/known_hosts <span class=p>&amp;</span> <span class=p>&amp;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    ssh-keyscan bitbucket.org &gt;&gt; /root/.ssh/known_hosts<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> git clone git@github.com:testdrivenio/not-real.git<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 最后阶段</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> python:3.9-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>工作目录 /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 从临时镜像中复制版本库</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /your-repo /app/your-repo<span class=err>
</span></span></span></code></pre></div><p>多阶段构建只保留了最终镜像的历史。你可以把这个功能用于你的应用程序需要的永久密钥，比如数据库凭证。</p><p>你也可以使用 docker build 中新的 <code>--secret</code> 选项来向 Docker 镜像传递密钥，这些密钥不会被存储在镜像中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># &#34;docker_is_awesome&#34; &gt; secrets.txt</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> alpine</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 从默认的密钥位置显示密钥。</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>secret,id<span class=o>=</span>mysecret cat /run/secrets/mysecret<span class=err>
</span></span></span></code></pre></div><p>这将装载 <code>secrets.txt</code> 文件中的密钥。</p><p>构建镜像</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker build --no-cache --progress<span class=o>=</span>plain --secret <span class=nv>id</span><span class=o>=</span>mysecret,src<span class=o>=</span>secrets.txt .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输出</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=c1>#4 [1/2] FROM docker.io/library/alpine</span>
</span></span><span class=line><span class=cl><span class=c1>#4 sha256:665ba8b2cdc0cb0200e2a42a6b3c0f8f684089f4cd1b81494fbb9805879120f7</span>
</span></span><span class=line><span class=cl><span class=c1>#4 缓存的</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#5 [2/2] RUN --mount=type=secret,id=mysecret cat /run/secrets/myecret</span>
</span></span><span class=line><span class=cl><span class=c1>#5 sha256:75601a522ebe80ada66dedd9dd86772ca932d30d7e1b11bba94c04aa55c237de</span>
</span></span><span class=line><span class=cl><span class=c1>#5 0.635 docker_is_awesome#5 DONE 0.7s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#6 导出到镜像</span>
</span></span></code></pre></div><p>最后，检查历史记录，看看密钥是否泄露了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>❯ docker <span class=nb>history</span> 49574a19241c
</span></span><span class=line><span class=cl>IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT
</span></span><span class=line><span class=cl>49574a19241c   <span class=m>5</span> minutes ago   CMD <span class=o>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=o>]</span>                                 0B        buildkit.dockerfile.v0
</span></span><span class=line><span class=cl>&lt;missing&gt;      <span class=m>5</span> minutes ago   RUN /bin/sh -c cat /run/secrets/mysecret <span class=c1># b…   0B        buildkit.dockerfile.v0</span>
</span></span><span class=line><span class=cl>&lt;missing&gt;      <span class=m>4</span> weeks ago     /bin/sh -c <span class=c1>#(nop)  CMD [&#34;/bin/sh&#34;]              0B</span>
</span></span><span class=line><span class=cl>&lt;missing&gt;      <span class=m>4</span> weeks ago     /bin/sh -c <span class=c1>#(nop) ADD file:aad4290d27580cc1a…   5.6MB</span>
</span></span></code></pre></div><h4 class="relative group">Docker 密钥<div id=docker-密钥 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#docker-%e5%af%86%e9%92%a5 aria-label=锚点>#</a></span></h4><p>如果你正在使用 Docker Swarm，你可以用 Docker secrets 来管理密钥。</p><p>例如，启动 Docker Swarm 模式。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker swarm init
</span></span></code></pre></div><p>创建一个 docker 密钥。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;supersecretpassword&#34;</span> <span class=p>|</span> docker secret create postgres_password -
</span></span><span class=line><span class=cl>qdqmbpizeef0lfhyttxqfbty0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker secret ls
</span></span><span class=line><span class=cl>ID                          NAME                DRIVER    CREATED         UPDATED
</span></span><span class=line><span class=cl>qdqmbpizeef0lfhyttxqfbty0   postgres_password             <span class=m>4</span> seconds ago   <span class=m>4</span> seconds ago
</span></span></code></pre></div><p>当一个容器被赋予上述密钥的访问权时，它将挂载在 <code>/run/secrets/postgres_password</code>。这个文件将包含明文的密钥的实际值。</p><p>使用其他的编排工具？</p><ul><li><a href=https://docs.aws.amazon.com/eks/latest/userguide/manage-secrets.html target=_blank>使用 AWS Secrets Manager 的密钥与 Kubernetes 的密钥</a></li><li>DigitalOcean Kubernetes - <a href=https://www.digitalocean.com/community/tutorials/recommended-steps-to-secure-a-digitalocean-kubernetes-cluster target=_blank>保护 DigitalOcean Kubernetes 集群的推荐步骤</a></li><li>Google Kubernetes引擎 - <a href=https://cloud.google.com/secret-manager/docs/using-other-products#google-kubernetes-engine target=_blank>与其他产品一起使用密钥管理器</a></li><li>Nomad - <a href="https://learn.hashicorp.com/tutorials/nomad/vault-postgres?in=nomad/integrate-vault" target=_blank>Vault 集成和检索动态密钥</a></li></ul><h3 class="relative group">3. 使用 .dockerignore 文件<div id=3-使用-dockerignore-文件 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#3-%e4%bd%bf%e7%94%a8-dockerignore-%e6%96%87%e4%bb%b6 aria-label=锚点>#</a></span></h3><p>之前已经提到过几次使用 <code>.dockerignore</code> 文件。这个文件用来指定你不希望被添加到发送给 Docker 守护进程的初始构建上下文中的文件和文件夹，后者将构建你的镜像。换句话说，你可以用它来定义你需要的构建环境。</p><p>当一个 Docker 镜像被构建时，整个 Docker 上下文 - 即你的项目的根在 <code>COPY</code> 或 <code>ADD</code> 命令执行之前就被发送给了 Docker 守护进程。</p><p>这可能是相当费资源，尤其是当你的项目中有许多依赖关系、大量的数据文件或构建工件时。</p><p>另外，当 Docker CLI 和守护程序不在同一台机器上。比如守护进程是在远程机器上执行的，你就更应该注意构建环境的大小了。</p><p>你应该在 <code>.dockerignore</code> 文件中添加什么？</p><ol><li>临时文件和文件夹</li><li>构建日志</li><li>本地 secrets</li><li>本地开发文件，如 <code>docker-compose.yml</code></li><li>版本控制文件夹，如 &ldquo;.git&rdquo;、".hg" 和 &ldquo;.vscode&rdquo; 等</li></ol><p>例子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>**/.git
</span></span><span class=line><span class=cl>**/.gitignore
</span></span><span class=line><span class=cl>**/.vscode
</span></span><span class=line><span class=cl>**/coverage
</span></span><span class=line><span class=cl>**/.env
</span></span><span class=line><span class=cl>**/.aws
</span></span><span class=line><span class=cl>**/.ssh
</span></span><span class=line><span class=cl>Dockerfile
</span></span><span class=line><span class=cl>README.md
</span></span><span class=line><span class=cl>docker-compose.yml
</span></span><span class=line><span class=cl>**/.DS_Store
</span></span><span class=line><span class=cl>**/venv
</span></span><span class=line><span class=cl>**/env
</span></span></code></pre></div><p>总之，结构合理的 .dockerignore 可以帮助</p><ol><li>减少 Docker 镜像的大小</li><li>加快构建过程</li><li>防止不必要的缓存失效</li><li>防止泄密</li></ol><h3 class="relative group">4. 检查并扫描你的 Dockerfile 和镜像<div id=4-检查并扫描你的-dockerfile-和镜像 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#4-%e6%a3%80%e6%9f%a5%e5%b9%b6%e6%89%ab%e6%8f%8f%e4%bd%a0%e7%9a%84-dockerfile-%e5%92%8c%e9%95%9c%e5%83%8f aria-label=锚点>#</a></span></h3><p>Linting 是检查源代码中是否存在可能导致潜在缺陷的编程和风格错误以及不良做法的过程。就像编程语言一样，静态文件也可以被 lint。特别是对于你的 Dockerfile，linter 可以帮助确保它们的可维护性、避免弃用语法并遵守最佳实践。整理镜像应该是 CI 管道的标准部分。</p><p><a href=https://github.com/hadolint/hadolint target=_blank>Hadolint</a> 是最流行的 Dockerfile linter：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hadolint Dockerfile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Dockerfile:1 DL3006 warning: Always tag the version of an image explicitly
</span></span><span class=line><span class=cl>Dockerfile:7 DL3042 warning: Avoid the use of cache directory with pip. Use <span class=sb>`</span>pip install --no-cache-dir &lt;package&gt;<span class=sb>`</span>
</span></span><span class=line><span class=cl>Dockerfile:9 DL3059 info: Multiple consecutive <span class=sb>`</span>RUN<span class=sb>`</span> instructions. Consider consolidation.
</span></span><span class=line><span class=cl>Dockerfile:17 DL3025 warning: Use arguments JSON notation <span class=k>for</span> CMD and ENTRYPOINT arguments
</span></span></code></pre></div><p>这是 Hadolint 一个在线的链接 <a href=https://hadolint.github.io/hadolint/ target=_blank>https://hadolint.github.io/hadolint/</a> 也可以安装 VS Code <a href="https://marketplace.visualstudio.com/items?itemName=exiasr.hadolint" target=_blank>插件</a></p><p>你可以将 Dockerfile 与扫描镜像和容器的漏洞结合使用。</p><p>以下是一些有影响力的镜像扫描工具：</p><ul><li><a href=https://docs.docker.com/engine/scan/ target=_blank>Snyk</a> 是 Docker 本地漏洞扫描的独家提供商。你可以使用 <code>docker scan</code> CLI 命令来扫描镜像。</li><li><a href=https://aquasecurity.github.io/trivy/ target=_blank>Trivy</a> 可用于扫描容器镜像、文件系统、git 存储库和其他配置文件。</li><li><a href=https://github.com/quay/clair target=_blank>Clair</a> 是一个开源项目，用于对应用程序容器中的漏洞进行静态分析。</li><li><a href=https://github.com/anchore/anchore-engine target=_blank>Anchore</a> 是一个开源项目，为容器镜像的检查、分析和认证提供集中式服务。</li></ul><p>总而言之，对你的 Dockerfile 和镜像进行 lint 和扫描，来发现任何偏离最佳实践的潜在问题。</p><h3 class="relative group">5. 签名和验证镜像<div id=5-签名和验证镜像 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#5-%e7%ad%be%e5%90%8d%e5%92%8c%e9%aa%8c%e8%af%81%e9%95%9c%e5%83%8f aria-label=锚点>#</a></span></h3><p>你怎么知道用于运行生产代码的镜像没有被篡改？</p><p>篡改可以通过中间人（MITM）攻击或注册表被完全破坏来实现。Docker 内容信任（DCT）可以对来自远程注册中心的 Docker 镜像进行签名和验证。</p><p>为了验证镜像的完整性和真实性，请设置以下环境变量。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>DOCKER_CONTENT_TRUST</span><span class=o>=</span><span class=m>1</span>
</span></span></code></pre></div><p>现在，如果你试图拉一个没有被签名的镜像，你会收到以下错误。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Error: remote trust data does not exist <span class=k>for</span> docker.io/namespace/unsigned-image:
</span></span><span class=line><span class=cl>notary.docker.io does not have trust data <span class=k>for</span> docker.io/namespace/unsigned-image
</span></span></code></pre></div><p>你可以从使用 Docker 内容信任签署镜像文档中了解签署镜像的情况。</p><p>当从 Docker Hub下 载镜像时，确保使用官方镜像或来自可信来源的经过验证的镜像。较大的团队应该使用他们自己的内部私有容器仓库</p><h3 class="relative group">6. 设置内存和 CPU 的限制<div id=6-设置内存和-cpu-的限制 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#6-%e8%ae%be%e7%bd%ae%e5%86%85%e5%ad%98%e5%92%8c-cpu-%e7%9a%84%e9%99%90%e5%88%b6 aria-label=锚点>#</a></span></h3><p>限制 Docker 容器的内存使用是一个好主意，特别是当你在一台机器上运行多个容器时。这可以防止任何一个容器使用所有可用的内存，从而削弱其他容器的功能。</p><p>限制内存使用的最简单方法是在 Docker cli 中使用 <code>--memory</code> 和 <code>--cpu</code> 选项。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --cpus<span class=o>=</span><span class=m>2</span> -m 512m nginx
</span></span></code></pre></div><p>上述命令将容器的使用限制在 2 个 CPU 和 512 兆的内存。</p><p>你可以在 Docker Compose 文件中做同样的事情，像这样。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.9&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpus</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512M</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>reservations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cpus</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256M</span><span class=w>
</span></span></span></code></pre></div><p>请注意 <code>reservations</code> 字段。它是用来设置软限制的，当主机的内存或CPU资源不足时，它就会优先考虑。</p><p>其他相关资源</p><ol><li>带有内存、CPU和GPU的运行时选项：https://docs.docker.com/config/containers/resource_constraints/</li><li>Docker Compose 的资源限制：https://docs.docker.com/compose/compose-file/compose-file-v3/#resources</li></ol><h2 class="relative group">总结<div id=总结 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#%e6%80%bb%e7%bb%93 aria-label=锚点>#</a></span></h2><p>以上就是本文介绍的 17 条最佳实践，掌握这些最佳实践一定会让你的 Dockerfile 和 Docker Image 变得精简，干净，和安全。</p><p>本文出自 <a href=https://testdriven.io/blog/docker-best-practices/ target=_blank>Docker Best Practices for Python Developers</a>。</p><hr><p>欢迎关注微信公众号「DevOps攻城狮」- 专注于DevOps领域知识分享。</p></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://shenxianpeng.github.io/posts/2022/docker-best-practice/&amp;title=%e4%bd%a0%e4%b8%80%e5%ae%9a%e8%a6%81%e4%ba%86%e8%a7%a3%e8%bf%99%2017%20%e6%9d%a1%20Docker%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%ef%bc%81" title="分享到 LinkedIn" aria-label="分享到 LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://shenxianpeng.github.io/posts/2022/docker-best-practice/&amp;text=%e4%bd%a0%e4%b8%80%e5%ae%9a%e8%a6%81%e4%ba%86%e8%a7%a3%e8%bf%99%2017%20%e6%9d%a1%20Docker%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%ef%bc%81" title="分享到 Twitter" aria-label="分享到 Twitter"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span>
</a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://bsky.app/intent/compose?text=%e4%bd%a0%e4%b8%80%e5%ae%9a%e8%a6%81%e4%ba%86%e8%a7%a3%e8%bf%99%2017%20%e6%9d%a1%20Docker%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%ef%bc%81+https://shenxianpeng.github.io/posts/2022/docker-best-practice/" title="发布到 Bluesky" aria-label="发布到 Bluesky"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span>
</a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://shenxianpeng.github.io/posts/2022/docker-best-practice/&amp;resubmit=true&amp;title=%e4%bd%a0%e4%b8%80%e5%ae%9a%e8%a6%81%e4%ba%86%e8%a7%a3%e8%bf%99%2017%20%e6%9d%a1%20Docker%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%ef%bc%81" title="提交到 Reddit" aria-label="提交到 Reddit"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://api.whatsapp.com/send?text=https://shenxianpeng.github.io/posts/2022/docker-best-practice/&amp;resubmit=true&amp;title=%e4%bd%a0%e4%b8%80%e5%ae%9a%e8%a6%81%e4%ba%86%e8%a7%a3%e8%bf%99%2017%20%e6%9d%a1%20Docker%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%ef%bc%81" title="通过 WhatsApp 分享" aria-label="通过 WhatsApp 分享"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4.0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3.0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2.0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2.0-101.7 82.8-184.5 184.6-184.5 49.3.0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5.0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8s-14.3 18-17.6 21.8c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3.0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://t.me/share/url?url=https://shenxianpeng.github.io/posts/2022/docker-best-practice/&amp;resubmit=true&amp;title=%e4%bd%a0%e4%b8%80%e5%ae%9a%e8%a6%81%e4%ba%86%e8%a7%a3%e8%bf%99%2017%20%e6%9d%a1%20Docker%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%ef%bc%81" title="通过 Telegram 分享" aria-label="通过 Telegram 分享"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://pinterest.com/pin/create/bookmarklet/?url=https://shenxianpeng.github.io/posts/2022/docker-best-practice/&amp;description=%e4%bd%a0%e4%b8%80%e5%ae%9a%e8%a6%81%e4%ba%86%e8%a7%a3%e8%bf%99%2017%20%e6%9d%a1%20Docker%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%ef%bc%81" title="钉到 Pinterest" aria-label="钉到 Pinterest"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M496 256c0 137-111 248-248 248-25.6.0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8.0 128.7-68.8 128.7-154.3.0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1.0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6.0-54.7 41.4-107.6 112-107.6 60.9.0 103.6 41.5 103.6 100.9.0 67.1-33.9 113.6-78 113.6-24.3.0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6.0-19-10.2-34.9-31.4-34.9-24.9.0-44.9 25.7-44.9 60.2.0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9.0 361.1.0 256 0 119 111 8 248 8s248 111 248 248z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://shenxianpeng.github.io/posts/2022/docker-best-practice/&amp;quote=%e4%bd%a0%e4%b8%80%e5%ae%9a%e8%a6%81%e4%ba%86%e8%a7%a3%e8%bf%99%2017%20%e6%9d%a1%20Docker%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%ef%bc%81" title="分享到 Facebook" aria-label="分享到 Facebook"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://shenxianpeng.github.io/posts/2022/docker-best-practice/&amp;subject=%e4%bd%a0%e4%b8%80%e5%ae%9a%e8%a6%81%e4%ba%86%e8%a7%a3%e8%bf%99%2017%20%e6%9d%a1%20Docker%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%ef%bc%81" title=通过电子邮件发送 aria-label=通过电子邮件发送><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://line.me/R/share?text=https://shenxianpeng.github.io/posts/2022/docker-best-practice/%20%e4%bd%a0%e4%b8%80%e5%ae%9a%e8%a6%81%e4%ba%86%e8%a7%a3%e8%bf%99%2017%20%e6%9d%a1%20Docker%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%ef%bc%81" title="分享到 LINE" aria-label="分享到 LINE"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M311 196.8v81.3c0 2.1-1.6 3.7-3.7 3.7h-13c-1.3.0-2.4-.7-3-1.5L254 230v48.2c0 2.1-1.6 3.7-3.7 3.7h-13c-2.1.0-3.7-1.6-3.7-3.7V196.9c0-2.1 1.6-3.7 3.7-3.7h12.9c1.1.0 2.4.6 3 1.6l37.3 50.3V196.9c0-2.1 1.6-3.7 3.7-3.7h13c2.1-.1 3.8 1.6 3.8 3.5zm-93.7-3.7h-13c-2.1.0-3.7 1.6-3.7 3.7v81.3c0 2.1 1.6 3.7 3.7 3.7h13c2.1.0 3.7-1.6 3.7-3.7V196.8c0-1.9-1.6-3.7-3.7-3.7zm-31.4 68.1H150.3V196.8c0-2.1-1.6-3.7-3.7-3.7h-13c-2.1.0-3.7 1.6-3.7 3.7v81.3c0 1 .3 1.8 1 2.5.7.6 1.5 1 2.5 1h52.2c2.1.0 3.7-1.6 3.7-3.7v-13c0-1.9-1.6-3.7-3.5-3.7zm193.7-68.1H327.3c-1.9.0-3.7 1.6-3.7 3.7v81.3c0 1.9 1.6 3.7 3.7 3.7h52.2c2.1.0 3.7-1.6 3.7-3.7V265c0-2.1-1.6-3.7-3.7-3.7H344V247.7h35.5c2.1.0 3.7-1.6 3.7-3.7V230.9c0-2.1-1.6-3.7-3.7-3.7H344V213.5h35.5c2.1.0 3.7-1.6 3.7-3.7v-13c-.1-1.9-1.7-3.7-3.7-3.7zM512 93.4v326c-.1 51.2-42.1 92.7-93.4 92.6H92.6C41.4 511.9-.1 469.8.0 418.6V92.6C.1 41.4 42.2-.1 93.4.0h326c51.2.1 92.7 42.1 92.6 93.4zM441.6 233.5c0-83.4-83.7-151.3-186.4-151.3S68.8 150.1 68.8 233.5c0 74.7 66.3 137.4 155.9 149.3 21.8 4.7 19.3 12.7 14.4 42.1-.8 4.7-3.8 18.4 16.1 10.1s107.3-63.2 146.5-108.2c27-29.7 39.9-59.8 39.9-93.1z"/></svg></span></a></section><h2 class="mt-8 text-2xl font-extrabold mb-10">相关文章</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><div class="group-hover-card group relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><a href=/posts/2019/docker-commands/ class="absolute inset-0" aria-label="Docker 常用命令"></a><div class="thumbnail_card_related nozoom w-full" style=background-image:url(/posts/2019/docker-commands/featured_hu_47ff0d861e89fdc4.png)></div><div class="px-6 py-4"><div class="group-hover-card-title decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 group-hover:underline group-hover:underline-offset-2">Docker 常用命令</div><div class="group-hover-cancel text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-12-02T00:00:00+00:00>2019-12-02</time><span class="px-2 text-primary-500">&#183;</span><span>235 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>1 分钟</span></div><div class="flex flex-row flex-wrap items-center"><a href=/authors/shenxianpeng/ class=relative>沈显鹏</a></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/docker/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Docker
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/devops/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">DevOps</span></span></a></div></div><div class="prose dark:prose-invert py-1">一个 Docker 常用命令小纸条，记录一些常用的 Docker 命令和操作，方便日常使用和参考。</div></div><div class="px-6 pt-4 pb-2"></div></div><div class="group-hover-card group relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><a href=/posts/2019/overview-of-docker-editions/ class="absolute inset-0" aria-label="Docker 版本概述"></a><div class="thumbnail_card_related nozoom w-full" style=background-image:url(/posts/2019/overview-of-docker-editions/featured_hu_47ff0d861e89fdc4.png)></div><div class="px-6 py-4"><div class="group-hover-card-title decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 group-hover:underline group-hover:underline-offset-2">Docker 版本概述</div><div class="group-hover-cancel text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-12-01T00:00:00+00:00>2019-12-01</time><span class="px-2 text-primary-500">&#183;</span><span>278 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>1 分钟</span></div><div class="flex flex-row flex-wrap items-center"><a href=/authors/shenxianpeng/ class=relative>沈显鹏</a></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/docker/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Docker</span></span></a></div></div><div class="prose dark:prose-invert py-1">概述 Docker 的不同版本，包括社区版、企业版和企业级解决方案，适用于不同规模和需求的用户。</div></div><div class="px-6 pt-4 pb-2"></div></div><div class="group-hover-card group relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><a href=/posts/2019/install-docker-jenkins/ class="absolute inset-0" aria-label="定制一个 Docker 版 Jenkins 镜像"></a><div class="thumbnail_card_related nozoom w-full" style=background-image:url(/posts/2019/install-docker-jenkins/featured_hu_47ff0d861e89fdc4.png)></div><div class="px-6 py-4"><div class="group-hover-card-title decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 group-hover:underline group-hover:underline-offset-2">定制一个 Docker 版 Jenkins 镜像</div><div class="group-hover-cancel text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2019-12-01T00:00:00+00:00>2019-12-01</time><span class="px-2 text-primary-500">&#183;</span><span>591 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>2 分钟</span></div><div class="flex flex-row flex-wrap items-center"><a href=/authors/shenxianpeng/ class=relative>沈显鹏</a></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/jenkins/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Jenkins
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/docker/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Docker</span></span></a></div></div><div class="prose dark:prose-invert py-1">如何定制一个 Docker 版 Jenkins 镜像，并将其备份到 Artifactory，便于在需要时快速恢复 Jenkins 环境。</div></div><div class="px-6 pt-4 pb-2"></div></div><div class="group-hover-card group relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><a href=/posts/2021/world-quality-report/ class="absolute inset-0" aria-label="2021-22 世界质量报告（World Quality Report）"></a><div class="thumbnail_card_related nozoom w-full" style=background-image:url(/posts/2021/world-quality-report/featured_hu_47ff0d861e89fdc4.png)></div><div class="px-6 py-4"><div class="group-hover-card-title decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 group-hover:underline group-hover:underline-offset-2">2021-22 世界质量报告（World Quality Report）</div><div class="group-hover-cancel text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2021-11-06T00:00:00+00:00>2021-11-06</time><span class="px-2 text-primary-500">&#183;</span><span>3169 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>7 分钟</span></div><div class="flex flex-row flex-wrap items-center"><a href=/authors/shenxianpeng/ class=relative>沈显鹏</a></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/report/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Report
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/quality/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Quality</span></span></a></div></div><div class="prose dark:prose-invert py-1">本文介绍了 2021-22 世界质量报告（WQR）的主要发现和趋势，强调了新冠疫情对软件质量和测试的影响，以及 QA 在敏捷和 DevOps 中的重要作用。</div></div><div class="px-6 pt-4 pb-2"></div></div><div class="group-hover-card group relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><a href=/posts/2021/how-to-fix-gcov-hidden-symbol/ class="absolute inset-0" aria-label='修复 "hidden symbol `__gcov_init&#39; in ../libgcov.a(_gcov.o) is referenced by DSO" 错误'></a><div class="thumbnail_card_related nozoom w-full" style=background-image:url(/posts/2021/how-to-fix-gcov-hidden-symbol/featured_hu_288e926b6d3a2693.png)></div><div class="px-6 py-4"><div class="group-hover-card-title decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 group-hover:underline group-hover:underline-offset-2">修复 "hidden symbol `__gcov_init' in ../libgcov.a(_gcov.o) is referenced by DSO" 错误</div><div class="group-hover-cancel text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2021-07-27T00:00:00+00:00>2021-07-27</time><span class="px-2 text-primary-500">&#183;</span><span>362 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>1 分钟</span></div><div class="flex flex-row flex-wrap items-center"><a href=/authors/shenxianpeng/ class=relative>沈显鹏</a></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/gcov/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Gcov
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/coverage/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Coverage
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/devops/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">DevOps</span></span></a></div></div><div class="prose dark:prose-invert py-1">本文介绍在使用 Gcov 编译项目进行代码覆盖率统计时，出现 &ldquo;hidden symbol `__gcov_init&rsquo;&mldr;&rdquo; 等错误的原因及解决方法，包括如何在构建时确保符号不被隐藏。</div></div><div class="px-6 pt-4 pb-2"></div></div><div class="group-hover-card group relative min-h-full min-w-full overflow-hidden rounded border border-2 border-neutral-200 shadow-2xl dark:border-neutral-700"><a href=/posts/2021/jenkins-timeout/ class="absolute inset-0" aria-label="Jenkins 作业超时后让构建失败的方法（已解决）"></a><div class="thumbnail_card_related nozoom w-full" style=background-image:url(/posts/2021/jenkins-timeout/featured_hu_d0c165d9b3a3a1ef.png)></div><div class="px-6 py-4"><div class="group-hover-card-title decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 group-hover:underline group-hover:underline-offset-2">Jenkins 作业超时后让构建失败的方法（已解决）</div><div class="group-hover-cancel text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2021-06-24T00:00:00+00:00>2021-06-24</time><span class="px-2 text-primary-500">&#183;</span><span>331 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>1 分钟</span></div><div class="flex flex-row flex-wrap items-center"><a href=/authors/shenxianpeng/ class=relative>沈显鹏</a></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/jenkins/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Jenkins</span></span></a></div></div><div class="prose dark:prose-invert py-1">本文介绍如何在 Jenkins 流水线中正确处理超时场景，通过 try 和 catch 结合 error 确保超时后作业会失败。</div></div><div class="px-6 pt-4 pb-2"></div></div></section></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_posts/2022/docker-best-practice/index.md data-oid-likes=likes_posts/2022/docker-best-practice/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/2021/choose-monitor/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">2022年序员如何选择显示器？1080p还是2K? 单屏还是多屏？</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2021-12-21T00:00:00+00:00>2021-12-21</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/2022/what-is-go/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">什么是 Go ？Go 的优势和现状。初学者应该学习 Python 还是 Go？</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2022-01-18T00:00:00+00:00>2022-01-18</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><div id=giscus-comments class=mt-8><script src=https://giscus.app/client.js data-repo=shenxianpeng/blog data-repo-id="MDEwOlJlcG9zaXRvcnkxMDkwODc5MTM=" data-category=Announcements data-category-id=DIC_kwDOBoCMqc4CVG-1 data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=en crossorigin=anonymous async></script></div><script>function setGiscusTheme(){function e(){return document.documentElement.classList.contains("dark")?"transparent_dark":"light"}function t(e){const t=document.querySelector('iframe[src*="giscus"]');t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}const n=e(),s=document.querySelector('script[src*="giscus"]');s&&s.setAttribute("data-theme",n);const o=new MutationObserver(function(n){n.forEach(function(n){if(n.type==="attributes"&&n.attributeName==="class"){const n=e();t(n)}})});o.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),setTimeout(()=>{t(n)},500),setTimeout(()=>{t(e())},1e3)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",setGiscusTheme):setGiscusTheme()</script><noscript><div class="mt-8 p-4 bg-neutral-100 dark:bg-neutral-800 rounded-lg"><p class="text-neutral-600 dark:text-neutral-400">Please enable JavaScript to view the comments powered by
<a href=https://giscus.app/ class="text-primary-600 hover:text-primary-500 dark:text-primary-400 dark:hover:text-primary-300">Giscus
</a>.</p></div></noscript></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0 z-10"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=返回顶部 title=返回顶部>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/tags/ title=标签>标签</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/authors/ title=Authors>作者</a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">Copyright © 2017–2025 Xianpeng Shen. All rights reserved.</p><p class="text-xs text-neutral-500 dark:text-neutral-400"><a class="hx:flex hx:text-sm hx:items-center hx:gap-1 hx:text-current" target=_blank rel="noopener noreferrer"></a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script><a rel=me href=https://masto.ai/@blowfish></a></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://shenxianpeng.github.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>